(()=>{var __create=Object.create;var __defProp=Object.defineProperty;var __getOwnPropDesc=Object.getOwnPropertyDescriptor;var __getOwnPropNames=Object.getOwnPropertyNames;var __getProtoOf=Object.getPrototypeOf,__hasOwnProp=Object.prototype.hasOwnProperty;var __commonJS=(cb,mod)=>function(){return mod||(0,cb[__getOwnPropNames(cb)[0]])((mod={exports:{}}).exports,mod),mod.exports};var __copyProps=(to,from,except,desc)=>{if(from&&typeof from=="object"||typeof from=="function")for(let key of __getOwnPropNames(from))!__hasOwnProp.call(to,key)&&key!==except&&__defProp(to,key,{get:()=>from[key],enumerable:!(desc=__getOwnPropDesc(from,key))||desc.enumerable});return to};var __toESM=(mod,isNodeMode,target)=>(target=mod!=null?__create(__getProtoOf(mod)):{},__copyProps(isNodeMode||!mod||!mod.__esModule?__defProp(target,"default",{value:mod,enumerable:!0}):target,mod));var require_lib_gltf=__commonJS({"../webGpu/libs/lib_gltf.js"(exports){var COMPONENT_TYPES,DATA_TYPES,extractAccessorData,gltf_Buffer,gltf_BufferView,gltf_Camera,gltf_Mesh,gltf_Node,gltf_Scene,gltf_Tex,load_binary_file,scene_from_data_type_GLTF,scene_from_file_type_GLTF2;gltf_Mesh=class{constructor(name,bufferView1){this.name=name,this.bufferView=bufferView1,this.data_verts_position=null,this.data_verts_normal=null,this.data_verts_texcoord=null,this.data_verts_color=null,this.data_indices=null,this.has_normal=!1,this.has_texcoord=!1,this.has_color=!1,this.vertex_count=0,this.index_count=0,this.min=null,this.max=null,this.texture=null}};gltf_Tex=class{constructor(){this.base_uri=null,this.uri=null,this.tex=null}};gltf_Camera=class{constructor(name,type,params1){this.name=name,this.type=type,this.params=params1,this.mat=null,this.build_mat4x4()}build_mat4x4(){if(this.type==="perspective")return this.mat=this.build_perspective(this.params.yfov,this.params.aspectRatio,this.params.znear,this.params.zfar);if(this.type==="orthographic")return this.mat=this.build_orthographic(this.params.xmag,this.params.ymag,this.params.znear,this.params.zfar)}build_perspective(yfov,aspectRatio,znear,zfar){var fovy_in_deg,m;return m=new Mat4x4,m.perspective(yfov,aspectRatio,znear,zfar,fovy_in_deg=!1),m}build_orthographic(xmag,ymag,znear,zfar){var bottom,left,m,right,top;return left=-xmag,right=xmag,bottom=-ymag,top=ymag,m=new Mat4x4,m.orthographic(left,right,bottom,top,znear,zfar),m}};gltf_Buffer=function(){var getData;class gltf_Buffer2{constructor(base_uri1,uri1,byteLength1){this.base_uri=base_uri1,this.uri=uri1,this.byteLength=byteLength1,this.data=null,this.loaded=!1}async load(){return this.loaded?this.data:(this.data=await load_binary_file(this.base_uri+this.uri),this.loaded=!0,this.data.byteLength!==this.byteLength&&console.warn(`Tamanho do buffer ${this.uri} n\xE3o confere: esperado ${this.byteLength}, obtido ${this.data.byteLength}`),this.data)}}return getData=function(){if(!this.buffer.loaded)throw new Error("Buffer precisa ser carregado primeiro usando buffer.load()");if(!this.buffer.data)throw new Error("Buffer n\xE3o cont\xE9m dados");return this.buffer.data.slice(this.byteOffset,this.byteOffset+this.byteLength)},gltf_Buffer2}.call(exports);COMPONENT_TYPES={5120:{name:"BYTE",size:1,arrayType:Int8Array},5121:{name:"UNSIGNED_BYTE",size:1,arrayType:Uint8Array},5122:{name:"SHORT",size:2,arrayType:Int16Array},5123:{name:"UNSIGNED_SHORT",size:2,arrayType:Uint16Array},5125:{name:"UNSIGNED_INT",size:4,arrayType:Uint32Array},5126:{name:"FLOAT",size:4,arrayType:Float32Array}};gltf_BufferView=class{constructor(buffer1,byteOffset1=0,byteLength1){this.buffer=buffer1,this.byteOffset=byteOffset1,this.byteLength=byteLength1,this.target=null,this.data=null}getData(){if(!this.buffer.loaded)throw new Error("Buffer precisa ser carregado primeiro usando buffer.load()");if(!this.buffer.data)throw new Error("Buffer n\xE3o cont\xE9m dados");return this.data!=null?this.data:(this.data=this.buffer.data.slice(this.byteOffset,this.byteOffset+this.byteLength),this.data)}getTypedArray(componentType,count,byteOffset=0){var arrayType,componentInfo,componentSize,dataView,i,k,offset,rawData,ref,result;if(rawData=this.getData(),componentInfo=COMPONENT_TYPES[componentType],componentInfo==null)throw new Error(`Tipo de componente n\xE3o suportado: ${componentType}`);for(dataView=new DataView(rawData,byteOffset),arrayType=componentInfo.arrayType,componentSize=componentInfo.size,result=new arrayType(count),i=k=0,ref=count-1;k<=ref;i=k+=1)switch(offset=i*componentSize,componentType){case 5120:result[i]=dataView.getInt8(offset);break;case 5121:result[i]=dataView.getUint8(offset);break;case 5122:result[i]=dataView.getInt16(offset,!0);break;case 5123:result[i]=dataView.getUint16(offset,!0);break;case 5125:result[i]=dataView.getUint32(offset,!0);break;case 5126:result[i]=dataView.getFloat32(offset,!0)}return result}};gltf_Node=class{constructor(name){this.name=name,this.translation=[0,0,0],this.rotation=[0,0,0,1],this.scale=[1,1,1],this.mat=null,this.children=[],this.mesh=null,this.camera=null}get_scale(){return vec(this.scale[0],this.scale[1],this.scale[2])}get_translate(){return vec(this.translation[0],this.translation[1],this.translation[2])}get_rotate_quaternion(){return new Quaternion(this.rotation[0],this.rotation[1],this.rotation[2],this.rotation[3])}build_mat4x4(){var Q,R,S,T;return S=new Mat4x4,S.scale(this.scale[0],this.scale[1],this.scale[2]),Q=this.get_rotate_quaternion(),R=Q.to_mat4x4(),this.rotation_axis_angle=Q.to_axis_angle(),T=new Mat4x4,T.translate(this.translation[0],this.translation[1],this.translation[2]),this.mat=mat_mul(T,R,S)}};gltf_Scene=class{constructor(context1,vertex_format=null){this.context=context1,this.nodes=[],this.buffers=[],this.meshes=[],this.cameras=[],this.textures=[],this.vertex_format=vertex_format,this.vertex_format==null&&(this.vertex_format=this.context.last_vertex_format),this.tex_list=[],this.cam_list=[],this.obj_list=[],this.obj_list_material_tex=[],this.obj_list_material_color=[]}_add_node(node){return this.nodes.push(node)}_add_buffer(buffer){return this.buffers.push(buffer)}async _load_buffers_from_files(){var buffer,error,k,len,loadPromises,ref;for(loadPromises=[],ref=this.buffers,k=0,len=ref.length;k<len;k++)buffer=ref[k],buffer.loaded||loadPromises.push(buffer.load());try{return await Promise.all(loadPromises)}catch(error1){throw error=error1,console.error("Erro ao carregar buffers"),error}}async _load_tex_list(){var i,k,len,ref,results,t,tex,uri;for(this.tex_list=[],ref=this.textures,results=[],i=k=0,len=ref.length;k<len;i=++k)t=ref[i],uri=t.base_uri+t.uri,tex=await this.context.tex_from_file(uri),results.push(this.tex_list.push(tex));return results}_build_obj_list(){var a,b,campo,color_comps,floats,g,k,l,len,len1,m,n,node,normal_comps,nx,ny,nz,pos_comps,r,ref,ref1,ref2,results,texcoord_comps,u,v2,vk,x,y,z;for(this.obj_list=[],this.obj_list_material_color=[],this.obj_list_material_tex=[],ref=this.nodes,results=[],k=0,len=ref.length;k<len;k++)if(node=ref[k],m=node.mesh,m!=null&&(floats=[],m.vertex_count!==0)){for(pos_comps=m.data_verts_position[0].length,color_comps=m.has_color?m.data_verts_color[0].length:0,texcoord_comps=m.has_texcoord?m.data_verts_texcoord[0].length:0,normal_comps=m.has_normal?m.data_verts_normal[0].length:0,vk=l=0,ref1=m.vertex_count;l<ref1;vk=l+=1)for(pos_comps===2?([x,y]=m.data_verts_position[vk],z=0):[x,y,z]=m.data_verts_position[vk],color_comps===0?r=g=b=a=1:color_comps===3?([r,g,b]=m.data_verts_color[vk],a=1):[r,g,b,a]=m.data_verts_color[vk],texcoord_comps===0?u=v2=0:[u,v2]=m.data_verts_texcoord[vk],normal_comps===0?nx=ny=nz=0:[nx,ny,nz]=m.data_verts_normal[vk],ref2=this.vertex_format.campos,n=0,len1=ref2.length;n<len1;n++)campo=ref2[n],campo==="xy"?floats.push(x,y):campo==="xyz"?floats.push(x,y,z):campo==="rgb"?floats.push(r,g,b):campo==="rgba"?floats.push(r,g,b,a):campo==="uv"?floats.push(u,v2):campo==="normal"&&floats.push(nx,ny,nz);m.obj=this.context.obj_from_data(floats,m.data_indices),this.obj_list.push(m.obj),m.has_texcoord&&m.texture!=null?results.push(this.obj_list_material_tex.push(m.obj)):results.push(this.obj_list_material_color.push(m.obj))}return results}_build_camera_list(){var Q,bottom,cam,center,eye,forward,k,left,len,node,params,ref,results,right,top,up;for(this.cam_list=[],ref=this.nodes,results=[],k=0,len=ref.length;k<len;k++)node=ref[k],node.camera!=null&&(cam=c.camera(),params=node.camera.params,Q=node.get_rotate_quaternion(),eye=node.get_translate(),forward=Q.rotate_vec(vec(0,0,-1)),center=eye.add(forward),up=Q.rotate_vec(vec(0,1,0)),cam.look_at(eye,center,up),node.camera.type==="perspective"?cam.perspective(params.yfov,params.aspectRatio,params.znear,params.zfar):node.camera.type==="orthographic"&&(left=-params.xmag,right=params.xmag,bottom=-params.ymag,top=params.ymag,cam.orthographic(left,right,bottom,top,params.znear,params.zfar)),cam.node=node,results.push(this.cam_list.push(cam)));return results}get_tex(i){if(i<0||i>=this.tex_list.length)throw new Error(`get_tex: \xEDndice ${i} inv\xE1lido; total = ${this.tex_list.length}`);return this.tex_list[i]}get_tex_count(){return this.tex_list.length}get_camera(i){if(i<0||i>=this.cam_list.length)throw new Error(`get_camera: \xEDndice ${i} inv\xE1lido; total = ${this.cam_list.length}`);return this.cam_list[i]}get_camera_count(){return this.cam_list.length}get_obj_list_of_material(material_type){if(material_type==="tex")return this.obj_list_material_tex;if(material_type==="color")return this.obj_list_material_color;throw new Error("get_obj_list_of_material: tipo inv\xE1lido - deve ser 'tex' ou 'color'")}};load_binary_file=async function(url){var arrayBuffer,error,response;try{if(response=await fetch(url),!response.ok)throw new Error(`HTTP status: ${response.status}`);return arrayBuffer=await response.arrayBuffer(),arrayBuffer}catch(error1){throw error=error1,console.error(`Erro ao carregar arquivo: '${url}' - `,error),error}};scene_from_file_type_GLTF2=async function(context,uri,vertex_format=null){var base_uri,response,scene,text;if(response=await fetch(uri),!response.ok)throw new Error(`HTTP status: ${response.status}`);return text=await response.text(),base_uri=uri.substring(0,uri.lastIndexOf("/")+1),scene=await scene_from_data_type_GLTF(context,text,base_uri,vertex_format),scene};scene_from_data_type_GLTF=async function(context,text,base_uri="",vertex_format=null){var attrs,buffer,bufferData,bufferIndex,bufferView,bufferViewData,bufferViews,buffers,byteLength,byteOffset,camera,cameraData,cameras,childIndex,colorAccessor,gltf,i,i1,image,j1,k,k1,l,l1,len,len1,len10,len11,len2,len3,len4,len5,len6,len7,len8,len9,material,mesh,meshData,meshes,n,node,nodeData,nodeIndex,nodes,o,p,posAccessor,primaryBufferView,primitive,q,ref,ref1,ref10,ref11,ref2,ref3,ref4,ref5,ref6,ref7,ref8,ref9,s,scene,sceneData,tex,texture,textureIndex,textures,w;for(gltf=JSON.parse(text),buffers=[],ref=gltf.buffers||[],i=k=0,len=ref.length;k<len;i=++k)bufferData=ref[i],buffer=new gltf_Buffer(base_uri,bufferData.uri,bufferData.byteLength),buffers.push(buffer);for(bufferViews=[],ref1=gltf.bufferViews||[],i=l=0,len1=ref1.length;l<len1;i=++l)bufferViewData=ref1[i],bufferIndex=bufferViewData.buffer,byteOffset=bufferViewData.byteOffset||0,byteLength=bufferViewData.byteLength,bufferView=new gltf_BufferView(buffers[bufferIndex],byteOffset,byteLength),bufferViewData.target!=null&&(bufferView.target=bufferViewData.target),bufferViews.push(bufferView);for(scene=new gltf_Scene(context,vertex_format),n=0,len2=buffers.length;n<len2;n++)buffer=buffers[n],scene._add_buffer(buffer);for(await scene._load_buffers_from_files(),textures=[],ref2=gltf.textures||[],i=o=0,len3=ref2.length;o<len3;i=++o)texture=ref2[i],tex=new gltf_Tex,textures.push(tex),texture.source!=null&&(image=gltf.images[texture.source],image?.uri!=null&&(tex.base_uri=base_uri,tex.uri=image.uri));for(meshes=[],ref3=gltf.meshes||[],i=p=0,len4=ref3.length;p<len4;i=++p)for(meshData=ref3[i],ref4=meshData.primitives||[],q=0,len5=ref4.length;q<len5;q++)primitive=ref4[q],primaryBufferView=null,attrs=primitive.attributes,attrs.POSITION!=null&&(posAccessor=gltf.accessors[attrs.POSITION],primaryBufferView=bufferViews[posAccessor.bufferView]),mesh=new gltf_Mesh(meshData.name||`mesh_${i}`,primaryBufferView),attrs.POSITION!=null&&(mesh.data_verts_position=extractAccessorData(gltf,attrs.POSITION,5126,"VEC3",buffers,bufferViews),posAccessor=gltf.accessors[attrs.POSITION],mesh.min=posAccessor.min,mesh.max=posAccessor.max),attrs.NORMAL!=null&&(mesh.data_verts_normal=extractAccessorData(gltf,attrs.NORMAL,5126,"VEC3",buffers,bufferViews),mesh.has_normal=!0),attrs.TEXCOORD_0!=null&&(mesh.data_verts_texcoord=extractAccessorData(gltf,attrs.TEXCOORD_0,5126,"VEC2",buffers,bufferViews),mesh.has_texcoord=!0),attrs.COLOR_0!=null&&(colorAccessor=gltf.accessors[attrs.COLOR_0],((ref5=colorAccessor.type)==="VEC3"||ref5==="VEC4")&&colorAccessor.componentType===5126&&(mesh.data_verts_color=extractAccessorData(gltf,attrs.COLOR_0,5126,colorAccessor.type,buffers,bufferViews),mesh.has_color=!0)),primitive.indices!=null&&(mesh.data_indices=extractAccessorData(gltf,primitive.indices,5123,"SCALAR",buffers,bufferViews)),mesh.vertex_count=mesh.data_verts_position.length,mesh.index_count=mesh.data_indices.length,primitive.material!=null&&(material=gltf.materials[primitive.material],(material!=null&&(ref6=material.pbrMetallicRoughness)!=null?ref6.baseColorTexture:void 0)!=null&&(textureIndex=material.pbrMetallicRoughness.baseColorTexture.index,mesh.texture=textures[textureIndex])),meshes.push(mesh);for(cameras=[],ref7=gltf.cameras||[],i=s=0,len6=ref7.length;s<len6;i=++s)cameraData=ref7[i],camera=new gltf_Camera(cameraData.name||`camera_${i}`,cameraData.type,cameraData[cameraData.type]),cameras.push(camera);for(nodes=[],ref8=gltf.nodes||[],i=w=0,len7=ref8.length;w<len7;i=++w)nodeData=ref8[i],node=new gltf_Node(nodeData.name||`node_${i}`),nodeData.translation!=null&&(node.translation=nodeData.translation),nodeData.rotation!=null&&(node.rotation=nodeData.rotation),nodeData.scale!=null&&(node.scale=nodeData.scale),node.build_mat4x4(),nodeData.mesh!=null&&(node.mesh=meshes[nodeData.mesh]),nodeData.camera!=null&&(node.camera=cameras[nodeData.camera],node.mat_proj=node.camera.mat,node.mat_view=node.mat),nodes.push(node);for(ref9=gltf.nodes||[],i=i1=0,len8=ref9.length;i1<len8;i=++i1)if(nodeData=ref9[i],nodeData.children!=null)for(ref10=nodeData.children,j1=0,len9=ref10.length;j1<len9;j1++)childIndex=ref10[j1],nodes[i].children.push(nodes[childIndex]);if(gltf.scene!=null)for(sceneData=gltf.scenes[gltf.scene],ref11=sceneData.nodes||[],k1=0,len10=ref11.length;k1<len10;k1++)nodeIndex=ref11[k1],scene._add_node(nodes[nodeIndex]);else if(nodes.length>0)for(l1=0,len11=nodes.length;l1<len11;l1++)node=nodes[l1],scene._add_node(node);return scene.meshes=meshes,scene.cameras=cameras,scene.textures=textures,await scene._load_tex_list(),scene._build_obj_list(),scene._build_camera_list(),scene};DATA_TYPES={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16};extractAccessorData=function(gltf,accessorIndex,expectedComponentType,expectedType,buffers,bufferViews){var accessor,bufferView,byteOffset,componentInfo,dataTypeSize,i,j,k,l,ref,ref1,result,totalComponents,typedArray,vector,vectorArray;if(accessor=gltf.accessors[accessorIndex],!(accessor.componentType===expectedComponentType&&accessor.type===expectedType))return console.warn(`Formato inesperado para accessor ${accessorIndex}: esperado ${expectedComponentType}/${expectedType}, obtido ${accessor.componentType}/${accessor.type}`),null;if(componentInfo=COMPONENT_TYPES[accessor.componentType],componentInfo==null)return console.error(`Tipo de componente n\xE3o suportado: ${accessor.componentType}`),null;if(dataTypeSize=DATA_TYPES[accessor.type],dataTypeSize==null)return console.error(`Tipo de dados n\xE3o suportado: ${accessor.type}`),null;if(bufferView=bufferViews[accessor.bufferView],bufferView==null)return console.error(`BufferView n\xE3o encontrado: ${accessor.bufferView}`),null;if(byteOffset=accessor.byteOffset||0,totalComponents=accessor.count*dataTypeSize,typedArray=bufferView.getTypedArray(accessor.componentType,totalComponents,byteOffset),result=Array.from(typedArray),accessor.type!=="SCALAR"&&dataTypeSize>1){for(vectorArray=[],i=k=0,ref=accessor.count;k<ref;i=k+=1){for(vector=[],j=l=0,ref1=dataTypeSize;l<ref1;j=l+=1)vector.push(result[i*dataTypeSize+j]);vectorArray.push(vector)}return vectorArray}return result};globalThis.scene_from_file_type_GLTF=scene_from_file_type_GLTF2;globalThis.scene_from_data_type_GLTF=scene_from_data_type_GLTF}});var wgpuContext,wgpu_context_new,wgpu_version;wgpuContext=class{constructor(options1){var ctx_opts,default_frame_buffer_format;this.tex_from_file=this.tex_from_file.bind(this),this.tex_from_image=this.tex_from_image.bind(this),this.tex_from_data=this.tex_from_data.bind(this),this.tex_from_color=this.tex_from_color.bind(this),this.tex_array_from_files=this.tex_array_from_files.bind(this),this.tex_array_from_sheet_file=this.tex_array_from_sheet_file.bind(this),this.animation_repeat=this.animation_repeat.bind(this),this.options=options1,this.adapter=null,this.device=null,this.context=null,this.options||(this.options={}),this.frame_buffer=null,this.last_vertex_format=null,this.last_instance_list=null,this.uniform_buffer_size_per_item=0,this.canvas=null,this.canvas_format=null,this.options.canvas!=null?(this.comp_only=!1,typeof this.options.canvas=="string"?this.canvas=document.getElementById(this.options.canvas):this.canvas=this.options.canvas,this.options.transparent&&(this.canvas.style.backgroundColor="transparent"),ctx_opts={colorSpace:"display-p3"},this.context=this.canvas.getContext("webgpu",ctx_opts),this.frame_buffer=new wgpuRenderTarget(this,!0),default_frame_buffer_format=new wgpuRenderTargetFormat("color"),this.frame_buffer.format(default_frame_buffer_format)):this.comp_only=!0}frame_buffer_format(...attachments){var f;if(f=new wgpuRenderTargetFormat(...attachments),this.frame_buffer.format(f),this.options.debug)return console.log("Frame Buffer - formato:"),console.log(f)}render_target(w,h,...attachments){var f,rt;return f=new wgpuRenderTargetFormat(...attachments),rt=new wgpuRenderTarget(this),rt.format(f),rt.size(w,h),rt}vertex_format(...campos){var vf;return vf=new wgpuVertexFormat(...campos),this.last_vertex_format=vf,this.options.debug&&console.log(`Vertex Format: '${vf.desc}', ${vf.vertex_size} bytes por v\xE9rtice, ${vf.floats} floats por v\xE9rtice`),vf}obj(){return new wgpuObject(this)}obj_from_data(verts,indices=null,vertex_format=null){var t;return vertex_format==null&&(vertex_format=this.last_vertex_format),t=this.obj(),t.begin(vertex_format),t.verts(verts),indices!=null&&t.indices(indices),t.end(),t}obj_from_file(url,vertex_format=null){var ext;switch(vertex_format==null&&(vertex_format=this.last_vertex_format),ext=url.split(".").pop().toLowerCase(),ext){case"txt2":return wgpu_obj_from_file_type_TXT2(this,url,vertex_format);case"obj":return wgpu_obj_from_file_type_OBJ(this,url,vertex_format);case"ply":return wgpu_obj_from_file_type_PLY(this,url,vertex_format);default:throw new Error(`Formato de arquivo n\xE3o suportado: .${ext}`)}}obj_from_text(text,tipo,vertex_format=null){switch(vertex_format==null&&(vertex_format=this.last_vertex_format),tipo){case"txt2":return wgpu_obj_from_text_type_TXT2(this,text,vertex_format);case"obj":return wgpu_obj_from_text_type_OBJ(this,text,vertex_format);case"ply":return wgpu_obj_from_text_type_PLY(this,text,vertex_format);default:throw new Error(`Formato de texto n\xE3o suportado: ${tipo}`)}}uniform(){return new wgpuUniform(this,!1)}uniform_list(n){return new wgpuUniform(this,!0,n)}storage(){return new wgpuStorage(this,"struct")}storage_from_float_array(num_array){return new wgpuStorage(this,"float",num_array)}storage_from_int_array(num_array){return new wgpuStorage(this,"int",num_array)}storage_from_float_array_n(n,default_value=0){var float_array;return float_array=Array(n).fill(default_value),new wgpuStorage(this,"float",float_array)}storage_from_obj(obj,attribs,use_indices=!0){var vdata;return vdata=obj.to_float_array(attribs,use_indices),new wgpuStorage(this,"float",vdata)}storage_from_objs(objs,attribs,use_indices=!0){var j,len,obj,vdata;for(vdata=[],j=0,len=objs.length;j<len;j++)obj=objs[j],vdata=vdata.concat(obj.to_float_array(attribs,use_indices));return new wgpuStorage(this,"float",vdata)}storage_dup(s){return new wgpuStorage(this,"float",s.get_array())}async tex_from_file(url){var img,label,t;return img=await image_bitmap_from_url(url),label=`Textura '${url}'`,t=this.tex_from_image(img,label),t.filename=t.url=url,this.options.debug&&(console.log(`Textura - tex_from_file: ${url} carregado ok, formato ${t.format}, ${t.w} x ${t.h} pixels, ${Math.round(t.byte_size/1024)} KB (${t.byte_size} bytes)`),console.log(t)),t}tex_from_image(img,label=null){var j,len,level,mipmap,mipmaps,t,usage;if(t=new wgpuTex(this),usage=GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_SRC|GPUTextureUsage.COPY_DST|GPUTextureUsage.RENDER_ATTACHMENT,t._gpu_create_tex("bgra8unorm",img.width,img.height,usage,label),t.build_mipmaps)for(mipmaps=mipmap_array_from_image(img),level=j=0,len=mipmaps.length;j<len;level=++j)mipmap=mipmaps[level],t._gpu_tex_from_external_image(mipmap,mipmap.width,mipmap.height,level);else t._gpu_tex_from_external_image(img,img.width,img.height);return t}tex_from_data(w,h,rgba_bytes){var t,usage;return t=new wgpuTex(this),usage=GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_SRC|GPUTextureUsage.COPY_DST|GPUTextureUsage.RENDER_ATTACHMENT,t._gpu_create_tex("rgba8unorm",w,h,usage),rgba_bytes instanceof Uint8Array||(rgba_bytes=new Uint8Array(rgba_bytes)),t.cpu_pixels=rgba_bytes,t.gpu_send(),t}tex_from_color(w,h,r,g,b,a){var data,j,k,l,ref,ref1,x,y;for(data=new Uint8Array(w*h*4),y=j=0,ref=h;j<=ref;y=j+=1)for(x=l=0,ref1=w;l<=ref1;x=l+=1)k=(y*w+x)*4,data[k+0]=r,data[k+1]=g,data[k+2]=b,data[k+3]=a;return tex_from_data(w,h,data)}async tex_array_from_files(urls){var N,h0,i,img,imgs,j,l,label,len,len1,len2,level,m,mipmap,mipmaps,t,url,usage,w0;for(t=new wgpuTex(this),imgs=[],j=0,len=urls.length;j<len;j++){if(url=urls[j],img=await image_from_url(url),imgs.length>0&&(w0=imgs[0].width,h0=imgs[0].height,img.width!==w0||img.height!==h0))throw new Error(`O tex-array deve ter imagens do mesmo tamanho; esperado tamanho ${w0}x${h0}`);imgs.push(img)}for(usage=GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_SRC|GPUTextureUsage.COPY_DST|GPUTextureUsage.RENDER_ATTACHMENT,N=imgs.length,label=`Tex-Array '${urls[0]}' x${N}`,t.filename=urls[0],t.filenames=urls,t._gpu_create_tex("bgra8unorm",img.width,img.height,usage,label,N),i=l=0,len1=imgs.length;l<len1;i=++l)if(img=imgs[i],t.build_mipmaps)for(mipmaps=mipmap_array_from_image(img),level=m=0,len2=mipmaps.length;m<len2;level=++m)mipmap=mipmaps[level],t._gpu_tex_from_external_image(mipmap,mipmap.width,mipmap.height,level,i);else t._gpu_tex_from_external_image(img,img.width,img.height,0,i);return this.options.debug&&(console.log(`Textura - tex_array_from_files: ${urls[0]}.. ${N} carregados ok, formato ${t.format}, ${t.w} x ${t.h} pixels)`),console.log(t)),t}async tex_array_from_sheet_file(url,tile_w,tile_h,padding=0,tile_count=null){var N,i,img,imgs,j,l,label,len,len1,level,mipmap,mipmaps,t,usage;for(t=new wgpuTex(this),imgs=await images_from_url_sheet(url,tile_w,tile_h,padding,tile_count),usage=GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_SRC|GPUTextureUsage.COPY_DST|GPUTextureUsage.RENDER_ATTACHMENT,N=imgs.length,label=`Tex-Array '${url}' x${N}`,t.filename=url,t._gpu_create_tex("bgra8unorm",tile_w,tile_h,usage,label,N),i=j=0,len=imgs.length;j<len;i=++j)if(img=imgs[i],t.build_mipmaps)for(mipmaps=mipmap_array_from_image(img),level=l=0,len1=mipmaps.length;l<len1;level=++l)mipmap=mipmaps[level],t._gpu_tex_from_external_image(mipmap,mipmap.width,mipmap.height,level,i);else t._gpu_tex_from_external_image(img,img.width,img.height,0,i);return this.options.debug&&(console.log(`Textura - tex_array_from_sheet_file: ${url} -> ${N} carregados ok, formato ${t.format}, ${t.w} x ${t.h} pixels)`),console.log(t)),t}tex_sampler(filtro,repeat_mode="clamp-to-edge"){return new wgpuTexSampler(this,filtro,repeat_mode)}camera(){return new wgpuCamera(this)}instance_list(){var ls;return ls=new wgpuInstanceList(this),this.last_instance_list=ls,ls}resources(){return new wgpuResources(this)}resources_from_files(...urls){var res;return res=new wgpuResources(this),res.add_from_files(...urls),res}shader_data_group(){var g;return g=new wgpuBindingGroup_Data_Group(this),g}shader_data_group_with_uniform(uniform_index=0){var g;return g=new wgpuBindingGroup_Data_Group(this),g.binding(uniform_index).uniform(),g}shader_data_group_with_uniform_list(n,uniform_list_index=0){var g;return g=new wgpuBindingGroup_Data_Group(this),g.binding(uniform_list_index).uniform_list(n),g}pipeline(){return new wgpuPipeline(this)}comp_pipeline(){return new wgpuCompPipeline(this)}job(frame_buffer_format=null){return frame_buffer_format==null&&(frame_buffer_format=this.last_frame_buffer_format),new wgpuJob(this,frame_buffer_format)}async scene_from_file(url){return await scene_from_file_type_GLTF(this,url)}particle_system(use_instance_list=null){return use_instance_list==null&&(use_instance_list=this.last_instance_list),new wgpuParticleSystem(use_instance_list)}use_mat2x2_format(){return new Mat2x2_format}use_mat3x3_format(){return new Mat3x3_format}use_mat4x4_format(){return new Mat4x4_format}gpu_send_all(lista){var j,len,obj,results;for(results=[],j=0,len=lista.length;j<len;j++)obj=lista[j],results.push(obj.gpu_send());return results}async gpu_finish(){return await this.device.queue.onSubmittedWorkDone()}animation_repeat(render_func,tempo=null){return tempo===null?requestAnimationFrame(render_func):setTimeout(function(){return requestAnimationFrame(render_func)},tempo)}};wgpu_context_new=async options=>{var battery,c2,info,requiredFeatures,requiredLimits,transp;if(c2=new wgpuContext(options),navigator.gpu==null)throw new Error("Sem suporte: navigator.gpu inv\xE1lido. Talvez voc\xEA precise configurar o seu browser ou usar outro.");if(c2.adapter=await navigator.gpu.requestAdapter(),c2.adapter==null)throw new Error("Sem suporte: navigator.gpu.requestAdapter() deu nulo");return requiredFeatures=[],requiredFeatures.push("timestamp-query"),requiredFeatures.push("indirect-first-instance"),requiredLimits={},c2.device=await c2.adapter.requestDevice({requiredFeatures,requiredLimits}),c2.comp_only||(c2.canvas_format=navigator.gpu.getPreferredCanvasFormat(),c2.context.configure({device:c2.device,format:c2.canvas_format,alphaMode:c2.options.transparent?"premultiplied":"opaque",usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.COPY_SRC})),c2.uniform_buffer_size_per_item=c2.device.limits.minUniformBufferOffsetAlignment,c2.options.debug&&(info=c2.device.adapterInfo,console.log("Inicializa\xE7\xE3o - wgpu_context_new:"),info!=null?console.log(`- backend '${info.backend}', vendor '${info.vendor}', type '${info.type}', driver '${info.driver}'`):console.log("- sem informa\xE7\xF5es de adapterInfo"),c2.comp_only?console.log("- sem canvas (uso apenas para Compute Shader)"):(transp=c2.options.transparent!=null?c2.options.transparent:!1,console.log(`- canvas format (preferencial): ${c2.canvas_format}, transparente: ${transp}`)),console.log("Informa\xE7\xF5es extras:"),console.log(`- CPU: n\xFAcleos l\xF3gicos: ${navigator.hardwareConcurrency||"Indispon\xEDvel"}`),navigator.getBattery!=null?(battery=await navigator.getBattery(),console.log(`- Bateria: n\xEDvel: ${battery.level*100}%`),console.log(`- Bateria: carregando: ${battery.charging}`)):console.log("- Bateria: sem informa\xE7\xF5es do Browser"),console.log(`- User Agent: ${navigator.userAgent}`)),c2};wgpu_version=function(){return"Vers\xE3o 0.97"};globalThis.wgpu_context_new=wgpu_context_new;globalThis.wgpu_version=wgpu_version;var wgpuObject2;wgpuObject2=class{constructor(context){this.context=context,this.reset(),this._label=""}reset(){return this.data_verts=[],this.data_indices=[],this.vertex_count=0,this.index_count=0,this.use_index=!1,this.vbuf=null,this.ibuf=null,this.vbuf_size=0,this.ibuf_size=0,this.vbuf_size_last=0,this.ibuf_size_last=0}label(s){return this._label=s}begin(vertex_format=null){if(this.reset(),this.vertex_format=vertex_format,vertex_format==null&&(this.vertex_format=this.context.last_vertex_format),this.vertex_format===null)throw new Error("Esperado vertex_format")}vert(...campos){if(this.vertex_format.floats!==campos.length)throw new Error(`Esperado ${this.vertex_format.floats} floats`);return this.data_verts=this.data_verts.concat(campos)}vertex(...campos){return this.vert(...campos)}verts(float_array){var n_data,n_floats,resto;if(n_data=float_array.length,n_floats=this.vertex_format.floats,resto=n_data%n_floats,resto>0)throw new Error(`Foram passados ${n_data} floats, mas cada v\xE9rtice deve ter ${n_floats} floats, sobrando ${resto} floats`);return this.data_verts=this.data_verts.concat(float_array)}indices(int_array){return this.data_indices=this.data_indices.concat(int_array)}end(){return this.data_verts=new Float32Array(this.data_verts),this.data_indices=new Uint32Array(this.data_indices),this.vertex_size=this.vertex_format.vertex_size,this.vbuf_size=this.data_verts.byteLength,this.ibuf_size=this.data_indices.byteLength,this.vertex_count=this.vbuf_size/this.vertex_size,this.data_indices.length>0&&(this.use_index=!0,this.index_count=this.data_indices.length),this.context.options.debug&&(console.log(`Objeto formado: vertex_format = '${this.vertex_format.desc}', ${this.vertex_count} verts, ${this.vbuf_size} bytes, use_index = ${this.use_index}`),console.log(this)),this.gpu_send()}gpu_send(){if(this.data_verts.length>0&&(this.vbuf!=null&&this.vbuf_size!==this.vbuf_size_last&&(this.vbuf.destroy(),this.vbuf=null),this.vbuf==null&&(this.vbuf=this.context.device.createBuffer({size:this.data_verts.byteLength,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST}),this.vbuf_size_last=this.vbuf_size),this.context.device.queue.writeBuffer(this.vbuf,0,this.data_verts)),this.data_indices.length>0)return this.ibuf!=null&&this.ibuf_size!==this.ibuf_size_last&&(this.ibuf.destroy(),this.ibuf=null),this.ibuf==null&&(this.ibuf=this.context.device.createBuffer({size:this.data_indices.byteLength,usage:GPUBufferUsage.INDEX|GPUBufferUsage.COPY_DST}),this.ibuf_size_last=this.ibuf_size),this.context.device.queue.writeBuffer(this.ibuf,0,this.data_indices)}_get_vert_attrib(i,attr_name){var info,k,w,x,y,z;if(info=this.vertex_format.attributes_by_name[attr_name],!info)throw new Error(`Formato de v\xE9rtice sem atributo: ${attr_name}`);if(k=(i*this.vertex_size+info.offset)/4,x=y=z=0,w=1,info.floats>=2)x=this.data_verts[k],y=this.data_verts[k+1];else throw new Error(`Esperado atributo ${attr_name} com >=2 floats`);return info.floats>=3&&(z=this.data_verts[k+2],info.floats>=4&&(w=this.data_verts[k+3])),info.floats===2?[x,y]:info.floats===3?[x,y,z]:[x,y,z,w]}_set_vert_attrib(i,attr_name,x,y,z,w){var info,k;if(info=this.vertex_format.attributes_by_name[attr_name],!info)throw new Error(`Formato de v\xE9rtice sem atributo: ${attr_name}`);if(k=(i*this.vertex_size+info.offset)/4,info.floats>=2){if(this.data_verts[k]=x,this.data_verts[k+1]=y,info.floats>=3&&(this.data_verts[k+2]=z,info.floats>=4))return this.data_verts[k+3]=w}else throw new Error(`Esperado atributo ${attr_name} com >=2 floats`)}get_vert_pos(i){return this._get_vert_attrib(i,"pos")}set_vert_pos(i,x,y,z,w){return this._set_vert_attrib(i,"pos",x,y,z,w)}get_vert_color(i){return this._get_vert_attrib(i,"color")}set_vert_color(i,r,g,b,a){return this._set_vert_attrib(i,"color",r,g,b,a)}get_vert_texcoord(i){return this._get_vert_attrib(i,"texcoord")}set_vert_texcoord(i,u,v2){return this._set_vert_attrib(i,"texcoord",u,v2)}get_vert_normal(i){return this._get_vert_attrib(i,"normal")}set_vert_normal(i,x,y,z){return this._set_vert_attrib(i,"normal",x,y,z)}get_vert_attribs(i,attribs){var attr,j,len,vert;for(vert=[],j=0,len=attribs.length;j<len;j++)attr=attribs[j],vert=vert.concat(this._get_vert_attrib(i,attr));return vert}to_float_array(attribs,use_indices=!0){var data,i,j,l,ref,ref1,v_i,vert;if(data=[],use_indices&&this.data_indices.length>0)for(i=j=0,ref=this.index_count;j<ref;i=j+=1)v_i=this.data_indices[i],vert=this.get_vert_attribs(v_i,attribs),data=data.concat(vert);else for(i=l=0,ref1=this.vertex_count;l<ref1;i=l+=1)vert=this.get_vert_attribs(i,attribs),data=data.concat(vert);return data}_get_bounding_box(){var i,j,max_x,max_y,max_z,min_x,min_y,min_z,pos,ref;for(min_x=min_y=min_z=max_x=max_y=max_z=null,i=j=0,ref=this.vertex_count;j<ref;i=j+=1)pos=this.get_vert_pos(i),(min_x===null||pos[0]<min_x)&&(min_x=pos[0]),(min_y===null||pos[1]<min_y)&&(min_y=pos[1]),(min_z===null||pos[2]<min_z)&&(min_z=pos[2]),(max_x===null||pos[0]>max_x)&&(max_x=pos[0]),(max_y===null||pos[1]>max_y)&&(max_y=pos[1]),(max_z===null||pos[2]>max_z)&&(max_z=pos[2]);return[min_x,min_y,min_z,max_x,max_y,max_z]}get_aabb(){var max_x,max_y,max_z,min_x,min_y,min_z,vmax,vmin;return[min_x,min_y,min_z,max_x,max_y,max_z]=this._get_bounding_box(),vmin=vec(min_x,min_y,min_z),vmax=vec(max_x,max_y,max_z),new AABB(vmin,vmax)}get_sphere(){return this.get_aabb().to_sphere()}build_indices_for_wireframe(){var a,b,c2,i,j,k,novos_indices,ref;for(novos_indices=[],i=j=0,ref=this.index_count/3;j<=ref;i=j+=1)k=i*3,a=this.data_indices[k+0],b=this.data_indices[k+1],c2=this.data_indices[k+2],novos_indices.push(a),novos_indices.push(b),novos_indices.push(b),novos_indices.push(c2),novos_indices.push(c2),novos_indices.push(a);return this.data_indices=novos_indices,this.end()}};globalThis.wgpuObject=wgpuObject2;var wgpu_obj_from_file_type_OBJ2,wgpu_obj_from_file_type_PLY2,wgpu_obj_from_file_type_TXT22,wgpu_obj_from_text_type_OBJ2,wgpu_obj_from_text_type_PLY2,wgpu_obj_from_text_type_TXT22;wgpu_obj_from_file_type_TXT22=async(ctx,url,vertex_format)=>{var text;return text=await wgpu_utils_fetch_text_from_url(url),wgpu_obj_from_text_type_TXT22(ctx,text,vertex_format)};wgpu_obj_from_text_type_TXT22=(ctx,text,vertex_format)=>{var a,b,campo,f,face_count,floats,g,i,indices,k,l,len,lines,m,nx,ny,nz,o,parts,r,ref,ref1,ref2,s,t,tag,v2,v1,v22,v3,vertex_count,verts,x,y,z;for(lines=text.trim().split(/\r?\n/).filter(function(line){return line.trim()!==""}),i=0,vertex_count=parseInt(lines[i++]),verts=[],v2=k=0,ref=vertex_count;k<ref;v2=k+=1){for(parts=lines[i++].trim().split(/\s+/).map(Number),[x,y,z,nx,ny,nz,s,t,r,g,b,a,tag]=parts,r=r/255,g=g/255,b=b/255,a=a/255,floats=[],ref1=vertex_format.campos,l=0,len=ref1.length;l<len;l++)campo=ref1[l],campo==="xy"?floats.push(x,y):campo==="xyz"?floats.push(x,y,z):campo==="rgb"?floats.push(r,g,b):campo==="rgba"?floats.push(r,g,b,a):campo==="uv"?floats.push(s,t):campo==="normal"&&floats.push(nx,ny,nz);verts.push(...floats)}for(face_count=parseInt(lines[i++]),indices=[],f=m=0,ref2=face_count;m<ref2;f=m+=1)[v1,v22,v3]=lines[i++].trim().split(/\s+/).map(Number),indices.push(v1,v22,v3);return o=ctx.obj(),o.begin(vertex_format),o.verts(verts),o.indices(indices),o.end(),o};wgpu_obj_from_file_type_PLY2=async(ctx,url,vertex_format)=>{var text;return text=await wgpu_utils_fetch_text_from_url(url),wgpu_obj_from_text_type_PLY2(ctx,text,vertex_format)};wgpu_obj_from_text_type_PLY2=(ctx,text,vertex_format)=>{var a,b,campo,f,face_count,floats,g,i,indices,j,k,l,len,line,lines,m,n,num_vertices,nx,ny,nz,o,parts,properties,props,r,ref,ref1,ref2,ref3,s,t,v2,vertex_count,verts,x,y,z;if(lines=text.trim().split(/\r?\n/).filter(function(line2){return line2.trim()!==""}),i=0,lines[i++]!=="ply")throw new Error("Arquivo n\xE3o \xE9 um PLY v\xE1lido");for(vertex_count=0,face_count=0,properties=[];i<lines.length&&lines[i]!=="end_header";)line=lines[i++].trim(),parts=line.split(/\s+/),parts[0]==="element"?parts[1]==="vertex"?vertex_count=parseInt(parts[2]):parts[1]==="face"&&(face_count=parseInt(parts[2])):parts[0]==="property"&&parts[1]!=="list"&&properties.push(parts[2]);for(i++,verts=[],v2=k=0,ref=vertex_count;k<ref;v2=k+=1){for(parts=lines[i++].trim().split(/\s+/).map(Number),props={},j=l=0,ref1=properties.length;l<ref1;j=l+=1)props[properties[j]]=parts[j];for(x=props.x||0,y=props.y||0,z=props.z||0,nx=props.nx||0,ny=props.ny||0,nz=props.nz||0,s=props.s||props.u||0,t=props.t||props.v||0,r=(props.red||props.r||255)/255,g=(props.green||props.g||255)/255,b=(props.blue||props.b||255)/255,a=(props.alpha||props.a||255)/255,floats=[],ref2=vertex_format.campos,m=0,len=ref2.length;m<len;m++)campo=ref2[m],campo==="xy"?floats.push(x,y):campo==="xyz"?floats.push(x,y,z):campo==="rgb"?floats.push(r,g,b):campo==="rgba"?floats.push(r,g,b,a):campo==="uv"?floats.push(s,t):campo==="normal"&&floats.push(nx,ny,nz);verts.push(...floats)}for(indices=[],f=n=0,ref3=face_count;n<ref3;f=n+=1)parts=lines[i++].trim().split(/\s+/).map(Number),num_vertices=parts[0],num_vertices===3?indices.push(parts[1],parts[2],parts[3]):num_vertices===4&&(indices.push(parts[1],parts[2],parts[3]),indices.push(parts[1],parts[3],parts[4]));return o=ctx.obj(),o.begin(vertex_format),o.verts(verts),o.indices(indices),o.end(),o};wgpu_obj_from_file_type_OBJ2=async(ctx,url,vertex_format)=>{var text;return text=await wgpu_utils_fetch_text_from_url(url),wgpu_obj_from_text_type_OBJ2(ctx,text,vertex_format)};wgpu_obj_from_text_type_OBJ2=(ctx,text,vertex_format)=>{var campo,current_index,face,face_vertices,faces,floats,fv,i,indices,k,key,l,len,len1,len2,len3,line,lines,m,n,normals,o,p,parts,ref,ref1,texcoords,v2,vertex_map,vertices,verts,vn,vt;for(lines=text.trim().split(/\r?\n/).filter(function(line2){return line2.trim()!==""&&!line2.startsWith("#")}),vertices=[],normals=[],texcoords=[],faces=[],k=0,len=lines.length;k<len;k++)if(line=lines[k],parts=line.trim().split(/\s+/),parts[0]==="v")vertices.push({x:parseFloat(parts[1]),y:parseFloat(parts[2]),z:parseFloat(parts[3])});else if(parts[0]==="vn")normals.push({x:parseFloat(parts[1]),y:parseFloat(parts[2]),z:parseFloat(parts[3])});else if(parts[0]==="vt")texcoords.push({u:parseFloat(parts[1]),v:parseFloat(parts[2])});else if(parts[0]==="f"){for(face_vertices=[],i=l=1,ref=parts.length;l<ref;i=l+=1)indices=parts[i].split("/"),face_vertices.push({v:parseInt(indices[0])-1,vt:indices[1]?parseInt(indices[1])-1:-1,vn:indices[2]?parseInt(indices[2])-1:-1});face_vertices.length===3?faces.push(face_vertices):face_vertices.length===4&&(faces.push([face_vertices[0],face_vertices[1],face_vertices[2]]),faces.push([face_vertices[0],face_vertices[2],face_vertices[3]]))}for(verts=[],indices=[],vertex_map=new Map,current_index=0,m=0,len1=faces.length;m<len1;m++)for(face=faces[m],n=0,len2=face.length;n<len2;n++){if(fv=face[n],key=`${fv.v}_${fv.vt}_${fv.vn}`,!vertex_map.has(key)){for(v2=vertices[fv.v],vt=fv.vt>=0?texcoords[fv.vt]:{u:0,v:0},vn=fv.vn>=0?normals[fv.vn]:{x:0,y:0,z:1},floats=[],ref1=vertex_format.campos,p=0,len3=ref1.length;p<len3;p++)campo=ref1[p],campo==="xy"?floats.push(v2.x,v2.y):campo==="xyz"?floats.push(v2.x,v2.y,v2.z):campo==="rgb"?floats.push(1,1,1):campo==="rgba"?floats.push(1,1,1,1):campo==="uv"?floats.push(vt.u,vt.v):campo==="normal"&&floats.push(vn.x,vn.y,vn.z);verts.push(...floats),vertex_map.set(key,current_index),current_index++}indices.push(vertex_map.get(key))}return o=ctx.obj(),o.begin(vertex_format),o.verts(verts),o.indices(indices),o.end(),o};globalThis.wgpu_obj_from_text_type_TXT2=wgpu_obj_from_text_type_TXT22;globalThis.wgpu_obj_from_file_type_TXT2=wgpu_obj_from_file_type_TXT22;globalThis.wgpu_obj_from_text_type_PLY=wgpu_obj_from_text_type_PLY2;globalThis.wgpu_obj_from_file_type_PLY=wgpu_obj_from_file_type_PLY2;globalThis.wgpu_obj_from_text_type_OBJ=wgpu_obj_from_text_type_OBJ2;globalThis.wgpu_obj_from_file_type_OBJ=wgpu_obj_from_file_type_OBJ2;var wgpuVertexFormat2;wgpuVertexFormat2=class{constructor(...campos){var attributes,attributes_by_name,campo,floats,fmt_map,i,info,offset;offset=0,attributes=[],floats=0,attributes_by_name={},fmt_map={xy:{format:"float32x2",floats:2,attr:"pos"},xyz:{format:"float32x3",floats:3,attr:"pos"},xyzw:{format:"float32x4",floats:4,attr:"pos"},rgb:{format:"float32x3",floats:3,attr:"color"},rgba:{format:"float32x4",floats:4,attr:"color"},uv:{format:"float32x2",floats:2,attr:"texcoord"},normal:{format:"float32x3",floats:3,attr:"normal"}};for(i in campos)campo=campos[i],info=fmt_map[campo],info!=null&&(attributes.push({shaderLocation:i,offset,format:info.format,floats:info.floats}),attributes_by_name[info.attr]={shaderLocation:i,offset,format:info.format,floats:info.floats},floats+=info.floats,offset+=info.floats*4);this.desc=campos.join(","),this.campos=campos,this.floats=floats,this.vertex_size=offset,this.attributes=attributes,this.attributes_by_name=attributes_by_name}};globalThis.wgpuVertexFormat=wgpuVertexFormat2;var wgpuJob2;wgpuJob2=class{constructor(context){this.context=context,this.encoder=null,this.render_pass=null,this.comp_pass=null,this.cur_target=null}render_begin(target=null){var render_pass_descriptor;return this.encoder==null&&(this.encoder=this.context.device.createCommandEncoder()),this.cur_target=target,this.cur_target==null&&(this.cur_target=this.context.frame_buffer),this.cur_target._update_for_render(),render_pass_descriptor=this.cur_target.render_pass_descriptor,this.render_pass=this.encoder.beginRenderPass(render_pass_descriptor),this.render_pass_uniform_list=[]}render_obj(pipeline,obj){return this.render_objs(pipeline,[obj])}render_objs(pipeline,obj_list){var b1,b2,b3,i,j,k,len,obj,obj_i,offset,ref,results,uniform_list;for(this.render_pass.setPipeline(pipeline.pipeline),results=[],obj_i=j=0,len=obj_list.length;j<len;obj_i=++j){if(obj=obj_list[obj_i],this.render_pass.setVertexBuffer(0,obj.vbuf),obj.vertex_format.desc!==pipeline.vertex_format.desc)throw new Error(`Objeto com vertex format diferente da pipeline: ${obj.vertex_format.desc} != ${pipeline.vertex_format.desc}`);for(i=k=0,ref=this.render_pass_uniform_list.length;k<ref;i=k+=1)uniform_list=this.render_pass_uniform_list[i],offset=obj_i*this.context.uniform_buffer_size_per_item,b1=uniform_list.i,b2=uniform_list.g._get_or_create_binding_group(),b3=Array(uniform_list.g.n_dynamic_offsets).fill(offset),this.render_pass.setBindGroup(b1,b2,b3);obj.ibuf!=null?(this.render_pass.setIndexBuffer(obj.ibuf,"uint32"),results.push(this.render_pass.drawIndexed(obj.index_count))):results.push(this.render_pass.draw(obj.vertex_count))}return results}render_use_group(i,g){return g._get_or_create_binding_group(),g.n_dynamic_offsets>0?this.render_pass_uniform_list.push({i,g}):this.render_pass.setBindGroup(i,g._get_or_create_binding_group())}render_instance_list(ls){return ls._render_on_job(this)}render_end(){return this.render_pass.end()}render_save(){var dest,extent,src,target_tex;return target_tex=this.cur_target.get_color_tex(),src={texture:target_tex.tex},dest={buffer:target_tex.gpu_read_buffer,bytesPerRow:target_tex.gpu_read_buffer_bytes_per_row,rowsPerImage:target_tex.h},extent=[target_tex.w,target_tex.h,1],this.encoder.copyTextureToBuffer(src,dest,extent)}comp_begin(){return this.encoder==null&&(this.encoder=this.context.device.createCommandEncoder()),this.comp_pass=this.encoder.beginComputePass()}comp_dispatch(pipeline,n_workgroups){return this.comp_pass.setPipeline(pipeline.pipeline),this.comp_pass.dispatchWorkgroups(n_workgroups)}comp_use_group(i,g,uniform_list_obj_i=0){var b3,offset;return g._get_or_create_binding_group(),g.n_dynamic_offsets>0?(offset=uniform_list_obj_i*this.context.uniform_buffer_size_per_item,b3=Array(g.n_dynamic_offsets).fill(offset),this.comp_pass.setBindGroup(i,g._get_or_create_binding_group(),b3)):this.comp_pass.setBindGroup(i,g._get_or_create_binding_group())}comp_end(){return this.comp_pass.end()}gpu_send(){return this.context.device.queue.submit([this.encoder.finish()]),this.encoder=null}};globalThis.wgpuJob=wgpuJob2;var wgpuCompPipeline2,wgpuPipeline2;wgpuPipeline2=class{constructor(context){this.shader_from_file=this.shader_from_file.bind(this),this.context=context,this.reset(),this._label=""}reset(){return this.config={prim_type:null,alpha:!0,cull:"none",depth:!1,depth_write:!0,msaa:null,shaderModule:null,vs_main_entry:null,fs_main_entry:null,vertexBuffers:[],bindLayouts:[],blend:{color:{srcFactor:"src-alpha",dstFactor:"one-minus-src-alpha",operation:"add"},alpha:{srcFactor:"one",dstFactor:"one-minus-src-alpha",operation:"add"}}},this.groups=[],this.next_group_index=0}label(s){return this._label=s}begin(prim_type,vertex_format=null){var apelidos;if(this.reset(),apelidos={points:"point-list",lines:"line-list",triangles:"triangle-list"},this.config.prim_type=apelidos[prim_type]||prim_type,this.vertex_format=vertex_format,this.vertex_format==null)return this.vertex_format=this.context.last_vertex_format}alpha_blending(enabled){return this.config.alpha=enabled}blend_mode(mode="default"){switch(mode){case"default":return this.config.blend={color:{srcFactor:"src-alpha",dstFactor:"one-minus-src-alpha",operation:"add"},alpha:{srcFactor:"one",dstFactor:"one-minus-src-alpha",operation:"add"}};case"additive":return this.config.blend={color:{srcFactor:"one",dstFactor:"one",operation:"add"},alpha:{srcFactor:"src",dstFactor:"one-minus-src",operation:"add"}};default:throw new Error(`Modo ${mode} inv\xE1lido`)}}depth_test(enabled){return this.config.depth=enabled}depth_write(enabled){return this.config.depth_write=enabled}cull_face(mode){return this.config.cull=mode}msaa(samples=4){return this.config.msaa=samples}shader_from_src(src_code,vs_main_entry="vs_main",fs_main_entry="fs_main"){return this.config.shaderModule=this.context.device.createShaderModule({code:src_code}),this.config.vs_main_entry=vs_main_entry,this.config.fs_main_entry=fs_main_entry}async shader_from_file(url,vs_main_entry="vs_main",fs_main_entry="fs_main"){var src;if(src=await wgpu_utils_fetch_text_from_url(url),this.shader_from_src(src,vs_main_entry,fs_main_entry),this.context.options.debug)return console.log(`Pipeline - shader_from_file: ${url} carregado ok, ${src.length} bytes`)}expect_group(i){return this.groups[i]==null&&(this.groups[i]=new wgpuBindingGroup_Format_Group(i)),this.groups[i]}expect_group_new(){var group;return group=new wgpuBindingGroup_Format_Group(this.next_group_index),this.groups[this.next_group_index]=group,this.next_group_index++,group}copy_from(pipeline){var g,group_i,j,len,ref,results;for(this.config.prim_type=pipeline.config.prim_type,this.config.alpha=pipeline.config.alpha,this.config.cull=pipeline.config.cull,this.config.depth=pipeline.config.depth,this.config.depth_write=pipeline.config.depth_write,this.config.shaderModule=pipeline.config.shaderModule,this.config.vs_main_entry=pipeline.config.vs_main_entry,this.config.fs_main_entry=pipeline.config.fs_main_entry,this.config.blend.color.srcFactor=pipeline.config.blend.color.srcFactor,this.config.blend.color.dstFactor=pipeline.config.blend.color.dstFactor,this.config.blend.color.operation=pipeline.config.blend.color.operation,this.config.blend.alpha.srcFactor=pipeline.config.blend.alpha.srcFactor,this.config.blend.alpha.dstFactor=pipeline.config.blend.alpha.dstFactor,this.config.blend.alpha.operation=pipeline.config.blend.alpha.operation,ref=pipeline.groups,results=[],group_i=j=0,len=ref.length;j<len;group_i=++j)g=ref[group_i],g=this.expect_group(group_i),results.push(g.copy_from(pipeline.groups[group_i]));return results}_create_pipeline_layout(){var b,bindGroupLayouts,binding_index,entry,g,group_entries,group_i,i,j,k,l,layout,len,len1,len2,m,ref,ref1,ref2,ref3,tipo;for(i=j=0,ref=this.groups.length;j<ref;i=j+=1)this.groups[i]===void 0&&(this.groups[i]=null);for(ref1=this.groups,group_i=k=0,len=ref1.length;k<len;group_i=++k){if(g=ref1[group_i],group_entries=[],g!=null)for(ref2=g.bindings,binding_index=l=0,len1=ref2.length;l<len1;binding_index=++l){switch(b=ref2[binding_index],tipo=b._type,entry={binding:binding_index},tipo){case"uniform":entry.visibility=GPUShaderStage.VERTEX|GPUShaderStage.FRAGMENT|GPUShaderStage.COMPUTE,entry.buffer={type:"uniform"};break;case"uniform-list":entry.visibility=GPUShaderStage.VERTEX|GPUShaderStage.FRAGMENT|GPUShaderStage.COMPUTE,entry.buffer={type:"uniform",hasDynamicOffset:!0};break;case"storage":entry.visibility=GPUShaderStage.FRAGMENT|GPUShaderStage.COMPUTE,entry.buffer={type:"storage"};break;case"read-only-storage":entry.visibility=GPUShaderStage.VERTEX|GPUShaderStage.FRAGMENT|GPUShaderStage.COMPUTE,entry.buffer={type:"read-only-storage"};break;case"tex":entry.visibility=GPUShaderStage.FRAGMENT|GPUShaderStage.COMPUTE,entry.texture={};break;case"tex-array":entry.visibility=GPUShaderStage.FRAGMENT|GPUShaderStage.COMPUTE,entry.texture={viewDimension:"2d-array"};break;case"tex-sampler":entry.visibility=GPUShaderStage.FRAGMENT|GPUShaderStage.COMPUTE,entry.sampler={}}group_entries.push(entry)}this.config.bindLayouts[group_i]={entries:group_entries}}for(bindGroupLayouts=[],ref3=this.config.bindLayouts,m=0,len2=ref3.length;m<len2;m++)layout=ref3[m],layout==null?bindGroupLayouts.push(null):bindGroupLayouts.push(this.context.device.createBindGroupLayout(layout));return this.pipeline_layout=this.context.device.createPipelineLayout({bindGroupLayouts})}end(){var color_state,cullMode,depthStencil,msaa_state;if(this.config.vertexBuffers=[{arrayStride:this.vertex_format.vertex_size,attributes:this.vertex_format.attributes,stepMode:"vertex"}],color_state={format:this.context.canvas_format,writeMask:GPUColorWrite.ALL},this.config.alpha&&(color_state.blend=this.config.blend),cullMode=this.config.cull==="none"?void 0:this.config.cull,depthStencil=this.config.depth?{format:"depth24plus",depthWriteEnabled:this.config.depth_write,depthCompare:"less"}:void 0,this.config.msaa!=null?msaa_state={count:this.config.msaa}:msaa_state=void 0,this._create_pipeline_layout(),this.pipeline=this.context.device.createRenderPipeline({layout:this.pipeline_layout,vertex:{module:this.config.shaderModule,entryPoint:this.config.vs_main_entry,buffers:this.config.vertexBuffers},fragment:{module:this.config.shaderModule,entryPoint:this.config.fs_main_entry,targets:[color_state]},primitive:{topology:this.config.prim_type,cullMode},depthStencil,multisample:msaa_state}),this.context.options.debug)return console.log(`Pipeline formada: prim='${this.config.prim_type}', vertex format='${this.vertex_format.desc}', target format='${color_state.format}', depth=${this.config.depth}, alpha=${this.config.alpha}`),console.log(this)}toString(){return`Pipeline [${this._label}]`}};wgpuCompPipeline2=class{constructor(context){this.shader_from_file=this.shader_from_file.bind(this),this.context=context,this.reset(),this._label=""}reset(){return this.config={tipo:"comp",shaderModule:null,cs_main_entry:null,bindLayouts:[]},this.groups=[],this.next_group_index=0}label(s){return this._label=s}expect_group(i){return this.groups[i]==null&&(this.groups[i]=new wgpuBindingGroup_Format_Group(i)),this.groups[i]}expect_group_new(){var group;return group=new wgpuBindingGroup_Format_Group(this.next_group_index),this.groups[this.next_group_index]=group,this.next_group_index++,group}_create_pipeline_layout(){var b,bindGroupLayouts,binding_index,entry,g,group_entries,group_i,i,j,k,l,layout,len,len1,len2,m,ref,ref1,ref2,ref3,tipo;for(i=j=0,ref=this.groups.length;j<ref;i=j+=1)this.groups[i]===void 0&&(this.groups[i]=null);for(ref1=this.groups,group_i=k=0,len=ref1.length;k<len;group_i=++k){if(g=ref1[group_i],group_entries=[],g!=null)for(ref2=g.bindings,binding_index=l=0,len1=ref2.length;l<len1;binding_index=++l){switch(b=ref2[binding_index],tipo=b._type,entry={binding:binding_index},tipo){case"uniform":entry.visibility=GPUShaderStage.VERTEX|GPUShaderStage.FRAGMENT|GPUShaderStage.COMPUTE,entry.buffer={type:"uniform"};break;case"uniform-list":entry.visibility=GPUShaderStage.VERTEX|GPUShaderStage.FRAGMENT|GPUShaderStage.COMPUTE,entry.buffer={type:"uniform",hasDynamicOffset:!0};break;case"storage":entry.visibility=GPUShaderStage.FRAGMENT|GPUShaderStage.COMPUTE,entry.buffer={type:"storage"};break;case"read-only-storage":entry.visibility=GPUShaderStage.VERTEX|GPUShaderStage.FRAGMENT|GPUShaderStage.COMPUTE,entry.buffer={type:"read-only-storage"};break;case"tex":entry.visibility=GPUShaderStage.FRAGMENT|GPUShaderStage.COMPUTE,entry.texture={};break;case"tex-array":entry.visibility=GPUShaderStage.FRAGMENT|GPUShaderStage.COMPUTE,entry.texture={viewDimension:"2d-array"};break;case"tex-sampler":entry.visibility=GPUShaderStage.FRAGMENT|GPUShaderStage.COMPUTE,entry.sampler={}}group_entries.push(entry)}this.config.bindLayouts[group_i]={entries:group_entries}}for(bindGroupLayouts=[],ref3=this.config.bindLayouts,m=0,len2=ref3.length;m<len2;m++)layout=ref3[m],layout==null?bindGroupLayouts.push(null):bindGroupLayouts.push(this.context.device.createBindGroupLayout(layout));return this.pipeline_layout=this.context.device.createPipelineLayout({bindGroupLayouts})}begin(){return this.reset()}shader_from_src(src_code,cs_main_entry="cs_main"){return this.config.shaderModule=this.context.device.createShaderModule({code:src_code}),this.config.cs_main_entry=cs_main_entry}async shader_from_file(url,cs_main_entry="cs_main"){var src;if(src=await wgpu_utils_fetch_text_from_url(url),this.shader_from_src(src,cs_main_entry),this.context.options.debug)return console.log(`CompPipeline - shader_from_file: ${url} carregado ok, ${src.length} bytes`)}end(){if(this._create_pipeline_layout(),this.pipeline=this.context.device.createComputePipeline({layout:this.pipeline_layout,compute:{module:this.config.shaderModule,entryPoint:this.config.cs_main_entry}}),this.context.options.debug)return console.log("CompPipeline formada:"),console.log(this)}};globalThis.wgpuPipeline=wgpuPipeline2;globalThis.wgpuCompPipeline=wgpuCompPipeline2;var wgpuRenderTarget2,wgpuRenderTargetFormat2;wgpuRenderTargetFormat2=class{constructor(...attachments){var formato,j,len,mapa,tipo;for(this.color_attachment_formats=[],this.depth_stencil_attachment_format=null,this.num_color_buffers=0,this.has_depth_buffer=!1,this.has_stencil_buffer=!1,mapa={color:"bgra8unorm","color-rgba":"rgba8unorm","color-bgra":"bgra8unorm","color-byte-r":"r8uint","color-byte-rg":"rg8uint","color-float-r":"r32float","color-float-rg":"rg32float","color-float-rgba":"rgba32float","color-int-r":"r32sint","color-int-rg":"rg32sint","color-int-rgba":"rgba32sint",depth:"depth24plus",stencil:"stencil8","depth-stencil":"depth24plus-stencil8"},j=0,len=attachments.length;j<len;j++){if(tipo=attachments[j],formato=mapa[tipo],formato==null)throw new Error(`Tipo desconhecido: ${tipo}`);tipo.startsWith("color")?this.color_attachment_formats.push(formato):(tipo.startsWith("depth")||tipo.startsWith("stencil"))&&(this.depth_stencil_attachment_format=formato,tipo.includes("depth")&&(this.has_depth_buffer=!0),tipo.includes("stencil")&&(this.has_stencil_buffer=!0))}this.num_color_buffers=this.color_attachment_formats.length}};wgpuRenderTarget2=class{constructor(context,is_frame_buffer=!1){this.context=context,this.is_frame_buffer=is_frame_buffer,this.render_target_format=null,this.render_pass_descriptor=null,this.color_attachment_index_for_canvas=0,this.depth_stencil_tex=null,this.depth_stencil_tex_view=null,this._msaa=1,this._use_msaa=!1,this.msaa_tex=null,this.msaa_tex_view=null,this.is_frame_buffer?(this.w=this.context.canvas.width,this.h=this.context.canvas.height):this.w=this.h=0}format(f){var alpha,formato,i,j,ref;for(this.render_target_format=f,this.color_attachments=[],this.depth_stencil_attachment=void 0,alpha=this.context.options.transparent?0:1,i=j=0,ref=this.render_target_format.num_color_buffers;j<ref;i=j+=1)formato=this.render_target_format.color_attachment_formats[i],this.color_attachments.push({view:null,clearValue:[0,0,0,alpha],loadOp:"clear",storeOp:"store",_tex_format:formato,_tex:null});if((this.render_target_format.has_depth_buffer||this.render_target_format.has_stencil_buffer)&&(this.depth_stencil_attachment={view:null,_tex_format:formato,_tex:null},this.render_target_format.has_depth_buffer&&(this.depth_stencil_attachment.depthClearValue=1,this.depth_stencil_attachment.depthLoadOp="clear",this.depth_stencil_attachment.depthStoreOp="store"),this.render_target_format.has_stencil_buffer))return this.depth_stencil_attachment.stencilClearValue=0,this.depth_stencil_attachment.stencilLoadOp="clear",this.depth_stencil_attachment.stencilStoreOp="store"}clear_color(r,g,b,a=1,color_attachment=0){return this.color_attachments[color_attachment].clearValue=[r,g,b,a]}clear_color_enabled(enabled,color_attachment=0){var op;return op=enabled?"clear":"load",this.color_attachments[color_attachment].loadOp=op}clear_depth(z){if(!this.render_target_format.has_depth_buffer)throw new Error("N\xE3o foi ativado depth buffer");return this.depth_stencil_attachment.depthClearValue=z}clear_depth_enabled(enabled){var op;if(!this.render_target_format.has_depth_buffer)throw new Error("N\xE3o foi ativado depth buffer");return op=enabled?"clear":"load",this.depth_stencil_attachment.depthLoadOp=op}clear_stencil(s){if(!this.render_target_format.has_stencil_buffer)throw new Error("N\xE3o foi ativado stencil buffer");return this.depth_stencil_attachment.stencilClearValue=s}clear_stencil_enabled(enabled){var op;if(!this.render_target_format.has_stencil_buffer)throw new Error("N\xE3o foi ativado stencil buffer");return op=enabled?"clear":"load",this.depth_stencil_attachment.stencilLoadOp=op}msaa(val){return this._msaa=val,this._use_msaa=val>1}size(w,h){if(this.is_frame_buffer)throw new Error("Esperado Render Target sem ser Frame Buffer");return this.w=w,this.h=h}_update_for_render(){var ca,cur_fb_tex,cur_fb_view,formato,i,j,ref,t,usage;for(this.is_frame_buffer&&(cur_fb_tex=this.context.context.getCurrentTexture(),cur_fb_tex.label="FB",cur_fb_view=cur_fb_tex.createView(),this.color_attachment_index_for_canvas>=0&&this.color_attachment_index_for_canvas<this.color_attachments.length&&(ca=this.color_attachments[this.color_attachment_index_for_canvas],ca.view=cur_fb_view,ca._tex==null&&(ca._tex=new wgpuTex(this.context),ca._tex.format=ca._tex_format,ca._tex.w=this.w,ca._tex.h=this.h,ca._tex._gpu_create_read_buffer()),ca._tex.tex=cur_fb_tex,ca._tex.tex_view=cur_fb_view),this._use_msaa&&(this.msaa_tex==null&&(this.msaa_tex=this.context.device.createTexture({size:[this.w,this.h],format:this.context.canvas_format,usage:GPUTextureUsage.RENDER_ATTACHMENT,sampleCount:this._msaa}),this.msaa_tex_view=this.msaa_tex.createView(),this.color_attachments[this.color_attachment_index_for_canvas].view=this.msaa_tex_view),this.color_attachments[this.color_attachment_index_for_canvas].resolveTarget=cur_fb_view)),i=j=0,ref=this.color_attachments.length;j<ref;i=j+=1)this.color_attachments[i].tex_view==null&&(!this.is_frame_buffer||i>=1)&&(t=new wgpuTex(this.context),t.build_mipmaps=t._use_mipmap=!1,usage=GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.COPY_SRC,formato=this.color_attachments[i]._tex_format,t._gpu_create_tex(formato,this.w,this.h,usage),t._gpu_create_read_buffer(),this.color_attachments[i]._tex=t,this.color_attachments[i].view=t._get_or_create_tex_view());return(this.render_target_format.has_depth_buffer||this.render_target_format.has_stencil_buffer)&&this.depth_stencil_tex==null&&(this.depth_stencil_tex=this.context.device.createTexture({size:[this.w,this.h],format:this.render_target_format.depth_stencil_attachment_format,usage:GPUTextureUsage.RENDER_ATTACHMENT,sampleCount:this._use_msaa?this._msaa:void 0}),this.depth_stencil_tex_view=this.depth_stencil_tex.createView(),this.depth_stencil_attachment.view=this.depth_stencil_tex_view),this.render_pass_descriptor={colorAttachments:this.color_attachments,depthStencilAttachment:this.depth_stencil_attachment}}get_color_tex(color_attachment=0){return this.color_attachments[color_attachment]._tex}get_depth_tex(){return this.depth_stencil_attachment._tex}get_stencil_tex(){return this.depth_stencil_attachment._tex}};globalThis.wgpuRenderTarget=wgpuRenderTarget2;globalThis.wgpuRenderTargetFormat=wgpuRenderTargetFormat2;var canvas2d_from_image,image_bitmap_from_url2,image_from_url2,images_from_url_sheet2,mipmap_array_from_image2,wgpuTex2,wgpuTexSampler2;wgpuTex2=class{constructor(context){this.context=context,this.device=this.context.device,this.tex=null,this.tex_view=null,this.format=this.w=this.h=null,this.layers=null,this.is_array=!1,this.cpu_pixels=null,this.gpu_read_buffer=null,this.gpu_read_buffer_bytes=0,this.gpu_read_buffer_bytes_per_row=0,this.cur_canvas_draw_2d=null,this.cur_canvas_draw_2d_ctx=null,this.build_mipmaps=!0,this.mipmap_count=0,this._use_mipmap=!0}_gpu_create_tex(format,w,h,usage,label,layers){usage==null&&(usage=GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_SRC|GPUTextureUsage.COPY_DST|GPUTextureUsage.RENDER_ATTACHMENT),this.format=format,this.w=w,this.h=h,this.byte_size=this.w*this.h*4,this.layers=layers??1,this.is_array=this.layers>1,this.build_mipmaps&&(this.mipmap_count=wgpu_utils_calc_mipmap_levels(this.w,this.h)),this.tex=this.device.createTexture({size:[this.w,this.h,this.layers],dimension:"2d",format:this.format,usage,label,mipLevelCount:this.build_mipmaps?this.mipmap_count:void 0})}use_mipmap(enabled){if(this._use_mipmap!==enabled)return this._use_mipmap=enabled,this.tex_view=null}_get_or_create_tex_view(tex_array_index){var desc;return this.tex_view==null&&(desc={},this.is_array&&(desc.dimension="2d-array",desc.baseArrayLayer=0,desc.arrayLayerCount=this.layers,tex_array_index!=null&&(desc.baseArrayLayer=tex_array_index,desc.arrayLayerCount=1,desc.dimension="2d")),this.build_mipmaps&&!this._use_mipmap&&(desc.baseMipLevel=0,desc.mipLevelCount=1),this.tex_view=this.tex.createView(desc)),this.tex_view}_gpu_tex_from_external_image(source,w,h,mipmap_level=0,dest_layer=0){this.device.queue.copyExternalImageToTexture({source},{texture:this.tex,mipLevel:mipmap_level,origin:[0,0,dest_layer]},[w,h])}_gpu_create_read_buffer(){this.gpu_read_buffer!=null&&(this.gpu_read_buffer.destroy(),this.gpu_read_buffer=null),this.gpu_read_buffer_bytes_per_row=Math.ceil(this.w*4/256)*256,this.gpu_read_buffer_bytes=this.gpu_read_buffer_bytes_per_row*this.h,this.gpu_read_buffer=this.device.createBuffer({size:this.gpu_read_buffer_bytes,usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.MAP_READ})}async _gpu_copy_read_buffer_to_cpu(){var data,j,k,len,offset,ref,row,rowOffset,rows,y;for(await this.gpu_read_buffer.mapAsync(GPUMapMode.READ),data=new Uint8Array(this.gpu_read_buffer.getMappedRange()),rows=[],y=j=0,ref=this.h;j<ref;y=j+=1)rowOffset=y*this.gpu_read_buffer_bytes_per_row,rows.push(data.subarray(rowOffset,rowOffset+this.w*4));for(this.cpu_pixels=new Uint8Array(this.w*this.h*4),offset=0,k=0,len=rows.length;k<len;k++)row=rows[k],this.cpu_pixels.set(row,offset),offset+=row.length;this.gpu_read_buffer.unmap()}async gpu_read(){return await this._gpu_copy_read_buffer_to_cpu(),this.cpu_pixels}gpu_write(){var dest,size;dest={texture:this.tex},size={width:this.w,height:this.h},this.context.device.queue.writeTexture(dest,this.cpu_pixels,size),this.tex_view=this.tex.createView()}get_pixels(){return this.cpu_pixels}get_pixel(x,y){var a,b,g,offset,r;if(x<0||y<0||x>=this.w||y>=this.h)throw new Error(`Pixel (x: ${x}, y: ${y}) fora tamanho ${this.w}x${this.h}`);if(offset=(y*this.w+x)*4,this.format==="bgra8unorm")b=this.cpu_pixels[offset+0],g=this.cpu_pixels[offset+1],r=this.cpu_pixels[offset+2],a=this.cpu_pixels[offset+3];else if(this.format==="rgba8unorm")r=this.cpu_pixels[offset+0],g=this.cpu_pixels[offset+1],b=this.cpu_pixels[offset+2],a=this.cpu_pixels[offset+3];else throw new Error(`Formato desconhecido: ${this.format}`);return[r,g,b,a]}set_pixel(x,y,r,g,b,a){var offset;if(x<0||y<0||x>=this.w||y>=this.h)throw new Error(`Pixel (x: ${x}, y: ${y}) fora tamanho ${this.w}x${this.h}`);if(offset=(y*this.w+x)*4,this.format==="bgra8unorm")this.cpu_pixels[offset+0]=b,this.cpu_pixels[offset+1]=g,this.cpu_pixels[offset+2]=r,this.cpu_pixels[offset+3]=a;else if(this.format==="rgba8unorm")this.cpu_pixels[offset+0]=r,this.cpu_pixels[offset+1]=g,this.cpu_pixels[offset+2]=b,this.cpu_pixels[offset+3]=a;else throw new Error(`Formato desconhecido: ${this.format}`)}get_pixel_interp_bilinear(uv){var c0,c00,c01,c1,c10,c11,fx,fy,x,x0,x1,y,y0,y1;return x=uv.x*this.w-.5,y=uv.y*this.h-.5,x0=Math.floor(x),y0=Math.floor(y),x1=x0+1,y1=y0+1,fx=x-x0,fy=y-y0,x0=Math.max(0,Math.min(this.w-1,x0)),x1=Math.max(0,Math.min(this.w-1,x1)),y0=Math.max(0,Math.min(this.h-1,y0)),y1=Math.max(0,Math.min(this.h-1,y1)),c00=this.get_pixel(x0,y0),c10=this.get_pixel(x1,y0),c01=this.get_pixel(x0,y1),c11=this.get_pixel(x1,y1),c0=lerp(c00,c10,fx),c1=lerp(c01,c11,fx),lerp(c0,c1,fy)}from_canvas2d(canvas_ctx){var h,img_data,w;if(this.cpu_pixels==null)throw new Error("Sem bloco de pixels na mem\xF3ria da CPU");w=canvas_ctx.canvas.width,h=canvas_ctx.canvas.height,this.tex!=null&&(this.w!==w||this.h!==h)&&(this.tex.destroy(),this.tex=null,this._gpu_create_tex(this.format,this.w,this.h)),img_data=canvas_ctx.getImageData(0,0,w,h),this.cpu_pixels=img_data.data}to_canvas2d(canvas_ctx){var a,b,data,g,img_data,j,k,offset,r,ref,ref1,x,y;if(this.cpu_pixels==null)throw new Error("Sem bloco de pixels na mem\xF3ria da CPU");for(img_data=canvas_ctx.createImageData(this.w,this.h),data=img_data.data,y=j=0,ref=this.h;j<ref;y=j+=1)for(x=k=0,ref1=this.w;k<ref1;x=k+=1)[r,g,b,a]=this.get_pixel(x,y),offset=(y*this.w+x)*4,data[offset+0]=r,data[offset+1]=g,data[offset+2]=b,data[offset+3]=a;canvas_ctx.putImageData(img_data,0,0)}to_new_canvas2d(){var canv,ctx;return canv=document.createElement("canvas"),canv.width=this.w,canv.height=this.h,ctx=canv.getContext("2d"),this.to_canvas2d(ctx),canv}begin_canvas2d(){return this.cur_canvas_draw_2d=document.createElement("canvas"),this.cur_canvas_draw_2d.width=this.w,this.cur_canvas_draw_2d.height=this.h,this.cur_canvas_draw_2d_ctx=this.cur_canvas_draw_2d.getContext("2d"),this.cur_canvas_draw_2d_ctx}end_canvas2d(){this.from_canvas2d(this.cur_canvas_draw_2d_ctx),this.cur_canvas_draw_2d_ctx=null,this.cur_canvas_draw_2d=null}put_in_html(html_obj,pixel_size=1){var canv,img;canv=this.to_new_canvas2d(),img=new Image,img.src=canv.toDataURL("image/png"),pixel_size!==1&&(img.style.width=this.w*pixel_size+"px",img.style.height=this.h*pixel_size+"px",img.style.imageRendering="pixelated"),html_obj.appendChild(img)}save_to_file(filename="screenshot.png"){var canv,img,timestamp;canv=this.to_new_canvas2d(),img=new Image,img.src=canv.toDataURL("image/png"),filename==null&&(timestamp=new Date().toISOString().replace(/[:.]/g,"-"),filename=`screenshot-${timestamp}.png`),canv.toBlob(function(blob){var link,url;if(blob)return url=URL.createObjectURL(blob),link=document.createElement("a"),link.href=url,link.download=filename,link.style.display="none",document.body.appendChild(link),link.click(),document.body.removeChild(link),URL.revokeObjectURL(url);throw new Error("Falha ao criar blob da imagem")},"image/png")}};wgpuTexSampler2=class{constructor(context,filtro,repeat_mode){this.context=context,this.filtro=filtro,this.repeat_mode=repeat_mode,this.sampler=this.context.device.createSampler({magFilter:this.filtro,minFilter:this.filtro,addressModeU:this.repeat_mode,addressModeV:this.repeat_mode,mipmapFilter:this.filtro})}};image_from_url2=async function(url){var img;return img=await new Promise(function(resolve,reject){return img=new Image,img.onload=function(){return resolve(img)},img.onerror=function(){return reject(new Error(`Erro ao carregar a imagem: ${url}`))},img.src=url}),img};image_bitmap_from_url2=async function(url){var blob,image_bitmap,response;if(response=await fetch(url),!response.ok)throw new Error(`Erro ao carregar a imagem: ${response.status}`);return blob=await response.blob(),image_bitmap=await createImageBitmap(blob),image_bitmap};images_from_url_sheet2=async function(url,tile_w,tile_h,padding=0,tile_count=null){var i,img,imgs,j,ref,tile_img_bitmap,tiles,tiles_x,tiles_y,x,y;for(img=await image_from_url2(url),tiles_x=Math.floor((img.width+padding)/(tile_w+padding)),tiles_y=Math.floor((img.height+padding)/(tile_h+padding)),tiles=tiles_x*tiles_y,tile_count!=null&&(tiles=Math.min(tiles,tile_count)),imgs=[],i=j=0,ref=tiles;0<=ref?j<ref:j>ref;i=0<=ref?++j:--j)x=i%tiles_x*(tile_w+padding),y=Math.floor(i/tiles_x)*(tile_h+padding),tile_img_bitmap=await createImageBitmap(img,x,y,tile_w,tile_h),imgs.push(tile_img_bitmap);return imgs};canvas2d_from_image=function(img,canvas_width=null,canvas_height=null){var canvas,ctx;return canvas=document.createElement("canvas"),canvas.width=canvas_width??img.width,canvas.height=canvas_height??img.height,ctx=canvas.getContext("2d"),ctx.drawImage(img,0,0,canvas.width,canvas.height),ctx};mipmap_array_from_image2=function(image){var canvas,canvas_menor,ctx,ctx_menor,h,mipmaps,w;for(mipmaps=[],w=image.width,h=image.height,canvas=document.createElement("canvas"),canvas.width=w,canvas.height=h,ctx=canvas.getContext("2d"),ctx.imageSmoothingEnabled=!0,ctx.imageSmoothingQuality="high",ctx.drawImage(image,0,0,w,h),mipmaps.push(canvas);w>1||h>1;)w=Math.max(1,Math.floor(w/2)),h=Math.max(1,Math.floor(h/2)),canvas_menor=document.createElement("canvas"),canvas_menor.width=w,canvas_menor.height=h,ctx_menor=canvas_menor.getContext("2d"),ctx_menor.imageSmoothingEnabled=!0,ctx_menor.imageSmoothingQuality="high",ctx_menor.drawImage(canvas,0,0,canvas_menor.width,canvas_menor.height),mipmaps.push(canvas_menor),canvas=canvas_menor;return mipmaps};globalThis.image_from_url=image_from_url2;globalThis.image_bitmap_from_url=image_bitmap_from_url2;globalThis.images_from_url_sheet=images_from_url_sheet2;globalThis.canvas2d_from_image=canvas2d_from_image;globalThis.mipmap_array_from_image=mipmap_array_from_image2;globalThis.wgpuTex=wgpuTex2;globalThis.wgpuTexSampler=wgpuTexSampler2;var TYPE_INFO,wgpuUniform2;TYPE_INFO={f32:{size:4,align:4,components:1},i32:{size:4,align:4,components:1},u32:{size:4,align:4,components:1},vec2:{size:8,align:8,components:2},vec3:{size:12,align:16,components:3},vec4:{size:16,align:16,components:4},vec4i:{size:16,align:16,components:4},mat2x2:{size:16,align:8,components:2},mat3x3:{size:48,align:16,components:3},mat4x4:{size:64,align:16,components:4}};wgpuUniform2=class{constructor(context,is_uniform_list=!1,n=null){this.context=context,this.reset(),this.is_uniform_list=is_uniform_list,this.count=this.is_uniform_list?n:0,this.is_uniform_list?this.per_item_size=this.context.uniform_buffer_size_per_item:this.per_item_size=0,this._label=""}label(s){return this._label=s}reset(){return this.struct=[],this.fields={},this.items=[],this.desc=""}begin(){return this.reset()}float(name){return this._add_field(name,"f32",1)}int(name){return this._add_field(name,"i32",1)}uint(name){return this._add_field(name,"u32",1)}vec2(name){return this._add_field(name,"vec2",1)}vec3(name){return this._add_field(name,"vec3",1)}vec4(name){return this._add_field(name,"vec4",1)}vec4i(name){return this._add_field(name,"vec4i",1)}mat2x2(name){return this._add_field(name,"mat2x2",1)}mat3x3(name){return this._add_field(name,"mat3x3",1)}mat4x4(name){return this._add_field(name,"mat4x4",1)}array_float(name,n){return this._add_field(name,"f32",n)}array_int(name,n){return this._add_field(name,"i32",n)}array_uint(name,n){return this._add_field(name,"u32",n)}array_vec2(name,n){return this._add_field(name,"vec2",n)}array_vec3(name,n){return this._add_field(name,"vec3",n)}array_vec4(name,n){return this._add_field(name,"vec4",n)}_add_field(name,type,array_count=1){var field,type_info;if(type_info=TYPE_INFO[type],type_info==null)throw new Error(`Tipo inv\xE1lido: ${type}`);if(field={name,type,value:null,offset:null,align:type_info.align,size:null,type_size:type_info.size,components:type_info.components,array_count,array_stride:0},field.array_count>1?(field.value=Array.from({length:field.array_count},()=>this._default_value_for(field.type)),field.array_stride=wgpu_utils_calc_align(field.type_size,field.align),field.size=field.array_stride*field.array_count):(field.value=this._default_value_for(field.type),field.size=field.type_size),this.struct.push(field),this.fields[name]=field,!this.is_uniform_list)return function(it,nome){Object.defineProperty(it,nome,{set:function(v2){return it.fields[nome].value=v2},get:function(){return it.fields[nome].value},enumerable:!0})}(this,field.name)}_default_value_for(type){switch(type){case"f32":case"i32":case"u32":return 0;case"vec2":return vec(0,0);case"vec3":return vec(0,0,0);case"vec4":return vec(0,0,0,1);case"vec4i":return vec(0,0,0,1);case"mat2x2":return new Mat2x2;case"mat3x3":return new Mat3x3;case"mat4x4":return new Mat4x4}}_calc_offsets_and_struct_size(){var field,k,len,maior_align,offset,ref;for(offset=0,maior_align=0,ref=this.struct,k=0,len=ref.length;k<len;k++)field=ref[k],offset=wgpu_utils_calc_align(offset,field.align),field.offset=offset,offset+=field.size,maior_align=Math.max(maior_align,field.align);if(this.struct_size=wgpu_utils_calc_align(offset,maior_align),this.is_uniform_list){if(this.struct_size>this.per_item_size)throw new Error(`Tamanho muito grande da estrutura ${this.struct_size} bytes ainda n\xE3o suportado`);return this.total_size=this.per_item_size*this.count}else return this.total_size=this.struct_size}end(){var field,i,item,k,l,len,len1,len2,m,o,ref,ref1,ref2,ref3,results;if(this._calc_offsets_and_struct_size(),this.context.options.debug){for(this.is_uniform_list?console.log("Uniform [List]:"):console.log("Uniform:"),ref=this.struct,k=0,len=ref.length;k<len;k++)field=ref[k],console.log(`- campo '${field.name}', tipo ${field.type}, ${field.size} bytes, offset ${field.offset}, align ${field.align}`);console.log(`- struct size (alinhado): ${this.struct_size} bytes`),this.is_uniform_list&&console.log(`- para n = ${this.count} objetos`)}for(this.desc="{",ref1=this.struct,l=0,len1=ref1.length;l<len1;l++)field=ref1[l],this.desc+=`${field.name} ${field.type}  `;if(this.desc+="}",this._create_buffer_and_data(),this.is_uniform_list){for(this.items=[],results=[],i=m=0,ref2=this.count;m<ref2;i=m+=1){for(item={fields:{}},ref3=this.struct,o=0,len2=ref3.length;o<len2;o++)field=ref3[o],item.fields[field.name]={name:field.name,type:field.type,value:null,offset:field.offset,align:field.align,size:field.size,type_size:field.type_size,components:field.components,array_count:field.array_count,array_stride:field.array_stride},function(it,nome){Object.defineProperty(it,nome,{set:function(v2){return it.fields[nome].value=v2},get:function(){return it.fields[nome].value},enumerable:!0})}(item,field.name);results.push(this.items.push(item))}return results}}set_all(field_name,vals){var i,k,ref;if(vals.length!==this.items.length)throw new Error(`Esperado ${this.items.length} itens no array de valores, e n\xE3o ${vals.length}`);for(i=k=0,ref=this.items.length;k<ref;i=k+=1)this.items[i].fields[field_name].value=vals[i]}set_all_default(field_name,val){var i,k,ref;for(i=k=0,ref=this.items.length;k<ref;i=k+=1)this.items[i].fields[field_name].value=val}get_item_data(i){return this.items[i]}_create_buffer_and_data(){return this.buffer=this.context.device.createBuffer({size:this.total_size,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),this.data=new ArrayBuffer(this.total_size),this.data_view=new DataView(this.data)}_write_field_to_internal_data(base_offset,field,field_value){var N,Nd,dst_index,i,j,k,l,little_endian,m,o,offset,ref,ref1,ref2,ref3,src_index,v2,value;if(field_value!==null)switch(little_endian=!0,offset=field.offset+base_offset,value=field_value,field.type){case"f32":this.data_view.setFloat32(offset,value,little_endian);break;case"i32":this.data_view.setInt32(offset,value,little_endian);break;case"u32":this.data_view.setUint32(offset,value,little_endian);break;case"vec2":case"vec3":case"vec4":for(Array.isArray(value)||value instanceof Float32Array?v2=value:v2=value.data,i=k=0,ref=field.components;0<=ref?k<ref:k>ref;i=0<=ref?++k:--k)this.data_view.setFloat32(offset+i*4,v2[i],little_endian);break;case"vec4i":for(Array.isArray(value)||value instanceof Int32Array?v2=value:v2=value.data,i=l=0,ref1=field.components;0<=ref1?l<ref1:l>ref1;i=0<=ref1?++l:--l)this.data_view.setInt32(offset+i*4,v2[i],little_endian);break;case"mat2x2":case"mat3x3":case"mat4x4":for(Array.isArray(value)||value instanceof Float32Array?v2=value:v2=value.data,N=field.components,Nd=N===3?4:N,i=m=0,ref2=N;0<=ref2?m<ref2:m>ref2;i=0<=ref2?++m:--m)for(j=o=0,ref3=N;0<=ref3?o<ref3:o>ref3;j=0<=ref3?++o:--o)src_index=i*N+j,dst_index=j*Nd+i,this.data_view.setFloat32(offset+dst_index*4,v2[src_index],little_endian)}}_write_fields_to_internal_data(base_offset,fields){var field,i,name,results,stride;results=[];for(name in fields)field=fields[name],field.array_count===1?results.push(this._write_field_to_internal_data(base_offset,field,field.value)):(stride=field.array_stride,results.push(function(){var k,ref,results1;for(results1=[],i=k=0,ref=field.array_count;k<ref;i=k+=1)results1.push(this._write_field_to_internal_data(base_offset+i*stride,field,field.value[i]));return results1}.call(this)));return results}gpu_send(){var base_offset,i,k,ref;if(this.is_uniform_list)for(i=k=0,ref=this.count;k<ref;i=k+=1)base_offset=i*this.per_item_size,this._write_fields_to_internal_data(base_offset,this.items[i].fields);else this._write_fields_to_internal_data(0,this.fields);return this.context.device.queue.writeBuffer(this.buffer,0,this.data)}};globalThis.wgpuUniform=wgpuUniform2;var wgpuStorage2;wgpuStorage2=class{constructor(context,tipo,num_array=null){if(this.context=context,this.tipo=tipo,this.num_array=num_array,this.reset(),this._label="",this.tipo==="float")this.desc=`{float-array [${this.num_array.length}]}`,this.struct_size=this.total_size=this.num_array.length*4,this._create_buffer();else if(this.tipo==="int")this.desc=`{int-array [${this.num_array.length}]}`,this.struct_size=this.total_size=this.num_array.length*4,this._create_buffer();else if(this.tipo!=="struct")throw new Error(`Tipo inv\xE1lido: ${this.tipo}`)}reset(){return this.struct=[]}label(s){return this._label=s}begin(){return this.reset()}float(name){return this.struct.push({name,size:4,align:4,type:"float32"})}int(name){return this.struct.push({name,size:4,align:4,type:"int32"})}uint(name){return this.struct.push({name,size:4,align:4,type:"uint32"})}vec2(name){return this.struct.push({name,size:8,align:8,type:"vec2<f32>"})}vec3(name){return this.struct.push({name,size:12,align:16,type:"vec3<f32>"})}vec4(name){return this.struct.push({name,size:16,align:16,type:"vec4<f32>"})}mat2x2(name){return this.struct.push({name,size:16,align:8,type:"mat2x2"})}mat3x3(name){return this.struct.push({name,size:48,align:16,type:"mat3x3"})}mat4x4(name){return this.struct.push({name,size:64,align:16,type:"mat4x4"})}end(n=null){var field,k,l,len,len1,maxAlign,ref,ref1,struct_size;if(this.tipo!=="struct")throw new Error("Esperado tipo struct");for(struct_size=0,maxAlign=0,this.context.options.debug&&console.log("Storage:"),ref=this.struct,k=0,len=ref.length;k<len;k++)field=ref[k],field.offset=wgpu_utils_calc_align(struct_size,field.align),struct_size=field.offset+field.size,maxAlign=Math.max(maxAlign,field.align),this.context.options.debug&&console.log(`- campo '${field.name}', tipo ${field.type}, ${field.size} bytes, offset ${field.offset}`);for(this.struct_size=wgpu_utils_calc_align(struct_size,maxAlign),this.context.options.debug&&(console.log(`- struct size: ${struct_size} bytes`),n!=null&&console.log(`- para n = ${n} objetos`)),this.desc="{",ref1=this.struct,l=0,len1=ref1.length;l<len1;l++)field=ref1[l],this.desc+=`${field.name} ${field.type}  `;return this.desc+="}",n==null?(this.total_size=this.struct_size,this.is_struct_list=!1,this.count=0,this.per_item_size=0):(this.total_size=this.struct_size*n,this.is_struct_list=!0,this.count=n,this.per_item_size=this.struct_size),this._create_buffer()}_create_buffer(){var field,i,item,k,l,len,len1,m,ref,ref1,ref2,results,results1;if(this.buffer=this.context.device.createBuffer({size:this.total_size,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST|GPUBufferUsage.COPY_SRC}),this.read_buffer=this.context.device.createBuffer({size:this.total_size,usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.MAP_READ}),this.fields={},this.items=[],this.tipo==="struct")if(this.data=new ArrayBuffer(this.total_size),this.data_view=new DataView(this.data),this.is_struct_list){for(results=[],i=k=0,ref=this.count;k<ref;i=k+=1){for(item={fields:{}},ref1=this.struct,l=0,len=ref1.length;l<len;l++)field=ref1[l],item.fields[field.name]={offset:field.offset,type:field.type,size:field.size,value:null},function(nome){return Object.defineProperty(item,nome,{set:function(v2){return item.fields[nome].value=v2},get:function(){return item.fields[nome].value},enumerable:!0})}(field.name);results.push(this.items.push(item))}return results}else{for(ref2=this.struct,results1=[],m=0,len1=ref2.length;m<len1;m++)field=ref2[m],this.fields[field.name]={offset:field.offset,type:field.type,size:field.size,value:null},results1.push(function(nome,obj){return Object.defineProperty(obj,nome,{set:function(v2){return this.fields[nome].value=v2},get:function(){return this.fields[nome].value},enumerable:!0})}(field.name,this));return results1}}set_all(field_name,vals){var i,k,ref,results;if(this.tipo!=="struct")throw new Error("V\xE1lido apenas para storage de struct");if(vals.length!==this.items.length)throw new Error(`Esperado ${this.items.length} itens no array de valores, e n\xE3o ${vals.length}`);for(results=[],i=k=0,ref=this.items.length;k<ref;i=k+=1)results.push(this.items[i].fields[field_name].value=vals[i]);return results}set_all_default(field_name,val){var i,k,ref,results;if(this.tipo!=="struct")throw new Error("V\xE1lido apenas para storage de struct");for(results=[],i=k=0,ref=this.items.length;k<ref;i=k+=1)results.push(this.items[i].fields[field_name].value=val);return results}_update_internal_data(base_offset,fields){var dst_index,field,i,j,name,offset,results,src_index,v2,value;results=[];for(name in fields)if(field=fields[name],offset=field.offset+base_offset,value=field.value,value!==null)switch(field.type){case"float32":results.push(this.data_view.setFloat32(offset,value,!0));break;case"int32":results.push(this.data_view.setInt32(offset,value,!0));break;case"uint32":results.push(this.data_view.setUint32(offset,value,!0));break;case"vec2<f32>":this.data_view.setFloat32(offset,value[0],!0),results.push(this.data_view.setFloat32(offset+4,value[1],!0));break;case"vec3<f32>":this.data_view.setFloat32(offset,value[0],!0),this.data_view.setFloat32(offset+4,value[1],!0),results.push(this.data_view.setFloat32(offset+8,value[2],!0));break;case"vec4<f32>":this.data_view.setFloat32(offset,value[0],!0),this.data_view.setFloat32(offset+4,value[1],!0),this.data_view.setFloat32(offset+8,value[2],!0),results.push(this.data_view.setFloat32(offset+12,value[3],!0));break;case"mat2x2":Array.isArray(value)||value instanceof Float32Array?v2=value:v2=value.data,results.push(function(){var k,results1;for(results1=[],i=k=0;k<=1;i=++k)results1.push(function(){var l,results2;for(results2=[],j=l=0;l<=1;j=++l)src_index=i*2+j,dst_index=j*2+i,results2.push(this.data_view.setFloat32(offset+dst_index*4,v2[src_index],!0));return results2}.call(this));return results1}.call(this));break;case"mat3x3":Array.isArray(value)||value instanceof Float32Array?v2=value:v2=value.data,results.push(function(){var k,results1;for(results1=[],i=k=0;k<=2;i=++k)results1.push(function(){var l,results2;for(results2=[],j=l=0;l<=2;j=++l)src_index=i*3+j,dst_index=j*4+i,results2.push(this.data_view.setFloat32(offset+dst_index*4,v2[src_index],!0));return results2}.call(this));return results1}.call(this));break;case"mat4x4":Array.isArray(value)||value instanceof Float32Array?v2=value:v2=value.data,results.push(function(){var k,results1;for(results1=[],i=k=0;k<=3;i=++k)results1.push(function(){var l,results2;for(results2=[],j=l=0;l<=3;j=++l)src_index=i*4+j,dst_index=j*4+i,results2.push(this.data_view.setFloat32(offset+dst_index*4,v2[src_index],!0));return results2}.call(this));return results1}.call(this));break;default:results.push(void 0)}return results}gpu_send(){var base_offset,float_array,i,int_array,k,ref;if(this.tipo==="struct"){if(this.is_struct_list)for(i=k=0,ref=this.count;k<ref;i=k+=1)base_offset=i*this.per_item_size,this._update_internal_data(base_offset,this.items[i].fields);else this._update_internal_data(0,this.fields);return this.context.device.queue.writeBuffer(this.buffer,0,this.data)}else{if(this.tipo==="float")return float_array=new Float32Array(this.num_array),this.context.device.queue.writeBuffer(this.buffer,0,float_array);if(this.tipo==="int")return int_array=new Int32Array(this.num_array),this.context.device.queue.writeBuffer(this.buffer,0,int_array)}}_update_fields_from_internal_data(base_offset,fields){var dst_index,field,i,j,name,offset,results,src_index;results=[];for(name in fields)switch(field=fields[name],offset=field.offset+base_offset,field.type){case"float32":results.push(field.value=this.data_view.getFloat32(offset,!0));break;case"int32":results.push(field.value=this.data_view.getInt32(offset,!0));break;case"uint32":results.push(field.value=this.data_view.getUint32(offset,!0));break;case"vec2<f32>":field.value=[0,0],field.value[0]=this.data_view.getFloat32(offset,!0),results.push(field.value[1]=this.data_view.getFloat32(offset+4,!0));break;case"vec3<f32>":field.value=[0,0,0],field.value[0]=this.data_view.getFloat32(offset,!0),field.value[1]=this.data_view.getFloat32(offset+4,!0),results.push(field.value[2]=this.data_view.getFloat32(offset+8,!0));break;case"vec4<f32>":field.value=[0,0,0,0],field.value[0]=this.data_view.getFloat32(offset,!0),field.value[1]=this.data_view.getFloat32(offset+4,!0),field.value[2]=this.data_view.getFloat32(offset+8,!0),results.push(field.value[3]=this.data_view.getFloat32(offset+12,!0));break;case"mat2x2":field.value=[0,0,0,0],results.push(function(){var k,results1;for(results1=[],i=k=0;k<=1;i=++k)results1.push(function(){var l,results2;for(results2=[],j=l=0;l<=1;j=++l)src_index=i*2+j,dst_index=j*2+i,results2.push(field.value[src_index]=this.data_view.getFloat32(offset+dst_index*4,!0));return results2}.call(this));return results1}.call(this));break;case"mat3x3":field.value=[0,0,0,0,0,0,0,0,0],results.push(function(){var k,results1;for(results1=[],i=k=0;k<=2;i=++k)results1.push(function(){var l,results2;for(results2=[],j=l=0;l<=2;j=++l)src_index=i*3+j,dst_index=j*4+i,results2.push(field.value[src_index]=this.data_view.getFloat32(offset+dst_index*4,!0));return results2}.call(this));return results1}.call(this));break;case"mat4x4":field.value=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],results.push(function(){var k,results1;for(results1=[],i=k=0;k<=3;i=++k)results1.push(function(){var l,results2;for(results2=[],j=l=0;l<=3;j=++l)src_index=i*4+j,dst_index=j*4+i,results2.push(field.value[src_index]=this.data_view.getFloat32(offset+dst_index*4,!0));return results2}.call(this));return results1}.call(this));break;default:results.push(void 0)}return results}async gpu_read(){var array_buffer,base_offset,data,data_copy,encoder,i,k,ref;if(encoder=this.context.device.createCommandEncoder(),encoder.copyBufferToBuffer(this.buffer,0,this.read_buffer,0,this.total_size),this.context.device.queue.submit([encoder.finish()]),this.tipo==="struct"){if(await this.read_buffer.mapAsync(GPUMapMode.READ),this.data_view=new DataView(this.read_buffer.getMappedRange()),this.is_struct_list)for(i=k=0,ref=this.count;k<ref;i=k+=1)base_offset=i*this.per_item_size,this._update_fields_from_internal_data(base_offset,this.items[i].fields);else this._update_fields_from_internal_data(0,this.fields);return this.read_buffer.unmap()}else{if(this.tipo==="float")return await this.read_buffer.mapAsync(GPUMapMode.READ),array_buffer=this.read_buffer.getMappedRange(),data=new Float32Array(array_buffer),data_copy=new Float32Array(data),this.read_buffer.unmap(),this.num_array=data_copy;if(this.tipo==="int")return await this.read_buffer.mapAsync(GPUMapMode.READ),array_buffer=this.read_buffer.getMappedRange(),data=new Int32Array(array_buffer),data_copy=new Int32Array(data),this.read_buffer.unmap(),this.num_array=data_copy}}get_array(){return this.num_array}};globalThis.wgpuStorage=wgpuStorage2;var wgpuBindingGroup_Data_Binding,wgpuBindingGroup_Data_Group2,wgpuBindingGroup_Format_Binding,wgpuBindingGroup_Format_Group2,wgpu_binding_group__binding_type,indexOf=[].indexOf;wgpu_binding_group__binding_type=function(tipo){var lista_final,mapa;if(mapa={u:"uniform",ul:"uniform-list",s:"storage",rs:"read-only-storage",t:"tex",ts:"tex-sampler"},mapa[tipo]!=null&&(tipo=mapa[tipo]),lista_final=["uniform","uniform-list","storage","read-only-storage","tex","tex-sampler"],!(indexOf.call(lista_final,tipo)>=0))throw new Error(`Tipo inv\xE1lido: ${tipo}`);return tipo};wgpuBindingGroup_Format_Binding=class{constructor(index){this.index=index,this._type=null}copy_from(binding_group_format_binding){return this._type=binding_group_format_binding._type}uniform(){if(this._type!=null)throw new Error(`Redefinindo binding ${this.index} para uniform? Tipo anterior: ${this._type}`);return this._type="uniform"}uniform_list(){if(this._type!=null)throw new Error(`Redefinindo binding ${this.index} para uniform-list? Tipo anterior: ${this._type}`);return this._type="uniform-list"}storage(){if(this._type!=null)throw new Error(`Redefinindo binding ${this.index} para storage? Tipo anterior: ${this._type}`);return this._type="storage"}tex(){if(this._type!=null)throw new Error(`Redefinindo binding ${this.index} para tex? Tipo anterior: ${this._type}`);return this._type="tex"}tex_array(){if(this._type!=null)throw new Error(`Redefinindo binding ${this.index} para tex-array? Tipo anterior: ${this._type}`);return this._type="tex-array"}tex_sampler(){if(this._type!=null)throw new Error(`Redefinindo binding ${this.index} para tex-sampler? Tipo anterior: ${this._type}`);return this._type="tex-sampler"}};wgpuBindingGroup_Format_Group2=class{constructor(index){this.index=index,this.bindings=[],this.nextBindingIndex=0}copy_from(binding_group_format_group){var b,binding,binding_index,k,len,ref,results;for(ref=binding_group_format_group.bindings,results=[],binding_index=k=0,len=ref.length;k<len;binding_index=++k)binding=ref[binding_index],b=this.binding(binding_index),results.push(b.copy_from(binding));return results}binding(j){return this.bindings[j]==null&&(this.bindings[j]=new wgpuBindingGroup_Format_Binding(j)),this.bindings[j]}binding_new(){var binding;return binding=new wgpuBindingGroup_Format_Binding(this.nextBindingIndex),this.bindings[this.nextBindingIndex]=binding,this.nextBindingIndex++,binding}};wgpuBindingGroup_Data_Binding=class{constructor(context,index){this.context=context,this.index=index,this._type=null,this._data=null}set_uniform(u){if(!(u instanceof wgpuUniform))throw new Error("Esperado objeto Uniform");return this._type="uniform",this._data=u}set_uniform_list(u){if(!(u instanceof wgpuUniform))throw new Error("Esperado objeto Uniform");if(!u.is_uniform_list)throw new Error("Esperado objeto Uniform com List");return this._type="uniform-list",this._data=u}set_storage(s){if(!(s instanceof wgpuStorage))throw new Error("Esperado objeto Storage");return this._type="storage",this._data=s}set_tex(t){if(!(t instanceof wgpuTex))throw new Error("Esperado objeto Tex");return this._type="tex",this._data=t}set_tex_array(t){if(!(t instanceof wgpuTex))throw new Error("Esperado objeto Tex");if(!t.is_array)throw new Error("Esperado textura com array");return this._type="tex-array",this._data=t}set_tex_sampler(ts){if(!(ts instanceof wgpuTexSampler))throw new Error("Esperado objeto TexSampler");return this._type="tex-sampler",this._data=ts}uniform(){var u;return u=this.context.uniform(),this._type="uniform",this._data=u,u}uniform_list(n){var u;return u=this.context.uniform_list(n),this._type="uniform-list",this._data=u,u}storage(){var s;return s=this.context.storage(),this._type="storage",this._data=s,s}storage_from_float_array(num_array){var s;return s=this.context.storage_from_float_array(num_array),this._type="storage",this._data=s,s}storage_from_int_array(num_array){var s;return s=this.context.storage_from_int_array(num_array),this._type="storage",this._data=s,s}storage_from_float_array_n(n,default_value=0){var s;return s=this.context.storage_from_float_array_n(n,default_value),this._type="storage",this._data=s,s}async tex_from_file(uri){var t;return t=await this.context.tex_from_file(uri),this._type="tex",this._data=t,t}tex_from_data(w,h,rgba_bytes){var t;return t=this.context.tex_from_data(w,h,rgba_bytes),this._type="tex",this._data=t,t}tex_from_color(w,h,r,g,b,a){var t;return t=this.context.tex_from_color(w,h,r,g,b,a),this._type="tex",this._data=t,t}async tex_array_from_files(urls){var t;return t=await this.context.tex_array_from_files(urls),this._type="tex-array",this._data=t,t}async tex_array_from_sheet_file(url,tile_w,tile_h,padding=0,tile_count=null){var t;return t=await this.context.tex_array_from_sheet_file(url,tile_w,tile_h,padding,tile_count),this._type="tex-array",this._data=t,t}tex_sampler(filtro,repeat_mode="clamp-to-edge"){var ts;return ts=this.context.tex_sampler(filtro,repeat_mode),this._type="tex-sampler",this._data=ts,ts}get_uniform(){if(this._type!=="uniform")throw new Error("Binding n\xE3o \xE9 uniform");return this._data}get_uniform_list(){if(this._type!=="uniform-list")throw new Error("Binding n\xE3o \xE9 uniform-list");return this._data}get_storage(){if(this._type!=="storage")throw new Error("Binding n\xE3o \xE9 storage");return this._data}get_tex(){if(this._type!=="tex")throw new Error("Binding n\xE3o \xE9 tex");return this._data}get_tex_array(){if(this._type!=="tex-array")throw new Error("Binding n\xE3o \xE9 tex-array");return this._data}get_tex_sampler(){if(this._type!=="tex-sampler")throw new Error("Binding n\xE3o \xE9 tex-sampler");return this._data}gpu_send(){this._data.gpu_send()}};wgpuBindingGroup_Data_Group2=class{constructor(context){this.context=context,this.bindings=[],this.nextBindingIndex=0,this.bind_group=null,this.bind_group_layout=null,this.n_dynamic_offsets=0,this._label=""}label(s){return this._label=s}binding(i){return this.bindings[i]==null&&(this.bindings[i]=new wgpuBindingGroup_Data_Binding(this.context,i)),this.bindings[i]}binding_new(){var binding;return binding=new wgpuBindingGroup_Data_Binding(this.context,this.nextBindingIndex),this.bindings[this.nextBindingIndex]=binding,this.nextBindingIndex++,binding}binding_find(binding_type){var binding,binding_index,k,len,ref;for(ref=this.bindings,binding_index=k=0,len=ref.length;k<len;binding_index=++k)if(binding=ref[binding_index],binding._type===binding_type)return binding_index;return-1}invalidate(){return this.bind_group=null}_get_or_create_binding_group(){var bg_entries,bg_entry,binding,binding_index,desc_info,k,layout_entries,layout_entry,len,ref;if(this.bind_group!=null)return this.bind_group;for(layout_entries=[],bg_entries=[],this.n_dynamic_offsets=0,desc_info="",ref=this.bindings,binding_index=k=0,len=ref.length;k<len;binding_index=++k){if(binding=ref[binding_index],layout_entry={binding:binding_index},bg_entry={binding:binding_index},binding._type==="tex")layout_entry.visibility=GPUShaderStage.FRAGMENT|GPUShaderStage.COMPUTE,layout_entry.texture={sampleType:"float",viewDimension:"2d",multisampled:!1},bg_entry.resource=binding._data._get_or_create_tex_view();else if(binding._type==="tex-array")layout_entry.visibility=GPUShaderStage.FRAGMENT|GPUShaderStage.COMPUTE,layout_entry.texture={sampleType:"float",viewDimension:"2d-array",multisampled:!1},bg_entry.resource=binding._data._get_or_create_tex_view();else if(binding._type==="tex-sampler")layout_entry.visibility=GPUShaderStage.FRAGMENT|GPUShaderStage.COMPUTE,layout_entry.sampler={},bg_entry.resource=binding._data.sampler;else if(binding._type==="uniform")layout_entry.visibility=GPUShaderStage.VERTEX|GPUShaderStage.FRAGMENT|GPUShaderStage.COMPUTE,layout_entry.buffer={type:"uniform",hasDynamicOffset:!1},bg_entry.resource={buffer:binding._data.buffer,offset:0,size:binding._data.struct_size};else if(binding._type==="uniform-list")layout_entry.visibility=GPUShaderStage.VERTEX|GPUShaderStage.FRAGMENT|GPUShaderStage.COMPUTE,layout_entry.buffer={type:"uniform",hasDynamicOffset:!0},this.n_dynamic_offsets+=1,bg_entry.resource={buffer:binding._data.buffer,offset:0,size:binding._data.struct_size};else if(binding._type==="storage")layout_entry.visibility=GPUShaderStage.FRAGMENT|GPUShaderStage.COMPUTE,layout_entry.buffer={type:"storage"},bg_entry.resource={buffer:binding._data.buffer,offset:0,size:binding._data.struct_size};else throw new Error(`Binding de tipo inv\xE1lido na posi\xE7\xE3o ${binding_index}`);desc_info+=binding._type+" ",layout_entries.push(layout_entry),bg_entries.push(bg_entry)}return this.bind_group_layout=this.context.device.createBindGroupLayout({entries:layout_entries}),this.bind_group=this.context.device.createBindGroup({layout:this.bind_group_layout,entries:bg_entries}),this.context.options.debug&&(desc_info=desc_info.trim(),console.log(`Binding Group criado: { ${desc_info}, dyn_offs=${this.n_dynamic_offsets} }`),console.log(this)),this.bind_group}gpu_send(){var binding,k,len,ref;for(ref=this.bindings,k=0,len=ref.length;k<len;k++)binding=ref[k],binding.gpu_send()}};globalThis.wgpu_binding_group__binding_type=wgpu_binding_group__binding_type;globalThis.wgpuBindingGroup_Format_Binding=wgpuBindingGroup_Format_Binding;globalThis.wgpuBindingGroup_Format_Group=wgpuBindingGroup_Format_Group2;globalThis.wgpuBindingGroup_Data_Group=wgpuBindingGroup_Data_Group2;var wgpuCamera2;wgpuCamera2=class{constructor(context){this.context=context,this.mat=use_mat4x4_format(),this.view=this.mat.identity(),this.proj=this.mat.identity(),this.eye=vec(0,0,5),this.center=vec(0,0,0),this.up=vec(0,1,0),this.proj_type="perspective",this.fov=60,this.aspect=this.context.canvas.width/this.context.canvas.height,this.near=.1,this.far=100,this.ortho_left=-1,this.ortho_right=1,this.ortho_bottom=-1,this.ortho_top=1,this.apply_proj_type=!1,this.apply_look_at=!1,this._arcball_last_mouse_pos=null,this.update_proj(),this.update_view()}get_proj(){return this.proj}get_view(){return this.view}perspective(fov,aspect,near,far){return this.proj_type="perspective",this.fov=fov,this.aspect=aspect,this.near=near,this.far=far,this.apply_proj_type=!0,this.update_proj()}orthographic(left,right,bottom,top,near,far){return this.proj_type="orthographic",this.ortho_left=left,this.ortho_right=right,this.ortho_bottom=bottom,this.ortho_top=top,this.near=near,this.far=far,this.apply_proj_type=!0,this.update_proj()}set_proj_type(type){if(type!=="perspective"&&type!=="ortographic")throw new Error("Tipo de proje\xE7\xE3o inv\xE1lida; deve ser 'perspective' ou 'ortographic'");return this.proj_type=type,this.update_proj()}update_proj(){if(this.apply_proj_type){if(this.proj_type==="perspective")return this.aspect=this.context.canvas.width/this.context.canvas.height,this.proj=this.mat.perspective(this.fov,this.aspect,this.near,this.far);if(this.proj_type==="orthographic")return this.proj=this.mat.orthographic(this.ortho_left,this.ortho_right,this.ortho_bottom,this.ortho_top,this.near,this.far)}}look_at(eye,center,up){return this.eye=eye,this.center=center,this.up=up,this.apply_look_at=!0,this.update_view()}update_view(){if(this.apply_look_at)return this.view=this.mat.look_at(this.eye,this.center,this.up)}get_forward(){var v2;return v2=this.center.sub(this.eye),v2.normalize(),v2}get_right(){var forward,right;return forward=this.get_forward(),right=forward.cross(this.up),right.normalize(),right}get_up(){var forward,right,up;return right=this.get_right(),forward=this.get_forward(),up=right.cross(forward),up.normalize(),up}move_forward(dist){var dir;return dir=this.get_forward().mul_by_scalar(dist),this.eye=this.eye.add(dir),this.center=this.center.add(dir),this.update_view()}move_backward(dist){return this.move_forward(-dist)}move_left(dist){return this.move_right(-dist)}move_right(dist){var dir;return dir=this.get_right().mul_by_scalar(dist),this.eye=this.eye.add(dir),this.center=this.center.add(dir),this.update_view()}move_up(dist){var dir;return dir=this.get_up().mul_by_scalar(dist),this.eye=this.eye.add(dir),this.center=this.center.add(dir),this.update_view()}move_down(dist){return this.move_up(-dist)}pitch_up(angle){return this._rotate_around_axis(this.get_right(),angle,!1)}pitch_down(angle){return this._rotate_around_axis(this.get_right(),-angle,!1)}turn_left(angle){return this._rotate_around_axis(this.get_up(),angle)}turn_right(angle){return this._rotate_around_axis(this.get_up(),-angle)}roll_left(angle){return this._rotate_around_axis(this.get_forward(),-angle)}roll_right(angle){return this._rotate_around_axis(this.get_forward(),angle)}_rotate_around_axis(axis,angle,recalc_up=!0){var R,dir,dir4,dirRot,up4,upRot;return R=this.mat.rotate(angle,axis.x,axis.y,axis.z),dir=this.center.sub(this.eye),dir4=vec(dir.x,dir.y,dir.z,0),dirRot=R.mul(dir4),this.center=this.eye.add(vec(dirRot.x,dirRot.y,dirRot.z)),recalc_up&&(up4=vec(this.up.x,this.up.y,this.up.z,0),upRot=R.mul(up4),this.up=vec(upRot.x,upRot.y,upRot.z).normalize()),this.update_view()}orbit_left(angle){var R,axis,dir,dir4,dirRot;return dir=this.eye.sub(this.center),axis=this.up.normalize(),R=this.mat.rotate(-angle,axis.x,axis.y,axis.z),dir4=vec(dir.x,dir.y,dir.z,0),dirRot=R.mul(dir4),this.eye=this.center.add(dirRot),this.update_view()}orbit_right(angle){return this.orbit_left(-angle)}orbit_up(angle){var R,dir,dir4,dirRot,forward,right,up4,upRot;return dir=this.eye.sub(this.center),forward=dir.normalize(),right=forward.cross(this.up).normalize(),R=this.mat.rotate(angle,right.x,right.y,right.z),dir4=vec(dir.x,dir.y,dir.z,0),dirRot=R.mul(dir4),this.eye=this.center.add(dirRot),up4=vec(this.up.x,this.up.y,this.up.z,0),upRot=R.mul(up4),this.up=vec(upRot.x,upRot.y,upRot.z).normalize(),this.update_view()}orbit_down(angle){return this.orbit_up(-angle)}_arcball_project_2d_to_sphere(x,y){var length,length_squared,nx,ny,screen_height,screen_width,z;return screen_width=this.context.canvas.width,screen_height=this.context.canvas.height,nx=2*x/screen_width-1,ny=1-2*y/screen_height,length_squared=nx*nx+ny*ny,z=0,length_squared<=1?z=Math.sqrt(1-length_squared):(length=Math.sqrt(length_squared),nx/=length,ny/=length,z=0),vec(nx,ny,z).normalize()}_arcball_calculate_rotation(p1,p2){var angle,axis,dot_product;return axis=p1.cross(p2),dot_product=p1.dp3(p2),angle=Math.acos(Math.max(-1,Math.min(1,dot_product))),axis.norm3()<1e-4?this.mat.identity():(angle=angle*180/Math.PI,axis=axis.normalize(),this.mat.rotate(-angle,axis.x,axis.y,axis.z))}_arcball_apply_rotation(rotation_matrix){var distance,rotated_up,rotated_view,view_vector;return view_vector=this.center.sub(this.eye),distance=view_vector.norm3(),rotated_view=rotation_matrix.mul(view_vector),rotated_up=rotation_matrix.mul(this.up),this.eye=this.center.sub(rotated_view),this.up=rotated_up.normalize()}arcball_mouse_down(mouse_x,mouse_y){return this._arcball_last_mouse_pos=this._arcball_project_2d_to_sphere(mouse_x,mouse_y)}arcball_mouse_move(mouse_x,mouse_y){var current_pos,rotation_matrix;return current_pos=this._arcball_project_2d_to_sphere(mouse_x,mouse_y),rotation_matrix=this._arcball_calculate_rotation(this._arcball_last_mouse_pos,current_pos),this._arcball_apply_rotation(rotation_matrix),this._arcball_last_mouse_pos=current_pos}arcball_left(step_angle){var rotation_matrix;return rotation_matrix=this.mat.rotate(-step_angle,this.up.x,this.up.y,this.up.z),this._arcball_apply_rotation(rotation_matrix)}arcball_right(step_angle){return this.arcball_left(-step_angle)}arcball_up(step_angle){var right,rotation_matrix,view_vector;return view_vector=this.center.sub(this.eye).normalize(),right=view_vector.cross(this.up).normalize(),rotation_matrix=this.mat.rotate(-step_angle,right.x,right.y,right.z),this._arcball_apply_rotation(rotation_matrix)}arcball_down(step_angle){return this.arcball_up(-step_angle)}};globalThis.wgpuCamera=wgpuCamera2;var wgpu_utils_calc_align2,wgpu_utils_calc_mipmap_levels2,wgpu_utils_fetch_text_from_url2;wgpu_utils_calc_align2=function(offset,field_alignment){return offset%field_alignment===0?offset:offset+field_alignment-offset%field_alignment};wgpu_utils_fetch_text_from_url2=function(url){return fetch(url).then(function(response){if(!response.ok)throw new Error(`Erro ao ler '${url}': ${response.status} ${response.statusText}`);return response.text()}).catch(function(err){throw new Error(`${err.message}`)})};wgpu_utils_calc_mipmap_levels2=function(width,height){return Math.floor(Math.log2(Math.max(width,height)))+1};globalThis.wgpu_utils_calc_align=wgpu_utils_calc_align2;globalThis.wgpu_utils_fetch_text_from_url=wgpu_utils_fetch_text_from_url2;globalThis.wgpu_utils_calc_mipmap_levels=wgpu_utils_calc_mipmap_levels2;var wgpuResources2;wgpuResources2=class{constructor(context){this.context=context,this._files=[],this._loaded=!1,this._url_groups=[],this._obj_list=null,this._tex_list=null}add_from_file(url){return this.add_from_files(url)}add_from_files(...urls){var end,endNum,i,j,k,len,match,newUrl,numStr,padLength,ref,ref1,start,startNum,url;for(j=0,len=urls.length;j<len;j++)if(url=urls[j],url[0]==="!")url=url.slice(1),this._files.push({url,data:null,img_bitmap:null,created_data:null});else if(match=url.match(/\[(\d+)-(\d+)\]/),match!=null)for(start=match[1],end=match[2],padLength=start.length,startNum=parseInt(start),endNum=parseInt(end),this._url_groups[url]=[],i=k=ref=startNum,ref1=endNum;k<=ref1;i=k+=1)numStr=i.toString().padStart(padLength,"0"),newUrl=url.replace(/\[\d+-\d+\]/,numStr),this._files.push({url:newUrl,data:null,img_bitmap:null,created_data:null,url_group:url}),this._url_groups[url].push(newUrl);else this._files.push({url,data:null,img_bitmap:null,created_data:null})}async load_all(){var byte_size,f,j,len,n,promises,ref,results;if(promises=this._files.map(f2=>fetch(f2.url).then(r=>{if(!r.ok)throw new Error(`Erro ao carregar ${f2.url}`);return r.arrayBuffer()}).then(function(data){return f2.data=data})),await Promise.all(promises),this._loaded=!0,await this._load_all_imgs(),this.context.options.debug){for(n=this._files.length,console.log(`Resources: ${n} arquivos carregados`),ref=this._files,results=[],j=0,len=ref.length;j<len;j++)f=ref[j],byte_size=f.data.byteLength,f.img_bitmap!=null?results.push(console.log(`- ${f.url} carregado ok, ${f.img_bitmap.width}x${f.img_bitmap.height} pixels, ${Math.round(byte_size/1024)} KB (${byte_size} bytes)`)):results.push(console.log(`- ${f.url} carregado ok, ${Math.round(byte_size/1024)} KB (${byte_size} bytes)`));return results}}async _load_all_imgs(){var blob,file,j,len,ref;for(ref=this._files,j=0,len=ref.length;j<len;j++)file=ref[j],this._is_file_image(file.url)&&(blob=new Blob([file.data]),file.img_bitmap=await createImageBitmap(blob))}_is_file_image(url){return this._file_has_extension(url,".png",".jpg",".jpeg",".bmp")}_file_has_extension(url,...exts){var ext,extLower,j,len,urlLower;if(!(url&&typeof url=="string"))return!1;for(urlLower=url.toLowerCase(),j=0,len=exts.length;j<len;j++)if(ext=exts[j],extLower=ext.toLowerCase().replace(/^\./,""),urlLower.endsWith(`.${extLower}`))return!0;return!1}files_by_extension(...exts){var exts2;return exts2=exts.map(function(e){return e.toLowerCase()}),this._files.filter(function(f){var url;return url=f.url.toLowerCase(),exts2.some(function(ext){return url.endsWith(ext)})}).map(function(f){return f.url})}obj_files(){return this.files_by_extension(".txt2",".ply",".obj")}tex_files(){return this.files_by_extension(".png",".jpg",".jpeg",".bmp")}shader_files(){return this.files_by_extension(".wgsl")}_get_item(url){var f;if(f=this._files.find(function(f2){return f2.url===url}),f==null)throw new Error(`Recurso n\xE3o encontrado/carregado: ${url}`);return f}obj(url,vertex_format=null){var created_obj,f,s,text,tipo;if(f=this._get_item(url),f.created_data!=null)return f.created_data;if(text=this.text(url),s=url.toLowerCase(),s.endsWith(".txt2"))tipo="txt2";else if(s.endsWith(".ply"))tipo="ply";else if(s.endsWith(".obj"))tipo="obj";else throw new Error(`Tipo inv\xE1lido de objeto: ${url}`);return created_obj=this.context.obj_from_text(text,tipo,vertex_format),f.created_data=created_obj,created_obj}tex(url){var created_tex,f;return f=this._get_item(url),f.created_data!=null?f.created_data:(created_tex=this.context.tex_from_image(this.image_bitmap(url)),created_tex.filename=created_tex.url=url,created_tex.url_group=f.url_group,f.created_data=created_tex,created_tex)}obj_list(vertex_format=null){var j,len,url,urls;if(this._obj_list!=null)return this._obj_list;for(this._obj_list=[],urls=this.obj_files(),j=0,len=urls.length;j<len;j++)url=urls[j],this._obj_list.push(this.obj(url,vertex_format));return this._obj_list}obj_by_url(url,vertex_format=null){return this.obj(url,vertex_format)}obj_by_index(i,vertex_format=null){var objs;return objs=this.obj_list(vertex_format),objs[i]}tex_list(){var j,len,url,urls;if(this._tex_list!=null)return this._tex_list;for(this._tex_list=[],urls=this.tex_files(),j=0,len=urls.length;j<len;j++)url=urls[j],this._tex_list.push(this.tex(url));return this._tex_list}tex_by_url(url){return this.tex(url)}tex_by_index(i){return this.tex_list()[i]}tex_list_by_urls(...urls){var j,len,lst,url;for(lst=[],j=0,len=urls.length;j<len;j++)url=urls[j],lst.push(this.tex_by_url(url));return lst}materials_from_tex_list(opts=null,tex_sampler=null){var data_groups,g,j,len,t,tex_index,tex_list,tex_sampler_index,ts;for(tex_index=null,opts!=null&&(tex_index=opts.tex,opts.tex_sampler!=null?tex_sampler_index=opts.tex_sampler:tex_sampler_index=opts["tex-sampler"]),tex_index==null&&(tex_index=0),tex_sampler_index||(tex_sampler_index=1),ts=tex_sampler,ts==null&&(ts=this.context.tex_sampler("linear")),data_groups=[],tex_list=this.tex_list(),j=0,len=tex_list.length;j<len;j++)t=tex_list[j],g=this.context.shader_data_group(),g.binding(tex_index).set_tex(t),g.binding(tex_sampler_index).set_tex_sampler(ts),g.url=t.url,g.url_group=t.url_group,data_groups.push(g);return data_groups.get_by_url=function(url){return this.find(function(item){return item.url===url})},data_groups.get_by_urls=function(...urls){var its,k,len1,url;for(its=[],k=0,len1=urls.length;k<len1;k++)url=urls[k],its.push(this.get_by_url(url));return its},data_groups.get_all_by_url_group=function(url_group){var frames,item,k,len1,ref;for(frames=[],ref=this,k=0,len1=ref.length;k<len1;k++)item=ref[k],item.url_group===url_group&&frames.push(item);return frames},data_groups}get_url_group(url_group){return this._url_groups[url_group]}get_url_group_item(url_group,i){return this._url_groups[url_group][i]}get_url_group_random_item(url_group){var i,n;return n=this._url_groups[url_group].length,i=random(0,n-1),this._url_groups[url_group][i]}get_url_group_item_count(url_group){return this._url_groups[url_group].length}storage_from_float_array(url){var num_array;return num_array=this.float_array(url),this.context.storage_from_float_array(num_array)}storage_from_int_array(url){var num_array;return num_array=this.int_array(url),this.context.storage_from_int_array(num_array)}data(url){return this._get_item(url).data}text(url){var data;return data=this.data(url),new TextDecoder().decode(data)}src(url){return this.text(url)}lines(url){var txt;return txt=this.text(url),txt.trim().split(/\r?\n/)}json(url){return JSON.parse(this.text(url))}blob(url){return new Blob([this.data(url)])}base64(url){var bytes;return bytes=new Uint8Array(this.data(url)),btoa(String.fromCharCode(...bytes))}image_bitmap(url){var f;if(f=this._get_item(url),f.img_bitmap==null)throw new Error(`URL inesperada para imagem: ${url}`);return f.img_bitmap}float_array(url){return this.lines(url).map(function(line){return parseFloat(line)})}int_array(url){return this.lines(url).map(function(line){return parseInt(line)})}vec_array(url){return this.lines(url).map(function(line){var nums;switch(nums=line.trim().split(/[\s,]+/).map(parseFloat),nums.length){case 2:return vec(nums[0],nums[1]);case 3:return vec(nums[0],nums[1],nums[2]);case 4:return vec(nums[0],nums[1],nums[2],nums[3]);default:throw new Error(`Linha inv\xE1lida: ${line}`)}})}mat2x2(url){var lines,row1,row2;if(lines=this.lines(url),lines.length<2)throw new Error("Esperado: 2 linhas para mat2x2");if(row1=lines[0].trim().split(/[\s,]+/).map(parseFloat),row2=lines[1].trim().split(/[\s,]+/).map(parseFloat),row1.length!==2||row2.length!==2)throw new Error("N\xFAmero inv\xE1lido de elementos nas linhas para mat2x2");return new Mat2x2(row1[0],row1[1],row2[0],row2[1])}mat3x3(url){var lines,rows;if(lines=this.lines(url),lines.length<3)throw new Error("Esperado: 3 linhas para mat3x3");return rows=lines.slice(0,3).map(function(line){var nums;if(nums=line.trim().split(/[\s,]+/).map(parseFloat),nums.length!==3)throw new Error(`N\xFAmero inv\xE1lido de elementos na linha: ${line}`);return nums}),new Mat3x3(rows[0][0],rows[0][1],rows[0][2],rows[1][0],rows[1][1],rows[1][2],rows[2][0],rows[2][1],rows[2][2])}mat4x4(url){var lines,rows;if(lines=this.lines(url),lines.length<4)throw new Error("Esperado: 4 linhas para mat4x4");return rows=lines.slice(0,4).map(function(line){var nums;if(nums=line.trim().split(/[\s,]+/).map(parseFloat),nums.length!==4)throw new Error(`N\xFAmero inv\xE1lido de elementos na linha: ${line}`);return nums}),new Mat4x4(rows[0][0],rows[0][1],rows[0][2],rows[0][3],rows[1][0],rows[1][1],rows[1][2],rows[1][3],rows[2][0],rows[2][1],rows[2][2],rows[2][3],rows[3][0],rows[3][1],rows[3][2],rows[3][3])}};globalThis.wgpuResources=wgpuResources2;var wgpuInstance,wgpuInstanceList2,wgpuInstance_Animation;wgpuInstance_Animation=class{constructor(instance1,url_group,materials,opts){if(this.update=this.update.bind(this),this.instance=instance1,opts!=null&&(this.fps=opts.fps,this.repeat=opts.repeat,this._on_animation_end=opts.on_animation_end),this.fps==null&&(this.fps=10),this.repeat==null&&(this.repeat=!1),this._material_frames=materials.get_all_by_url_group(url_group),this._material_frames.length===0)throw new Error(`Anima\xE7\xE3o: n\xE3o foram encontrados itens para: ${url_group}`);this.totalFrames=this._material_frames.length,this.frameTime=1e3/this.fps,this.currentFrame=0,this.lastTime=null,this.isRunning=!0,this.lastTime=performance.now(),this._update_material()}get_frame(){return this.currentFrame}get_frame_material(){return this._material_frames[this.currentFrame]}_update_material(){return this.instance.use_material(this._material_frames[this.currentFrame])}update(){var currentTime,delta,terminou;if(this.isRunning&&(currentTime=performance.now(),delta=currentTime-this.lastTime,terminou=!1,delta>=this.frameTime&&(this.currentFrame++,this.lastTime=currentTime,this.currentFrame>=this.totalFrames&&(this.repeat?this.currentFrame=0:(this.currentFrame=this.totalFrames-1,terminou=!0,this.isRunning=!1)),this._update_material()),terminou&&this._on_animation_end!=null))return this._on_animation_end(this.instance)}};wgpuInstance=class wgpuInstance2{constructor(instance_list,obj1,pipeline=null,material=null){this.instance_list=instance_list,this.obj=obj1,this.using_pipeline=pipeline,this.using_material_data_group=material,this.using_transparency=!1,this.visible=!0,this.uniform_index=this.instance_list.malloc_uniform_item(),this.instance_list._instances.push(this),this.instance_list._invalidate_prepare(),this._id="",this._class="",this._obj_aabb=null,this._obj_aabb_verts=null,this._obj_sphere=null,this._animation=null}get_obj(){return this.obj}use_transparency(flag){return this.using_transparency=flag,this.instance_list._invalidate_prepare()}use_pipeline(pipeline){return this.using_pipeline=pipeline,this.instance_list._invalidate_prepare()}use_material(data_group){return this.using_material_data_group=data_group,this.instance_list._invalidate_prepare()}set_id(id){return this._id=id}get_id(){return this._id}set_class(cl){return this._class=cl}get_class(){return this._class}show(){return this.visible=!0,this.instance_list._invalidate_prepare()}hide(){return this.visible=!1,this.instance_list._invalidate_prepare()}remove(){var i;return this.instance_list.free_uniform_item(this.uniform_index),i=this.instance_list._instances.indexOf(this),i!==-1&&this.instance_list._instances.splice(i,1),this.instance_list._invalidate_prepare()}dup(){var copia;return copia=new wgpuInstance2(this.instance_list,this.obj),copia.using_pipeline=this.using_pipeline,copia.using_transparency=this.using_transparency,copia.using_material_data_group=this.using_material_data_group,copia.visible=this.visible,copia._class=this._class,copia}get_uniform_index(){return this.uniform_index}get_uniform_data(){var i;return i=this.uniform_index,this.instance_list._uniform_list.get_item_data(i)}get_aabb(model_matrix){var max_x,max_y,max_z,min_x,min_y,min_z,transformed_verts,v2,vert;return this._obj_aabb==null&&(this._obj_aabb=this.obj.get_aabb(),this._obj_aabb_verts=this._obj_aabb.get_verts()),transformed_verts=function(){var j,len,ref,results;for(ref=this._obj_aabb_verts,results=[],j=0,len=ref.length;j<len;j++)vert=ref[j],results.push(model_matrix.mul(vert));return results}.call(this),min_x=Math.min(...function(){var j,len,results;for(results=[],j=0,len=transformed_verts.length;j<len;j++)v2=transformed_verts[j],results.push(v2.x);return results}()),min_y=Math.min(...function(){var j,len,results;for(results=[],j=0,len=transformed_verts.length;j<len;j++)v2=transformed_verts[j],results.push(v2.y);return results}()),min_z=Math.min(...function(){var j,len,results;for(results=[],j=0,len=transformed_verts.length;j<len;j++)v2=transformed_verts[j],results.push(v2.z);return results}()),max_x=Math.max(...function(){var j,len,results;for(results=[],j=0,len=transformed_verts.length;j<len;j++)v2=transformed_verts[j],results.push(v2.x);return results}()),max_y=Math.max(...function(){var j,len,results;for(results=[],j=0,len=transformed_verts.length;j<len;j++)v2=transformed_verts[j],results.push(v2.y);return results}()),max_z=Math.max(...function(){var j,len,results;for(results=[],j=0,len=transformed_verts.length;j<len;j++)v2=transformed_verts[j],results.push(v2.z);return results}()),new AABB(vec(min_x,min_y,min_z),vec(max_x,max_y,max_z))}get_sphere(model_matrix){var center,max_scale,r,scale_x,scale_y,scale_z;return this._obj_sphere==null&&(this._obj_sphere=this.obj.get_sphere()),center=model_matrix.mul(this._obj_sphere.center),scale_x=model_matrix.get_col_vec(0).length(),scale_y=model_matrix.get_col_vec(1).length(),scale_z=model_matrix.get_col_vec(2).length(),max_scale=Math.max(scale_x,scale_y,scale_z),r=this._obj_sphere.r*max_scale,new Sphere(center,r)}start_animation_from_materials(url_group,materials,opts){return this._animation=new wgpuInstance_Animation(this,url_group,materials,opts)}};wgpuInstanceList2=class{constructor(context){this.context=context,this._instances=[],this._cur_pipeline=null,this._use_groups={global_index:0,global_group:null,material_index:1,instance_index:2,instance_group:null,instance_group_binding_of_uniform_list:null},this._uniform_list=null,this._used_indices=[],this._free_indices=[],this._need_prepare=!0,this._render_list={visible_lisit:[],opaque_list:null,transparency_list:null},this._update_list=[]}use_pipeline(p){return this._cur_pipeline=p}instance(obj,opts){var use_material,use_pipeline;return use_pipeline=null,use_material=null,opts!=null&&(use_pipeline=opts.pipeline,use_material=opts.material),use_pipeline==null&&(use_pipeline=this._cur_pipeline),new wgpuInstance(this,obj,use_pipeline,use_material)}remove(instance){return instance.remove()}instances(){return this._instances}use_groups(opts){if(opts.global_index!=null&&opts.global_group!=null&&this._use_global_group(opts.global_index,opts.global_group),opts.material_index!=null&&this._use_material_group(opts.material_index),opts.instance_index==null||opts.instance_group==null)throw new Error("Faltando campo instance_index ou instance_group");return this._use_instance_group(opts.instance_index,opts.instance_group)}_use_global_group(i,g){return this._use_groups.global_index=i,this._use_groups.global_group=g}_use_material_group(i){return this._use_groups.material_index=i}_use_instance_group(i,g,binding_of_uniform_list=null){var N;if(this._use_groups.instance_index=i,this._use_groups.instance_group=g,binding_of_uniform_list==null&&(binding_of_uniform_list=g.binding_find("uniform-list"),binding_of_uniform_list===-1))throw new Error("Esperado group com uniform-list");return this._use_groups.instance_group_binding_of_uniform_list=binding_of_uniform_list,this._uniform_list=g.binding(binding_of_uniform_list).get_uniform_list(),N=this._uniform_list.count,this._used_indices=new Set([]),this._free_indices=new Set(function(){for(var results=[],j=0;0<=N?j<N:j>N;0<=N?j++:j--)results.push(j);return results}.apply(this))}get_instance_by_id(id){var inst,j,len,ref;for(ref=this._instances,j=0,len=ref.length;j<len;j++)if(inst=ref[j],inst._id===id)return inst;throw new Error(`Inst\xE2ncia com id ${id} n\xE3o encontrada`)}get_instances_by_class(cl){var inst,j,len,ref,t;for(t=[],ref=this._instances,j=0,len=ref.length;j<len;j++)inst=ref[j],inst._class===cl&&t.push(inst);return t}get_instance(i){return this._instances[i]}get_all(obj=null){return obj!=null?this._instances.filter(function(inst){return inst.obj===obj}):this._instances}get_all_using_pipeline(pipeline,of_instance_list=null){var list;return list=of_instance_list??this._instances,list.filter(function(inst){return inst.using_pipeline===pipeline})}get_all_using_transparency(use_transparency=!0,of_instance_list=null){var list;return list=of_instance_list??this._instances,list.filter(function(inst){return inst.using_transparency===use_transparency})}get_all_visible(visible=!0,of_instance_list=null){var list;return list=of_instance_list??this._instances,list.filter(function(inst){return inst.visible===visible})}get_uniform_list_used_indices(){return this._used_indices}get_uniform_list_free_indices(){return this._free_indices}malloc_uniform_item(){var index;if(this._free_indices.length===0)throw new Error("Limite esgotado: n\xE3o h\xE1 \xEDndices livres dispon\xEDveis no uniform list");return index=Math.min(...this._free_indices),this._free_indices.delete(index),this._used_indices.add(index),index}free_uniform_item(index){if(this._used_indices.has(index))return this._used_indices.delete(index),this._free_indices.add(index);throw new Error(`\xCDndice n\xE3o existente: ${index}`)}_invalidate_prepare(){return this._need_prepare=!0}_prepare(){var opaque_list,transparency_list;this._need_prepare&&(this._need_prepare=!1,this._render_list.visible_list=this.get_all_visible(!0),opaque_list=this.get_all_using_transparency(!1,this._render_list.visible_list),transparency_list=this.get_all_using_transparency(!0,this._render_list.visible_list),this._render_list.opaque_list={pipelines:this._prepare_sublist(opaque_list),instances:opaque_list},this._render_list.transparency_list={pipelines:this._prepare_sublist(transparency_list),instances:transparency_list})}_prepare_sublist(ls){var group,group_item,pipeline,pipeline_item,pipeline_map,ref,x,y;pipeline_map=this._sort_by_pipeline(ls);for(x of pipeline_map){[pipeline,pipeline_item]=x,pipeline_item.groups=this._sort_by_group(pipeline_item.instances),ref=pipeline_item.groups;for(y of ref)[group,group_item]=y,group_item.objs=this._sort_by_obj(group_item.instances)}return pipeline_map}_sort_by_pipeline(ls){var instance,j,len,pipeline,pipeline_map;for(pipeline_map=new Map,j=0,len=ls.length;j<len;j++)instance=ls[j],pipeline=instance.using_pipeline,pipeline_map.has(pipeline)||pipeline_map.set(pipeline,{groups:null,instances:[]}),pipeline_map.get(pipeline).instances.push(instance);return pipeline_map}_sort_by_group(ls){var gr,group_map,instance,j,len;for(group_map=new Map,j=0,len=ls.length;j<len;j++)instance=ls[j],instance.using_material_data_group===null?gr="default":gr=instance.using_material_data_group,group_map.has(gr)||group_map.set(gr,{instances:[],objs:null}),group_map.get(gr).instances.push(instance);return group_map}_sort_by_obj(ls){var instance,j,len,obj,obj_map;for(obj_map=new Map,j=0,len=ls.length;j<len;j++)instance=ls[j],obj=instance.obj,obj_map.has(obj)||obj_map.set(obj,{instances:[]}),obj_map.get(obj).instances.push(instance);return obj_map}_add_to_update_list(t){return this._update_list.push(t)}_render_on_job(job){var j,len,ref,t;for(this._prepare(),ref=this._update_list,j=0,len=ref.length;j<len;j++)t=ref[j],t.update();this._use_groups.global_group!=null&&job.render_use_group(this._use_groups.global_index,this._use_groups.global_group),this._render_on_job_sublist(job,this._render_list.opaque_list),this._render_on_job_sublist(job,this._render_list.transparency_list)}_render_on_job_sublist(job,ls){var b1,b2,b3,group,group_item,igr,igr_msg,iinst,instance,iobj,iobj_msg,ipip,ipip_msg,j,len,obj,obj_item,offset,pipeline,pipeline_item,ref,ref1,ref2,ref3,x,y,z;ipip=0,ref=ls.pipelines;for(x of ref){[pipeline,pipeline_item]=x,ipip_msg="["+pipeline._label+"]",ipip++,job.render_pass.setPipeline(pipeline.pipeline),igr=0,ref1=pipeline_item.groups;for(y of ref1){[group,group_item]=y,igr_msg="",group==="default"?igr_msg="[default]":igr_msg="["+group._label+"]",igr++,group!=="default"&&job.render_use_group(this._use_groups.material_index,group),iobj=0,ref2=group_item.objs;for(z of ref2)for([obj,obj_item]=z,iobj_msg="["+obj._label+"] ",iobj++,job.render_pass.setVertexBuffer(0,obj.vbuf),obj.ibuf!=null&&job.render_pass.setIndexBuffer(obj.ibuf,"uint32"),iinst=0,ref3=obj_item.instances,j=0,len=ref3.length;j<len;j++)instance=ref3[j],iinst++,offset=instance.uniform_index*this.context.uniform_buffer_size_per_item,b1=this._use_groups.instance_index,b2=this._use_groups.instance_group._get_or_create_binding_group(),b3=Array(this._use_groups.instance_group.n_dynamic_offsets).fill(offset),job.render_pass.setBindGroup(b1,b2,b3),obj.ibuf!=null?job.render_pass.drawIndexed(obj.index_count):job.render_pass.draw(obj.vertex_count),instance._animation!=null&&instance._animation.update()}}}};globalThis.wgpuInstance=wgpuInstance;globalThis.wgpuInstanceList=wgpuInstanceList2;var wgpuParticleSystem2;wgpuParticleSystem2=class{constructor(ls){this.ls=ls,this.context=this.ls.context,this.ls._add_to_update_list(this),this._build_quad(),this.particles=[],this.particle_class="particle",this.last_time=time(),this.emission_timer=0,this._pipeline_random_list=[],this._material_random_list=[],this.config={speed:.2,max_particles:50,emission_rate:5,is_emitting:!1,pos:vec(0,0,0),vel:vec(0,1,0),vel_variation:1.5,forces:vec(0,0,0),turbulence_strength:5,attraction_repulsion_strength:0,attraction_repulsion__max_distance:5,default_per_particle:{vel_factor:.99,size_start:.2,size_end:0,color_list:[rgb(1,0,0,1),rgb(1,.5,0,.8),rgb(0,0,0,0)],ang_start_random:360,ang_vel_random:50,age_min:1,age_max:2}}}_build_quad(){var indices,vdata;return vdata=[-.5,-.5,0,1,0,0,1,0,1,.5,-.5,0,0,1,0,1,1,1,.5,.5,0,0,0,1,1,1,0,-.5,.5,0,1,1,0,1,0,0],indices=[0,1,2,2,3,0],this.obj_quad=this.context.obj_from_data(vdata,indices)}set_config(config){return this.config=config}get_config(){return this.config}use_pipeline(pipeline){return this._pipeline_random_list=[pipeline]}use_material(material){return this._material_random_list=[material]}use_pipeline_from_random_list(pipelines){return this._pipeline_random_list=pipelines.slice()}use_material_from_random_list(materials){return this._material_random_list=materials.slice()}set_all_pipeline(pipeline){var j,len,p,ref,results;for(this._pipeline_random_list=[pipeline],ref=this.particles,results=[],j=0,len=ref.length;j<len;j++)p=ref[j],results.push(p.use_pipeline(pipeline));return results}set_all_material(material){var j,len,p,ref,results;for(this._material_random_list=[material],ref=this.particles,results=[],j=0,len=ref.length;j<len;j++)p=ref[j],results.push(p.use_material(material));return results}emit(config={}){var N,i,j,ref;for(N=this.config.emission_rate,i=j=0,ref=N-1;j<=ref&&this.particles.length<this.config.max_particles;i=j+=1)this.emit_particle(config)}update(){var current_time,delta_time,j,len,particle,ref;for(current_time=time(),delta_time=current_time-this.last_time,delta_time*=this.config.speed,this.last_time=current_time,ref=this.particles,j=0,len=ref.length;j<len;j++)particle=ref[j],particle.alive?this.update_particle(particle,delta_time):this.kill_particle(particle);if(this.particles=this.particles.filter(function(p){return p.alive}),this.config.is_emitting&&(this.emission_timer+=delta_time,this.emission_timer>=1/this.config.emission_rate&&this.particles.length<this.config.max_particles))return this.emit_particle(),this.emission_timer=0}_interacao_com_outras_particulas(p1,delta_time){var diff,dir,distance,fator_attraction,force,j,len,p2,ref,size_factor,total_force;for(total_force=vec(0,0,0),ref=this.particles,j=0,len=ref.length;j<len;j++)p2=ref[j],!(p2===p1||!p2.alive)&&(diff=p2.pos.sub(p1.pos),distance=diff.length()||0,!(distance>this.config.attraction_repulsion__max_distance)&&(dir=diff.normalize(),size_factor=p2.size/p1.size||1,this.config.attraction_repulsion_strength!==0&&(fator_attraction=this.config.attraction_repulsion_strength/distance*size_factor,force=dir.mul(fator_attraction),total_force=total_force.add(force))));return p1.accel=p1.accel.add(total_force.mul(delta_time))}_set_particle_pipeline_and_material(particle){var mt,pip;if(this._pipeline_random_list.length>0&&(pip=random_choice(this._pipeline_random_list),particle.use_pipeline(pip)),this._material_random_list.length>0)return mt=random_choice(this._material_random_list),particle.use_material(mt)}emit_particle(config={}){var base_vel_dir,base_vel_len,cfg,particle,vel_dir;return particle=this.ls.instance(this.obj_quad),particle.set_class(this.particle_class),this._set_particle_pipeline_and_material(particle),cfg={},cfg.emission_rate=config.emission_rate!=null?config.emission_rate:this.config.emission_rate,cfg.pos=config.pos!=null?config.pos:this.config.pos,cfg.vel=config.vel!=null?config.vel:this.config.vel,cfg.vel_variation=config.vel_variation!=null?config.vel_variation:this.config.vel_variation,cfg.vel_factor=config.vel_factor!=null?config.vel_factor:this.config.default_per_particle.vel_factor,cfg.size_start=config.size_start!=null?config.size_start:this.config.default_per_particle.size_start,cfg.size_end=config.size_end!=null?config.size_end:this.config.default_per_particle.size_end,cfg.color_list=config.color_list!=null?config.color_list:this.config.default_per_particle.color_list,cfg.ang_start_random=config.ang_start_random!=null?config.ang_start_random:this.config.default_per_particle.ang_start_random,cfg.ang_vel_random=config.ang_vel_random!=null?config.ang_vel_random:this.config.default_per_particle.ang_vel_random,cfg.age_min=config.age_min!=null?config.age_min:this.config.default_per_particle.age_min,cfg.age_max=config.age_max!=null?config.age_max:this.config.default_per_particle.age_max,particle.pos=cfg.pos.dup(),base_vel_dir=cfg.vel.normalize(),base_vel_len=cfg.vel.length(),vel_dir=base_vel_dir.add(vec_random().mul(cfg.vel_variation)).normalize(),particle.vel=vel_dir.mul(base_vel_len),particle.accel=vec(0,0,0),particle.vel_factor=cfg.vel_factor,particle.size_start=cfg.size_start,particle.size_end=cfg.size_end,particle.size=cfg.size_start,particle.color_list=cfg.color_list,particle.color=cfg.color_list[0],particle.ang=random_float(random(cfg.ang_start_random)),particle.ang_vel=random_float(-cfg.ang_vel_random/2,+cfg.ang_vel_random/2),particle.age=0,particle.age_max=random_float(cfg.age_min,cfg.age_max),particle.alive=!0,this.particles.push(particle),particle}update_particle(particle,delta_time){var t,turbulence_force;if(particle.alive){if(particle.age+=delta_time,particle.age>=particle.age_max){this.kill_particle(particle);return}return t=particle.age/particle.age_max,particle.size=lerp(particle.size_start,particle.size_end,t),particle.color=list_lerp(particle.color_list,t),particle.accel=vec(0,0,0),particle.accel=particle.accel.add(this.config.forces),this.config.turbulence_strength>0&&(turbulence_force=vec_random().mul(this.config.turbulence_strength),particle.accel=particle.accel.add(turbulence_force)),this._interacao_com_outras_particulas(particle,delta_time),particle.vel=particle.vel.add(particle.accel.mul(delta_time)),particle.vel=particle.vel.mul(particle.vel_factor),particle.pos=particle.pos.add(particle.vel.mul(delta_time)),particle.ang+=particle.ang_vel*delta_time}}kill_particle(particle){return particle.alive=!1,particle.remove()}clear_particles(){var j,len,particle,ref;for(ref=this.particles,j=0,len=ref.length;j<len;j++)particle=ref[j],kill_particle(particle);return this.particles=[]}dump(){var col,color_list_s,j,len,ref,s;for(console.log("ParticleSystem - dump:"),color_list_s=`[ 
`,ref=this.config.default_per_particle.color_list,j=0,len=ref.length;j<len;j++)col=ref[j],color_list_s+="      rgb("+col.data+`)
`;return color_list_s+="    ]",s=`config =
  speed: ${this.config.speed}
  max_particles: ${this.config.max_particles}
  emission_rate: ${this.config.emission_rate}
  is_emitting: ${this.config.is_emitting}
  pos: vec(${this.config.pos.data})
  vel: vec(${this.config.vel.data})
  vel_variation: ${this.config.vel_variation}
  forces: vec(${this.config.forces.data})
  turbulence_strength: ${this.config.turbulence_strength}
  attraction_repulsion_strength: ${this.config.attraction_repulsion_strength}
  attraction_repulsion__max_distance: ${this.config.attraction_repulsion__max_distance}
  default_per_particle: 
    vel_factor: ${this.config.default_per_particle.vel_factor} 
    size_start: ${this.config.default_per_particle.size_start} 
    size_end: ${this.config.default_per_particle.size_end} 
    color_list: ${color_list_s} 
    ang_start_random: ${this.config.default_per_particle.ang_start_random} 
    ang_vel_random: ${this.config.default_per_particle.ang_vel_random} 
    age_min: ${this.config.default_per_particle.age_min} 
    age_max: ${this.config.default_per_particle.age_max} 
`,console.log(s)}};globalThis.wgpuParticleSystem=wgpuParticleSystem2;var Mat2x22,Mat2x2_format2,Mat3x32,Mat3x3_format2,Mat4x42,Mat4x4_format2,Quaternion2,Vec42,flat_array_from_values,mat_mul2,quaternion_from_axis_angle,quaternion_from_mat4x4,vec_from_array,vec_random2,vec_to_array;flat_array_from_values=function(...args){var array_flat;if(array_flat=null,args.length===0)throw new Error("Nenhum argumento passado");if(typeof args[0]=="number")array_flat=args;else if(args.length===1&&Array.isArray(args[0]))array_flat=args[0].flat();else throw new Error("Formato inv\xE1lido de valores");return array_flat};Mat2x2_format2=class{constructor(){}mat(...args){var m;return m=new Mat2x22(args),m}identity(){var m;return m=new Mat2x22([1,0,0,1]),m}rotate(a){var m;return m=new Mat2x22,m.rotate(a),m}scale(sx,sy){var m;return m=new Mat2x22,m.scale(sx,sy),m}mul(...args){return mat_mul2(...args)}inv(m){return m.inv()}};Mat3x3_format2=class{constructor(){}mat(...args){var m;return m=new Mat3x32(args),m}identity(){var m;return m=new Mat3x32([1,0,0,0,1,0,0,0,1]),m}rotate(a){var m;return m=new Mat3x32,m.rotate(a),m}scale(sx,sy){var m;return m=new Mat3x32,m.scale(sx,sy),m}translate(dx,dy){var m;return m=new Mat3x32,m.translate(dx,dy),m}mul(...args){return mat_mul2(...args)}inv(m){return m.inv()}};Mat4x4_format2=class{constructor(){}mat(...args){var m;return m=new Mat4x42(args),m}identity(){var m;return m=new Mat4x42([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),m}rotate(a,x,y,z){var m;return m=new Mat4x42,m.rotate(a,x,y,z),m}rotateX(a){var m;return m=new Mat4x42,m.rotateX(a),m}rotateY(a){var m;return m=new Mat4x42,m.rotateY(a),m}rotateZ(a){var m;return m=new Mat4x42,m.rotateZ(a),m}scale(sx,sy,sz){var m;return m=new Mat4x42,m.scale(sx,sy,sz),m}translate(dx,dy,dz){var m;return m=new Mat4x42,m.translate(dx,dy,dz),m}mul(...args){return mat_mul2(...args)}inv(m){return m.inv()}perspective(fovy,aspect,near,far,fovy_in_deg=!0,webgpu=!0){var m;return m=new Mat4x42,m.perspective(fovy,aspect,near,far,fovy_in_deg,webgpu),m}orthographic(left,right,bottom,top,near,far,webgpu=!0){var m;return m=new Mat4x42,m.orthographic(left,right,bottom,top,near,far,webgpu),m}look_at(eye,center,up){var m;return m=new Mat4x42,m.look_at(eye,center,up),m}};Mat2x22=class Mat2x23{constructor(data=[1,0,0,1]){if(this.data=flat_array_from_values(data),this.data.length!==4)throw new Error(`Esperada matriz 2x2 de 4 elementos: '${this.data}' tem ${this.data.length} elementos`)}identity(){return this.data=[1,0,0,1]}zero(){return this.data=[0,0,0,0]}copy_from(outra){return this.data=[outra.data[0],outra.data[1],outra.data[2],outra.data[3]]}rotate(a){var c2,s;if(isNaN(a))throw new Error(`rotate: argumento(s) inv\xE1lido(s): ${a}`);return a=a*(Math.PI/180),s=Math.sin(a),c2=Math.cos(a),this.data=[c2,-s,s,c2]}scale(sx,sy){if(isNaN(sx)||isNaN(sy))throw new Error(`scale: argumento(s) inv\xE1lido(s): ${sx}, ${sy}`);return this.data=[sx,0,0,sy]}add(outro){var i,l,nova;for(nova=[],i=l=0;l<=3;i=++l)nova[i]=this.data[i]+outro.data[i];return new Mat2x23(nova)}sub(outro){var i,l,nova;for(nova=[],i=l=0;l<=3;i=++l)nova[i]=this.data[i]-outro.data[i];return new Mat2x23(nova)}mul(outro){var _,a,b,c2,d,e,f,g,h,resultado,x,y;return outro instanceof Vec42?([a,b,c2,d]=this.data,[x,y,_,_]=outro.data,new Vec42(a*x+b*y,c2*x+d*y)):([a,b,c2,d]=this.data,[e,f,g,h]=outro.data,resultado=[a*e+b*g,a*f+b*h,c2*e+d*g,c2*f+d*h],new Mat2x23(resultado))}add_with(outro){var i,l,results;for(results=[],i=l=0;l<=3;i=++l)results.push(this.data[i]+=outro.data[i]);return results}mul_with(outro){var a,b,c2,d,e,f,g,h;return[a,b,c2,d]=outro.data,[e,f,g,h]=this.data,this.data=[a*e+b*g,a*f+b*h,c2*e+d*g,c2*f+d*h]}neg(){var i,l,nova;for(nova=[],i=l=0;l<=3;i=++l)nova[i]=-this.data[i];return new Mat2x23(nova)}apply_rotate(a){var m;return m=new Mat2x23,m.rotate(a),this.mul_with(m)}apply_scale(sx,sy){var m;return m=new Mat2x23,m.scale(sx,sy),this.mul_with(m)}transpose(){var a,b,c2,d;return[a,b,c2,d]=this.data,new Mat2x23([a,c2,b,d])}inv(){var a,b,c2,d,det,invDet;if([a,b,c2,d]=this.data,det=a*d-b*c2,det===0)throw new Error("Matriz sem inversa");return invDet=1/det,new Mat2x23([d*invDet,-b*invDet,-c2*invDet,a*invDet])}dump(label=null){var col,l,line,m,row;for(label!==null&&console.log(`Matriz 2x2 ${label}:`),m=this.data,row=l=0;l<=1;row=++l)line=function(){var o,results;for(results=[],col=o=0;o<=1;col=++o)results.push(m[row*2+col].toFixed(4).padStart(10));return results}().join(" "),console.log("  "+line);return console.log()}toString(){var col,l,line,m,row,s;for(m=this.data,s="",row=l=0;l<=1;row=++l)line=function(){var o,results;for(results=[],col=o=0;o<=1;col=++o)results.push(m[row*2+col].toFixed(2));return results}().join("  "),s+=line+" ",row<1&&(s+=" ; ");return"[ "+s.trim()+" ]"}};Mat3x32=class Mat3x33{constructor(data=[1,0,0,0,1,0,0,0,1]){if(this.data=flat_array_from_values(data),this.data.length!==9)throw new Error(`Esperada matriz 3x3 de 9 elementos: '${this.data}' tem ${this.data.length} elementos`)}identity(){return this.data=[1,0,0,0,1,0,0,0,1]}zero(){return this.data=[0,0,0,0,0,0,0,0,0]}copy_from(outro){return this.data=outro.data.slice()}rotate(a){var c2,s;if(isNaN(a))throw new Error(`rotate: argumento inv\xE1lido: ${a}`);return a=a*(Math.PI/180),s=Math.sin(a),c2=Math.cos(a),this.data=[c2,-s,0,s,c2,0,0,0,1]}scale(sx,sy){if(isNaN(sx)||isNaN(sy))throw new Error(`scale: argumento(s) inv\xE1lido(s): ${sx}, ${sy}`);return this.data=[sx,0,0,0,sy,0,0,0,1]}translate(dx,dy){if(isNaN(dx)||isNaN(dy))throw new Error(`translate: argumento(s) inv\xE1lido(s): ${dx}, ${dy}`);return this.data=[1,0,dx,0,1,dy,0,0,1]}get_row(i){return[this.data[i*3+0],this.data[i*3+1],this.data[i*3+2]]}get_col(j){return[this.data[0*3+j],this.data[1*3+j],this.data[2*3+j]]}get_row_vec(i){var a;return a=this.get_row(i),vec(a[0],a[1],a[2])}get_col_vec(j){var a;return a=this.get_col(j),vec(a[0],a[1],a[2])}add(outro){var i,l,nova;for(nova=[],i=l=0;l<=8;i=++l)nova[i]=this.data[i]+outro.data[i];return new Mat3x33(nova)}sub(outro){var i,l,nova;for(nova=[],i=l=0;l<=8;i=++l)nova[i]=this.data[i]-outro.data[i];return new Mat3x33(nova)}mul(outro){var _,a,b,resultado,x,y,z;return outro instanceof Vec42?(a=this.data,[x,y,z,_]=outro.data,new Vec42(a[0]*x+a[1]*y+a[2]*z,a[3]*x+a[4]*y+a[5]*z,a[6]*x+a[7]*y+a[8]*z)):(a=this.data,b=outro.data,resultado=[a[0]*b[0]+a[1]*b[3]+a[2]*b[6],a[0]*b[1]+a[1]*b[4]+a[2]*b[7],a[0]*b[2]+a[1]*b[5]+a[2]*b[8],a[3]*b[0]+a[4]*b[3]+a[5]*b[6],a[3]*b[1]+a[4]*b[4]+a[5]*b[7],a[3]*b[2]+a[4]*b[5]+a[5]*b[8],a[6]*b[0]+a[7]*b[3]+a[8]*b[6],a[6]*b[1]+a[7]*b[4]+a[8]*b[7],a[6]*b[2]+a[7]*b[5]+a[8]*b[8]],new Mat3x33(resultado))}add_with(outro){var i,l,results;for(results=[],i=l=0;l<=8;i=++l)results.push(this.data[i]+=outro.data[i]);return results}mul_with(outro){var a,b;return a=outro.data,b=this.data,this.data=[a[0]*b[0]+a[1]*b[3]+a[2]*b[6],a[0]*b[1]+a[1]*b[4]+a[2]*b[7],a[0]*b[2]+a[1]*b[5]+a[2]*b[8],a[3]*b[0]+a[4]*b[3]+a[5]*b[6],a[3]*b[1]+a[4]*b[4]+a[5]*b[7],a[3]*b[2]+a[4]*b[5]+a[5]*b[8],a[6]*b[0]+a[7]*b[3]+a[8]*b[6],a[6]*b[1]+a[7]*b[4]+a[8]*b[7],a[6]*b[2]+a[7]*b[5]+a[8]*b[8]]}neg(){var i,l,nova;for(nova=[],i=l=0;l<=8;i=++l)nova[i]=-this.data[i];return new Mat3x33(nova)}apply_rotate(a){var m;return m=new Mat3x33,m.rotate(a),this.mul_with(m)}apply_scale(sx,sy){var m;return m=new Mat3x33,m.scale(sx,sy),this.mul_with(m)}apply_translate(dx,dy){var m;return m=new Mat3x33,m.translate(dx,dy),this.mul_with(m)}transpose(){var a;return a=this.data,new Mat3x33([a[0],a[3],a[6],a[1],a[4],a[7],a[2],a[5],a[8]])}inv(){var a,det,invDet,resultado;if(a=this.data,det=a[0]*(a[4]*a[8]-a[5]*a[7])-a[1]*(a[3]*a[8]-a[5]*a[6])+a[2]*(a[3]*a[7]-a[4]*a[6]),det===0)throw new Error("Matriz sem inversa");return invDet=1/det,resultado=[(a[4]*a[8]-a[5]*a[7])*invDet,(a[2]*a[7]-a[1]*a[8])*invDet,(a[1]*a[5]-a[2]*a[4])*invDet,(a[5]*a[6]-a[3]*a[8])*invDet,(a[0]*a[8]-a[2]*a[6])*invDet,(a[2]*a[3]-a[0]*a[5])*invDet,(a[3]*a[7]-a[4]*a[6])*invDet,(a[1]*a[6]-a[0]*a[7])*invDet,(a[0]*a[4]-a[1]*a[3])*invDet],new Mat3x33(resultado)}toString(){var col,l,line,m,row,s;for(m=this.data,s="",row=l=0;l<=2;row=++l)line=function(){var o,results;for(results=[],col=o=0;o<=2;col=++o)results.push(m[row*3+col].toFixed(2).padStart(3));return results}().join("  "),s+=line+" ",row<2&&(s+=" ; ");return"[ "+s.trim()+" ]"}dump(label=null){var col,l,line,m,row;for(label!==null&&console.log(`Matriz 3x3 ${label}:`),m=this.data,row=l=0;l<=2;row=++l)line=function(){var o,results;for(results=[],col=o=0;o<=2;col=++o)results.push(m[row*3+col].toFixed(4).padStart(10));return results}().join(" "),console.log("  "+line);return console.log()}};Mat4x42=class Mat4x43{constructor(data=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]){if(this.data=flat_array_from_values(data),this.data.length!==16)throw new Error(`Esperada matriz 4x4 de 16 elementos: '${this.data}' tem ${this.data.length} elementos`)}identity(){return this.data=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]}zero(){return this.data=Array(16).fill(0)}copy_from(m){return this.data=m.data.slice(0)}transpose(){var d,i,j,l,o,t;for(d=this.data,t=new Array(16),i=l=0;l<4;i=++l)for(j=o=0;o<4;j=++o)t[i*4+j]=d[j*4+i];return new Mat4x43(t)}get_row(i){return[this.data[i*4+0],this.data[i*4+1],this.data[i*4+2],this.data[i*4+3]]}get_col(j){return[this.data[0*4+j],this.data[1*4+j],this.data[2*4+j],this.data[3*4+j]]}get_row_vec(i){var a;return a=this.get_row(i),vec(a[0],a[1],a[2],a[3])}get_col_vec(j){var a;return a=this.get_col(j),vec(a[0],a[1],a[2],a[3])}add(m){var i,l,result;for(result=new Mat4x43,i=l=0;l<16;i=++l)result.data[i]=this.data[i]+m.data[i];return result}add_with(m){var i,l,results;for(results=[],i=l=0;l<16;i=++l)results.push(this.data[i]+=m.data[i]);return results}sub(m){var i,l,result;for(result=new Mat4x43,i=l=0;l<16;i=++l)result.data[i]=this.data[i]-m.data[i];return result}mul(m){var a,b,col,k,l,o,p,r,row,sum,w,x,y,z;if(m instanceof Vec42)return a=this.data,[x,y,z,w]=m.data,new Vec42(a[0]*x+a[1]*y+a[2]*z+a[3]*w,a[4]*x+a[5]*y+a[6]*z+a[7]*w,a[8]*x+a[9]*y+a[10]*z+a[11]*w,a[12]*x+a[13]*y+a[14]*z+a[15]*w);for(a=this.data,b=m.data,r=new Mat4x43,row=l=0;l<4;row=++l)for(col=o=0;o<4;col=++o){for(sum=0,k=p=0;p<4;k=++p)sum+=a[row*4+k]*b[k*4+col];r.data[row*4+col]=sum}return r}mul_with(m){var a,b,col,k,l,results,row,sum;for(a=m.data,b=this.data.slice(0),results=[],row=l=0;l<4;row=++l)results.push(function(){var o,p,results1;for(results1=[],col=o=0;o<4;col=++o){for(sum=0,k=p=0;p<4;k=++p)sum+=a[row*4+k]*b[k*4+col];results1.push(this.data[row*4+col]=sum)}return results1}.call(this));return results}neg(){var i,l,nova;for(nova=[],i=l=0;l<=15;i=++l)nova[i]=-this.data[i];return new Mat4x43(nova)}rotate(a,x=0,y=0,z=1){var _,c2,len,r,rad,s,t,v2;if(rad=a*Math.PI/180,x instanceof Vec42?(v2=x,[x,y,z,_]=v2.data):x==null&&(x=0,y=0,z=1),isNaN(a)||isNaN(x)||isNaN(y)||isNaN(z))throw new Error(`rotate: argumento(s) inv\xE1lido(s): ${a}, ${x}, ${y}, ${z}`);return c2=Math.cos(rad),s=Math.sin(rad),t=1-c2,len=Math.sqrt(x*x+y*y+z*z),len===0?this:(x/=len,y/=len,z/=len,r=[t*x*x+c2,t*x*y-s*z,t*x*z+s*y,0,t*x*y+s*z,t*y*y+c2,t*y*z-s*x,0,t*x*z-s*y,t*y*z+s*x,t*z*z+c2,0,0,0,0,1],this.data=r)}rotateX(a){var c2,s;if(isNaN(a))throw new Error(`rotateX: argumento(s) inv\xE1lido(s): ${a}`);return a=a*(Math.PI/180),s=Math.sin(a),c2=Math.cos(a),this.data=[1,0,0,0,0,c2,-s,0,0,s,c2,0,0,0,0,1]}rotateY(a){var c2,s;if(isNaN(a))throw new Error(`rotateY: argumento(s) inv\xE1lido(s): ${a}`);return a=a*(Math.PI/180),s=Math.sin(a),c2=Math.cos(a),this.data=[c2,0,s,0,0,1,0,0,-s,0,c2,0,0,0,0,1]}rotateZ(a){var c2,s;if(isNaN(a))throw new Error(`rotateZ: argumento(s) inv\xE1lido(s): ${a}`);return a=a*(Math.PI/180),s=Math.sin(a),c2=Math.cos(a),this.data=[c2,-s,0,0,s,c2,0,0,0,0,1,0,0,0,0,1]}scale(sx,sy,sz){var _,v2;if(sx instanceof Vec42?(v2=sx,[sx,sy,sz,_]=v2.data):sy==null?(sy=sx,sz=sx):sz==null&&(sz=1),isNaN(sx)||isNaN(sy)||isNaN(sz))throw new Error(`scale: argumento(s) inv\xE1lido(s): ${sx}, ${sy}, ${sz}`);return this.data=[sx,0,0,0,0,sy,0,0,0,0,sz,0,0,0,0,1]}translate(dx,dy,dz=0){var _,v2;if(dx instanceof Vec42&&(v2=dx,[dx,dy,dz,_]=v2.data),isNaN(dx)||isNaN(dy)||isNaN(dz))throw new Error(`translate: argumento(s) inv\xE1lido(s): ${dx}, ${dy}, ${dz}`);return this.data=[1,0,0,dx,0,1,0,dy,0,0,1,dz,0,0,0,1]}perspective(fovy,aspect,near,far,fovy_in_deg=!0,webgpu=!0){var f;return fovy_in_deg&&(fovy=fovy*Math.PI/180),f=1/Math.tan(fovy/2),webgpu?this.data=[f/aspect,0,0,0,0,f,0,0,0,0,far/(near-far),near*far/(near-far),0,0,-1,0]:this.data=[f/aspect,0,0,0,0,f,0,0,0,0,(near+far)/(near-far),2*near*far/(near-far),0,0,-1,0]}orthographic(left,right,bottom,top,near,far,webgpu=!0){var f_n,r_l,t_b;return r_l=right-left,t_b=top-bottom,f_n=far-near,webgpu?this.data=[2/r_l,0,0,-(right+left)/r_l,0,2/t_b,0,-(top+bottom)/t_b,0,0,1/f_n,-near/f_n,0,0,0,1]:this.data=[2/r_l,0,0,-(right+left)/r_l,0,2/t_b,0,-(top+bottom)/t_b,0,0,-2/f_n,-(far+near)/f_n,0,0,0,1]}look_at(eye,center,up){var _,cx,cy,cz,ex,ey,ez,fx,fy,fz,len,sx,sy,sz,ux,uy,uz;return eye instanceof Vec42?[ex,ey,ez,_]=eye.data:[ex,ey,ez]=eye,center instanceof Vec42?[cx,cy,cz,_]=center.data:[cx,cy,cz]=center,up instanceof Vec42?[ux,uy,uz,_]=up.data:[ux,uy,uz]=up,fx=cx-ex,fy=cy-ey,fz=cz-ez,len=Math.sqrt(fx*fx+fy*fy+fz*fz),len===0?[fx,fy,fz]=[0,0,1]:[fx,fy,fz]=[fx/len,fy/len,fz/len],sx=fy*uz-fz*uy,sy=fz*ux-fx*uz,sz=fx*uy-fy*ux,len=Math.sqrt(sx*sx+sy*sy+sz*sz),len===0?[sx,sy,sz]=[1,0,0]:[sx,sy,sz]=[sx/len,sy/len,sz/len],ux=sy*fz-sz*fy,uy=sz*fx-sx*fz,uz=sx*fy-sy*fx,this.data=[sx,sy,sz,-(sx*ex+sy*ey+sz*ez),ux,uy,uz,-(ux*ex+uy*ey+uz*ez),-fx,-fy,-fz,-(-fx*ex+-fy*ey+-fz*ez),0,0,0,1]}apply_rotate(a,x,y,z){var m;return m=new Mat4x43,m.rotate(a,x,y,z),this.mul_with(m)}apply_scale(sx,sy,sz){var m;return m=new Mat4x43,m.scale(sx,sy,sz),this.mul_with(m)}apply_translate(dx,dy,dz){var m;return m=new Mat4x43,m.translate(dx,dy,dz),this.mul_with(m)}inv(){var det,i,inv,l,m;if(m=this.data,inv=[],inv[0]=m[5]*m[10]*m[15]-m[5]*m[11]*m[14]-m[9]*m[6]*m[15]+m[9]*m[7]*m[14]+m[13]*m[6]*m[11]-m[13]*m[7]*m[10],inv[1]=-m[1]*m[10]*m[15]+m[1]*m[11]*m[14]+m[9]*m[2]*m[15]-m[9]*m[3]*m[14]-m[13]*m[2]*m[11]+m[13]*m[3]*m[10],inv[2]=m[1]*m[6]*m[15]-m[1]*m[7]*m[14]-m[5]*m[2]*m[15]+m[5]*m[3]*m[14]+m[13]*m[2]*m[7]-m[13]*m[3]*m[6],inv[3]=-m[1]*m[6]*m[11]+m[1]*m[7]*m[10]+m[5]*m[2]*m[11]-m[5]*m[3]*m[10]-m[9]*m[2]*m[7]+m[9]*m[3]*m[6],inv[4]=-m[4]*m[10]*m[15]+m[4]*m[11]*m[14]+m[8]*m[6]*m[15]-m[8]*m[7]*m[14]-m[12]*m[6]*m[11]+m[12]*m[7]*m[10],inv[5]=m[0]*m[10]*m[15]-m[0]*m[11]*m[14]-m[8]*m[2]*m[15]+m[8]*m[3]*m[14]+m[12]*m[2]*m[11]-m[12]*m[3]*m[10],inv[6]=-m[0]*m[6]*m[15]+m[0]*m[7]*m[14]+m[4]*m[2]*m[15]-m[4]*m[3]*m[14]-m[12]*m[2]*m[7]+m[12]*m[3]*m[6],inv[7]=m[0]*m[6]*m[11]-m[0]*m[7]*m[10]-m[4]*m[2]*m[11]+m[4]*m[3]*m[10]+m[8]*m[2]*m[7]-m[8]*m[3]*m[6],inv[8]=m[4]*m[9]*m[15]-m[4]*m[11]*m[13]-m[8]*m[5]*m[15]+m[8]*m[7]*m[13]+m[12]*m[5]*m[11]-m[12]*m[7]*m[9],inv[9]=-m[0]*m[9]*m[15]+m[0]*m[11]*m[13]+m[8]*m[1]*m[15]-m[8]*m[3]*m[13]-m[12]*m[1]*m[11]+m[12]*m[3]*m[9],inv[10]=m[0]*m[5]*m[15]-m[0]*m[7]*m[13]-m[4]*m[1]*m[15]+m[4]*m[3]*m[13]+m[12]*m[1]*m[7]-m[12]*m[3]*m[5],inv[11]=-m[0]*m[5]*m[11]+m[0]*m[7]*m[9]+m[4]*m[1]*m[11]-m[4]*m[3]*m[9]-m[8]*m[1]*m[7]+m[8]*m[3]*m[5],inv[12]=-m[4]*m[9]*m[14]+m[4]*m[10]*m[13]+m[8]*m[5]*m[14]-m[8]*m[6]*m[13]-m[12]*m[5]*m[10]+m[12]*m[6]*m[9],inv[13]=m[0]*m[9]*m[14]-m[0]*m[10]*m[13]-m[8]*m[1]*m[14]+m[8]*m[2]*m[13]+m[12]*m[1]*m[10]-m[12]*m[2]*m[9],inv[14]=-m[0]*m[5]*m[14]+m[0]*m[6]*m[13]+m[4]*m[1]*m[14]-m[4]*m[2]*m[13]-m[12]*m[1]*m[6]+m[12]*m[2]*m[5],inv[15]=m[0]*m[5]*m[10]-m[0]*m[6]*m[9]-m[4]*m[1]*m[10]+m[4]*m[2]*m[9]+m[8]*m[1]*m[6]-m[8]*m[2]*m[5],det=m[0]*inv[0]+m[1]*inv[4]+m[2]*inv[8]+m[3]*inv[12],det===0)return null;for(det=1/det,i=l=0;l<16;i=++l)inv[i]*=det;return new Mat4x43(inv)}dump(label=null){var col,l,line,m,row;for(label!==null&&console.log(`Matriz 4x4 ${label}:`),m=this.data,row=l=0;l<=3;row=++l)line=function(){var o,results;for(results=[],col=o=0;o<=3;col=++o)results.push(m[row*4+col].toFixed(4).padStart(10));return results}().join(" "),console.log("  "+line);return console.log()}toString(){var col,l,line,m,row,s;for(m=this.data,s="",row=l=0;l<=3;row=++l)line=function(){var o,results;for(results=[],col=o=0;o<=3;col=++o)results.push(m[row*4+col].toFixed(2).padStart(5));return results}().join("  "),s+=line+" ",row<3&&(s+="; ");return"[  "+s.trim()+" ]"}};Vec42=class Vec43{constructor(...args){var i,l,len1,prop,ref;if(this.data=[0,0,0,1],this.data=flat_array_from_values(args),this.data.length===0)this.data=this.data.concat([0,0,0,1]);else if(this.data.length===1)this.data=this.data.concat([0,0,1]);else if(this.data.length===2)this.data=this.data.concat([0,1]);else if(this.data.length===3)this.data=this.data.concat([1]);else if(this.data.length>4)throw new Error("Esperado at\xE9 4 valores para o vetor");for(ref=["x","y","z","w"],i=l=0,len1=ref.length;l<len1;i=++l)prop=ref[i],function(obj,prop_name,prop_i){return Object.defineProperty(obj,prop_name,{get:()=>obj.data[prop_i],set:value=>obj.data[prop_i]=value,enumerable:!0,configurable:!0})}(this,prop,i)}set_values(x,y,z=0,w=1){return this.data[0]=x,this.data[1]=y,this.data[2]=z,this.data[3]=w}from_array(ar){if(this.data[0]=ar[0],ar[1]!=null&&(this.data[1]=ar[1],ar[2]!=null&&(this.data[2]=ar[2],ar[3]!=null)))return this.data[3]=ar[3]}to_array(){return this.data.slice()}div_by_w(){var w;if(!(this.data[3]===0||this.data[3]===1))return w=this.data[3],this.data[0]/=w,this.data[1]/=w,this.data[2]/=w,this.data[3]=1}length(){return this.norm3()}norm(){return this.norm3()}norm3(){return Math.sqrt(this.data[0]*this.data[0]+this.data[1]*this.data[1]+this.data[2]*this.data[2])}norm4(){return Math.sqrt(this.data[0]*this.data[0]+this.data[1]*this.data[1]+this.data[2]*this.data[2]+this.data[3]*this.data[3])}distance_to(v2){return this.sub(v2).norm3()}normalize(){return this.normalize3()}normalize3(){var n,result;return n=this.norm3(),n===0?this.clone():(result=new Vec43,result.data[0]=this.data[0]/n,result.data[1]=this.data[1]/n,result.data[2]=this.data[2]/n,result.data[3]=this.data[3],result)}normalize4(){var n,result;return n=this.norm4(),n===0?this.clone():(result=new Vec43,result.data[0]=this.data[0]/n,result.data[1]=this.data[1]/n,result.data[2]=this.data[2]/n,result.data[3]=this.data[3]/n,result)}dot(v2){return this.dp3(v2)}dp3(v2){return this.data[0]*v2.data[0]+this.data[1]*v2.data[1]+this.data[2]*v2.data[2]}dp4(v2){return this.data[0]*v2.data[0]+this.data[1]*v2.data[1]+this.data[2]*v2.data[2]+this.data[3]*v2.data[3]}cross(v2){var a1,a2,a3,b1,b2,b3,result;return result=new Vec43,[a1,a2,a3]=[this.data[0],this.data[1],this.data[2]],[b1,b2,b3]=[v2.data[0],v2.data[1],v2.data[2]],result.data[0]=a2*b3-a3*b2,result.data[1]=a3*b1-a1*b3,result.data[2]=a1*b2-a2*b1,result.data[3]=0,result}angle(v2){var cos_theta,dot_product,norm_product;return dot_product=this.dot(v2),norm_product=this.norm()*v2.norm(),norm_product===0?0:(cos_theta=Math.max(-1,Math.min(1,dot_product/norm_product)),Math.acos(cos_theta))}toString(){var l,line,m,row,s;for(m=this.data,s="",row=l=0;l<=3;row=++l)line=m[row].toFixed(2),s+=line+" ",row<3&&(s+=" ; ");return"[ "+s.trim()+" ]"}clone(){return new Vec43(this.data)}dup(){return this.clone()}add(v2){var result;return result=new Vec43,result.data[0]=this.data[0]+v2.data[0],result.data[1]=this.data[1]+v2.data[1],result.data[2]=this.data[2]+v2.data[2],result.data[3]=this.data[3],result}sub(v2){var result;return result=new Vec43,result.data[0]=this.data[0]-v2.data[0],result.data[1]=this.data[1]-v2.data[1],result.data[2]=this.data[2]-v2.data[2],result.data[3]=this.data[3],result}mul(t){var result;return t instanceof Vec43?(result=new Vec43,result.data[0]=this.data[0]*v.data[0],result.data[1]=this.data[1]*v.data[1],result.data[2]=this.data[2]*v.data[2],result.data[3]=this.data[3],result):this.mul_by_scalar(t)}mul_by_scalar(fator){var result;return result=new Vec43,result.data[0]=this.data[0]*fator,result.data[1]=this.data[1]*fator,result.data[2]=this.data[2]*fator,result.data[3]=this.data[3],result}addf(v2,f){var result;return result=new Vec43,result.data[0]=this.data[0]+v2.data[0]*f,result.data[1]=this.data[1]+v2.data[1]*f,result.data[2]=this.data[2]+v2.data[2]*f,result.data[3]=this.data[3],result}neg(){var r;return r=new Vec43,r.data[0]=-this.data[0],r.data[1]=-this.data[1],r.data[2]=-this.data[2],r.data[3]=this.data[3],r}dump(label=null){var campos,l,row,val;for(label!==null&&console.log(`Vetor ${label}:`),campos=["x","y","z","w"],row=l=0;l<=3;row=++l)val=this.data[row].toFixed(4).padStart(7),console.log(`  ${campos[row]}: ${val}`);return console.log()}};mat_mul2=function(...args){var i,l,ref,resp;if(args.length===0)return null;for(resp=args[0],i=l=1,ref=args.length;l<ref;i=l+=1)resp=resp.mul(args[i]);return resp};Quaternion2=class Quaternion3{constructor(x1=0,y1=0,z1=0,w1=1){this.x=x1,this.y=y1,this.z=z1,this.w=w1}rotate_vec(v2){var q,result,usa_vetor,vQuat,x,y,z;return usa_vetor=v2 instanceof Vec42,usa_vetor?[x,y,z]=v2.data:[x,y,z]=v2,vQuat=new Quaternion3(x,y,z,0),q=this.normalize(),result=q.mul(vQuat).mul(q.inv()),usa_vetor?new Vec42(result.x,result.y,result.z):[result.x,result.y,result.z]}to_axis_angle(angle_in_deg=!0){var angle,axis,q,s,w;return q=this.normalize(),w=Math.max(-1,Math.min(1,q.w)),angle=2*Math.acos(w),s=Math.sqrt(1-w*w),s<1e-6?axis=[1,0,0]:axis=[q.x/s,q.y/s,q.z/s],axis=new Vec42(axis[0],axis[1],axis[2]),angle_in_deg&&(angle=angle*180/Math.PI),{axis,angle}}to_mat4x4(){var q,w,x,xw,xx,xy,xz,y,yw,yy,yz,z,zw,zz;return q=this.normalize(),x=q.x,y=q.y,z=q.z,w=q.w,xx=x*x,xy=x*y,xz=x*z,xw=x*w,yy=y*y,yz=y*z,yw=y*w,zz=z*z,zw=z*w,new Mat4x42([1-2*(yy+zz),2*(xy-zw),2*(xz+yw),0,2*(xy+zw),1-2*(xx+zz),2*(yz-xw),0,2*(xz-yw),2*(yz+xw),1-2*(xx+yy),0,0,0,0,1])}normalize(){var len;return len=Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w),len<1e-6?new Quaternion3(0,0,0,1):new Quaternion3(this.x/len,this.y/len,this.z/len,this.w/len)}mul(q){return new Quaternion3(this.w*q.x+this.x*q.w+this.y*q.z-this.z*q.y,this.w*q.y-this.x*q.z+this.y*q.w+this.z*q.x,this.w*q.z+this.x*q.y-this.y*q.x+this.z*q.w,this.w*q.w-this.x*q.x-this.y*q.y-this.z*q.z)}conjugate(){return new Quaternion3(-this.x,-this.y,-this.z,this.w)}inv(){return this.conjugate().normalize()}toString(){return`(X:${this.x.toFixed(3)}, Y:${this.y.toFixed(3)}, Z:${this.z.toFixed(3)}, W:${this.w.toFixed(3)})`}};quaternion_from_axis_angle=function(axis,angle,angle_in_deg=!0){var halfAngle,len,sinHalf,usa_vetor,x,y,z;return usa_vetor=axis instanceof Vec42,usa_vetor?[x,y,z]=axis.data:[x,y,z]=axis,len=Math.sqrt(x*x+y*y+z*z),len<1e-6?new Quaternion2(0,0,0,1):(x/=len,y/=len,z/=len,angle_in_deg&&(angle=angle*Math.PI/180),halfAngle=angle/2,sinHalf=Math.sin(halfAngle),new Quaternion2(x*sinHalf,y*sinHalf,z*sinHalf,Math.cos(halfAngle)))};quaternion_from_mat4x4=function(m){var s,trace,w,x,y,z;return m instanceof Mat4x42&&(m=m.data),trace=m[0]+m[5]+m[10],trace>0?(s=.5/Math.sqrt(trace+1),w=.25/s,x=(m[6]-m[9])*s,y=(m[8]-m[2])*s,z=(m[1]-m[4])*s):m[0]>m[5]&&m[0]>m[10]?(s=2*Math.sqrt(1+m[0]-m[5]-m[10]),w=(m[6]-m[9])/s,x=.25*s,y=(m[1]+m[4])/s,z=(m[2]+m[8])/s):m[5]>m[10]?(s=2*Math.sqrt(1+m[5]-m[0]-m[10]),w=(m[8]-m[2])/s,x=(m[1]+m[4])/s,y=.25*s,z=(m[6]+m[9])/s):(s=2*Math.sqrt(1+m[10]-m[0]-m[5]),w=(m[1]-m[4])/s,x=(m[2]+m[8])/s,y=(m[6]+m[9])/s,z=.25*s),new Quaternion2(x,y,z,w).normalize()};vec_random2=function(min_x,min_y,min_z,max_x,max_y,max_z){var vmax,vmin,x,y,z;return min_x==null?(min_x=-1,min_y=-1,min_z=-1,max_x=1,max_y=1,max_z=1):min_x instanceof Vec42&&(vmin=min_x,vmax=min_y,min_x=vmin.x,min_y=vmin.y,min_z=vmin.z,max_x=vmax.x,max_y=vmax.y,max_z=vmax.z),x=min_x+Math.random()*(max_x-min_x),y=min_y+Math.random()*(max_y-min_y),z=min_z+Math.random()*(max_z-min_z),vec(x,y,z)};vec_from_array=function(ar){var v2;return v2=vec(0,0,0),v2.from_array(ar),v2};vec_to_array=function(v2){return v2.to_array()};globalThis.Mat2x2_format=Mat2x2_format2;globalThis.Mat3x3_format=Mat3x3_format2;globalThis.Mat4x4_format=Mat4x4_format2;globalThis.use_mat2x2_format=function(){return new Mat2x2_format2};globalThis.use_mat3x3_format=function(){return new Mat3x3_format2};globalThis.use_mat4x4_format=function(){return new Mat4x4_format2};globalThis.Mat2x2=Mat2x22;globalThis.Mat3x3=Mat3x32;globalThis.Mat4x4=Mat4x42;globalThis.Vec4=Vec42;globalThis.Quaternion=Quaternion2;globalThis.quaternion_from_axis_angle=quaternion_from_axis_angle;globalThis.quaternion_from_mat4x4=quaternion_from_mat4x4;globalThis.vec=function(x,y,z=0,w=1){return new Vec42(x,y,z,w)};globalThis.vec_random=vec_random2;globalThis.random_vec=vec_random2;globalThis.vec_from_array=vec_from_array;globalThis.vec_to_array=vec_to_array;globalThis.mat_mul=mat_mul2;var mat_eval,mat_eval_dump,mat_eval_expr;mat_eval_expr=function(input,vars={}){var error,exprCode,isNumberLiteral,match,next,parseAddSub,parseExpr,parseMatrixLiteral,parseMul,parseNumber,parsePrimary,parseUnary,peek,pos,skip;return pos=0,skip=function(){var results;for(results=[];input[pos]===" ";)results.push(pos++);return results},peek=function(){return input[pos]},next=function(){return input[pos++]},match=function(ch){return skip(),peek()===ch?(pos++,!0):!1},error=function(msg){throw new Error(`${msg} na posi\xE7\xE3o ${pos}: '${input.slice(pos)}'`)},parseExpr=function(){return parseAddSub()},parseAddSub=function(){var left,right;for(left=parseMul();;)if(skip(),peek()==="+")next(),right=parseMul(),left=`${left}.add( ${right} )`;else if(peek()==="-")next(),right=parseMul(),left=`${left}.sub( ${right} )`;else break;return left},isNumberLiteral=function(expr){return expr.match(/^-?[0-9]+(\.[0-9]+)?$/)},parseMul=function(){var left,right;for(left=parseUnary();skip(),peek()==="*";)next(),right=parseUnary(),isNumberLiteral(left)?left=`${right}.mul_by_scalar( ${left} )`:isNumberLiteral(right)?left=`${left}.mul( ${right} )`:left=`${left}.mul( ${right} )`;return left},parseUnary=function(){var operand;return skip(),peek()==="-"?(next(),operand=parseUnary(),isNumberLiteral(operand)?`-${operand}`:`${operand}.neg()`):parsePrimary()},parsePrimary=function(){var args,expr,name,ref;if(skip(),peek()==="(")return next(),expr=parseExpr(),skip(),match(")")||error("Espearado ')' ap\xF3s express\xE3o"),expr;if(peek()==="[")return parseMatrixLiteral();if(peek().match(/[A-Za-z_]/)){for(name="";(ref=peek())!=null&&ref.match(/[A-Za-z0-9_]/);)name+=next();if(skip(),peek()==="("){if(next(),args=[],skip(),peek()!==")")for(;args.push(parseExpr()),skip(),peek()!==")";)match(",")||error("Esperado ',' entre argumentos");return match(")")||error("Experado ')' para fechar a fun\xE7\xE3o"),name==="cross"||name==="dot"||name==="dp3"||name==="dp4"?(args.length!==2&&error(`${name} requer 2 argumentos`),`${args[0]}.${name}( ${args[1]} )`):name==="norm"||name==="normalize"||name==="len"||name==="length"||name==="inv"||name==="transpose"?(args.length!==1&&error(`${name} requer 1 argumento`),`${args[0]}.${name}()`):name==="R"||name==="T"||name==="S"||name==="Rx"||name==="Ry"||name==="Rz"?{R:function(){return`mat4x4_format.rotate( ${args.join(", ")} )`},T:function(){return`mat4x4_format.translate( ${args.join(", ")} )`},S:function(){return`mat4x4_format.scale( ${args.join(", ")} )`},Rx:function(){return`mat4x4_format.rotateX( ${args.join(", ")} )`},Ry:function(){return`mat4x4_format.rotateY( ${args.join(", ")} )`},Rz:function(){return`mat4x4_format.rotateZ( ${args.join(", ")} )`}}[name]():name==="sin"||name==="cos"?(args.length!==1&&error(`${name} requer 1 argumento`),`${name}( ${args[0]} )`):error(`Fun\xE7\xE3o desconhecida: ${name}`)}else return name}else return parseNumber()},parseMatrixLiteral=function(){var bracketCount,i,len,lines,literal,matClass,ncols,nrows,r,rows,start;for(match("[")||error("Esperado '[' para iniciar matriz"),start=pos,bracketCount=1;bracketCount>0&&pos<input.length;)input[pos]==="["?bracketCount++:input[pos]==="]"&&bracketCount--,pos++;for(bracketCount!==0&&error("'[' sem correspond\xEAncia no literal da matriz"),literal=input.slice(start,pos-1).trim(),lines=literal.split(/;/),rows=lines.map(function(line){var parts;return parts=line.trim().split(/\s+/),parts.map(function(n){return parseFloat(n)})}),nrows=rows.length,ncols=nrows>0?rows[0].length:0,i=0,len=rows.length;i<len;i++)r=rows[i],r.length!==ncols&&error("N\xFAmero de colunas inconsistente");return ncols===1&&nrows>=2&&nrows<=4?`new Vec4([${rows.map(function(r2){return r2[0]}).join(",")}])`:nrows===ncols&&nrows>=2&&nrows<=4?(matClass=`Mat${nrows}x${ncols}`,`new ${matClass}([${rows.map(function(r2){return`[${r2.join(",")}]`}).join(",")}])`):error("Apenas matrizes 2x2, 3x3, 4x4 ou vetores de 2-4 componentes s\xE3o suportados")},parseNumber=function(){var num,ref;for(skip(),num="";(ref=peek())!=null&&ref.match(/[0-9.]/);)num+=next();return num===""&&error("Esperado n\xFAmero"),num},exprCode=parseExpr(),skip(),pos<input.length&&error("Entrada inesperada"),exprCode};mat_eval=function(input,vars={}){var exprCode,f,func_body,param_names,param_values;return exprCode=mat_eval_expr(input,vars),func_body="return "+exprCode,param_names=Object.keys(vars),param_values=param_names.map(function(key){return vars[key]}),f=new Function(...param_names,func_body),f(...param_values)};mat_eval_dump=function(input,vars={}){var exprCode;return exprCode=mat_eval_expr(input,vars),console.log(input),console.log("  => "+exprCode),console.log()};globalThis.mat_eval=mat_eval;globalThis.mat_eval_expr=mat_eval_expr;globalThis.mat_eval_dump=mat_eval_dump;var clamp2,deg_to_rad,interp_barycentric,interp_barycentric_attrib,lerp2,lerp_angle,lerp_color,lerp_vec,linspace,list_lerp2,rad_to_deg,random2,random_choice2,random_float2,random_shuffle,remap_value,smooth_step,smoother_step,snap,time2;lerp2=function(a,b,t){var i,k,r,ref;if(a instanceof Vec4)return new Vec4(a.data[0]+(b.data[0]-a.data[0])*t,a.data[1]+(b.data[1]-a.data[1])*t,a.data[2]+(b.data[2]-a.data[2])*t,a.data[3]+(b.data[3]-a.data[3])*t);if(Array.isArray(a)){for(r=[],i=k=0,ref=a.length;k<ref;i=k+=1)r.push(a[i]+(b[i]-a[i])*t);return r}else return a+(b-a)*t};lerp_vec=function(v1,v2,t){return lerp2(v1,v2,t)};lerp_color=function(c1,c2,t){return lerp2(c1,c2,t)};list_lerp2=function(list,t){var frac,i,index;return list==null||list.length===0?null:(t=clamp2(t,0,1),index=t*(list.length-1),i=Math.floor(index),frac=index-i,i===list.length-1?list[i]:lerp2(list[i],list[i+1],frac))};lerp_angle=function(a,b,t){var delta;return delta=(b-a+Math.PI)%(2*Math.PI)-Math.PI,a+delta*t};clamp2=function(x,min=0,max=1){return x instanceof Vec4?min instanceof Vec4?new Vec4(Math.max(min.data[0],Math.min(max.data[0],x.data[0])),Math.max(min.data[1],Math.min(max.data[1],x.data[1])),Math.max(min.data[2],Math.min(max.data[2],x.data[2])),Math.max(min.data[3],Math.min(max.data[3],x.data[3]))):new Vec4(Math.max(min,Math.min(max,x.data[0])),Math.max(min,Math.min(max,x.data[1])),Math.max(min,Math.min(max,x.data[2])),Math.max(min,Math.min(max,x.data[3]))):Math.max(min,Math.min(max,x))};random2=function(a,b){return b==null&&(b=a-1,a=0),a+Math.floor(Math.random()*(b-a+1))};random_float2=function(a,b){return b==null&&(b=a,a=0),a+Math.random()*(b-a)};random_choice2=function(array){var randomIndex;if(array.length===0)throw new Error("Array n\xE3o pode estar vazio");return randomIndex=Math.floor(Math.random()*array.length),array[randomIndex]};random_shuffle=function(array){var i,j,k,ref;for(i=k=ref=array.length-1;k>=1;i=k+=-1)j=Math.floor(Math.random()*(i+1)),[array[i],array[j]]=[array[j],array[i]]};time2=function(){return Date.now()/1e3};deg_to_rad=function(deg){return deg*Math.PI/180};rad_to_deg=function(rad){return rad*180/Math.PI};smooth_step=function(t){return t=clamp2(t,0,1),t*t*(3-2*t)};smoother_step=function(t){return t=clamp2(t,0,1),t*t*t*(t*(t*6-15)+10)};remap_value=function(v2,a,b,c2,d){var t;return t=(v2-a)/(b-a),c2+t*(d-c2)};snap=function(x,step_size){return Math.round(x/step_size)*step_size};interp_barycentric=function(p,p0,p1,p2){var _,denom,w0,w1,w2,x,x0,x1,x2,y,y0,y1,y2;return[x,y,_,_]=p.data,[x0,y0,_,_]=p0.data,[x1,y1,_,_]=p1.data,[x2,y2,_,_]=p2.data,denom=(y1-y2)*(x0-x2)+(x2-x1)*(y0-y2),w0=((y1-y2)*(x-x2)+(x2-x1)*(y-y2))/denom,w1=((y2-y0)*(x-x2)+(x0-x2)*(y-y2))/denom,w2=1-w0-w1,[w0,w1,w2]};interp_barycentric_attrib=function(p,p0,p1,p2,attrib_p0,attrib_p1,attrib_p2){var w0,w1,w2;return[w0,w1,w2]=interp_barycentric(p,p0,p1,p2),w0*attrib_p0+w1*attrib_p1+w2*attrib_p2};linspace=function(start,stop,n=100){var i,step;return n=Math.max(1,Math.floor(n)),n===1?[start]:(step=(stop-start)/(n-1),[function(){var k,ref,results;for(results=[],i=k=0,ref=n;0<=ref?k<ref:k>ref;i=0<=ref?++k:--k)results.push(start+i*step);return results}()])};globalThis.lerp=lerp2;globalThis.lerp_vec=lerp_vec;globalThis.lerp_color=lerp_color;globalThis.list_lerp=list_lerp2;globalThis.lerp_angle=lerp_angle;globalThis.clamp=clamp2;globalThis.random=random2;globalThis.random_float=random_float2;globalThis.random_choice=random_choice2;globalThis.random_shuffle=random_shuffle;globalThis.time=time2;globalThis.deg_to_rad=deg_to_rad;globalThis.rad_to_deg=rad_to_deg;globalThis.smooth_step=smooth_step;globalThis.smoother_step=smoother_step;globalThis.remap_value=remap_value;globalThis.interp_barycentric=interp_barycentric;globalThis.interp_barycentric_attrib=interp_barycentric_attrib;globalThis.linspace=linspace;var colormap,get_colormap_list,hex_to_rgb,hsl_to_rgb,hsv_to_rgb,linear_to_srgb,rgb2,rgb_byte,rgb_to_hex,rgb_to_hsl,rgb_to_hsv,srgb_to_linear;rgb2=function(r,g,b,a=1){return new Vec4(r,g,b,a)};rgb_byte=function(r,g,b,a=255){return new Vec4(r/255,g/255,b/255,a/255)};linear_to_srgb=function(col){return new Vec4(Math.pow(col.x,1/2.2),Math.pow(col.y,1/2.2),Math.pow(col.z,1/2.2),col.w)};srgb_to_linear=function(col){return new Vec4(Math.pow(col.x,2.2),Math.pow(col.y,2.2),Math.pow(col.z,2.2),col.w)};hsl_to_rgb=function(h,s,l,a=1,normalized=!1){var b,c2,g,m,r,ref,ref1,ref2,ref3,ref4,x;return normalized||(h=h/360,s=s/100,l=l/100),s===0?new Vec4(l,l,l,a):(h=h%1,c2=(1-Math.abs(2*l-1))*s,x=c2*(1-Math.abs(h*6%2-1)),m=l-c2/2,r=g=b=0,0<=(ref=h*6)&&ref<1?(r=c2,g=x):1<=(ref1=h*6)&&ref1<2?(r=x,g=c2):2<=(ref2=h*6)&&ref2<3?(g=c2,b=x):3<=(ref3=h*6)&&ref3<4?(g=x,b=c2):4<=(ref4=h*6)&&ref4<5?(r=x,b=c2):(r=c2,b=x),new Vec4(r+m,g+m,b+m,a))};rgb_to_hsl=function(r,g,b,a=1){var d,h,l,max,min,s;return max=Math.max(r,g,b),min=Math.min(r,g,b),l=(max+min)/2,max===min?h=s=0:(d=max-min,s=l>.5?d/(2-max-min):d/(max+min),max===r?h=(g-b)/d+(g<b?6:0):max===g?h=(b-r)/d+2:h=(r-g)/d+4,h/=6),new Vec4(h,s,l,a)};hsv_to_rgb=function(h,s,v2,a=1,normalized=!1){var b,f,g,i,p,q,r,t;return normalized||(h=h/360,s=s/100,v2=v2/100),s===0?new Vec4(v2,v2,v2,a):(h=h%1,i=Math.floor(h*6),f=h*6-i,p=v2*(1-s),q=v2*(1-f*s),t=v2*(1-(1-f)*s),i===0?(r=v2,g=t,b=p):i===1?(r=q,g=v2,b=p):i===2?(r=p,g=v2,b=t):i===3?(r=p,g=q,b=v2):i===4?(r=t,g=p,b=v2):(r=v2,g=p,b=q),new Vec4(r,g,b,a))};rgb_to_hsv=function(r,g,b,a=1){var d,h,max,min,s,v2;return max=Math.max(r,g,b),min=Math.min(r,g,b),v2=max,d=max-min,s=max===0?0:d/max,max===min?h=0:(max===r?h=(g-b)/d+(g<b?6:0):max===g?h=(b-r)/d+2:h=(r-g)/d+4,h/=6),new Vec4(h,s,v2,a)};hex_to_rgb=function(hex){return hex=hex.replace("#",""),hex.length===4?hex=hex[0]+hex[0]+hex[1]+hex[1]+hex[2]+hex[2]+hex[3]+hex[3]:hex.length===3&&(hex=hex[0]+hex[0]+hex[1]+hex[1]+hex[2]+hex[2]+"ff"),hex.length===6&&(hex+="ff"),new Vec4(parseInt(hex.substring(0,2),16)/255,parseInt(hex.substring(2,4),16)/255,parseInt(hex.substring(4,6),16)/255,parseInt(hex.substring(6,8),16)/255)};rgb_to_hex=function(col){var a,b,g,r;return r=col.x,g=col.y,b=col.z,a=col.w,r=Math.round(r*255).toString(16).padStart(2,"0"),g=Math.round(g*255).toString(16).padStart(2,"0"),b=Math.round(b*255).toString(16).padStart(2,"0"),a=Math.round(a*255).toString(16).padStart(2,"0"),"#"+r+g+b+a};colormap=function(nome,opts){var colormaps,generateColors,interpolate,n,reverse;if(interpolate=function(x0,x1,y0,y1,x){return y0+(y1-y0)*(x-x0)/(x1-x0)},generateColors=function(keyPoints){var b,cores,g,i,j,k,o,r,ref,ref1,t;for(cores=[],i=k=0,ref=n;0<=ref?k<ref:k>ref;i=0<=ref?++k:--k)for(t=i/(n-1),j=o=0,ref1=keyPoints.length-1;0<=ref1?o<ref1:o>ref1;j=0<=ref1?++o:--o)if(keyPoints[j].pos<=t&&t<=keyPoints[j+1].pos){r=interpolate(keyPoints[j].pos,keyPoints[j+1].pos,keyPoints[j].rgb[0],keyPoints[j+1].rgb[0],t),g=interpolate(keyPoints[j].pos,keyPoints[j+1].pos,keyPoints[j].rgb[1],keyPoints[j+1].rgb[1],t),b=interpolate(keyPoints[j].pos,keyPoints[j+1].pos,keyPoints[j].rgb[2],keyPoints[j+1].rgb[2],t),r=clamp(r,0,1),g=clamp(g,0,1),b=clamp(b,0,1),cores.push(vec(r,g,b));break}return reverse&&cores.reverse(),cores},n=opts?.n,reverse=opts?.reverse,colormaps={jet:[{pos:0,rgb:[0,0,.5]},{pos:.125,rgb:[0,0,1]},{pos:.375,rgb:[0,1,1]},{pos:.625,rgb:[1,1,0]},{pos:.875,rgb:[1,0,0]},{pos:1,rgb:[.5,0,0]}],turbo:[{pos:0,rgb:[.189,.071,.232]},{pos:.2,rgb:[.194,.594,.208]},{pos:.4,rgb:[.015,.829,.541]},{pos:.6,rgb:[.871,.757,.169]},{pos:.8,rgb:[.969,.391,.135]},{pos:1,rgb:[.498,.013,.224]}],viridis:[{pos:0,rgb:[.267,.004,.329]},{pos:.3,rgb:[.23,.299,.498]},{pos:.6,rgb:[.127,.533,.398]},{pos:1,rgb:[.993,.906,.144]}],nebula:[{pos:0,rgb:[0,0,.2]},{pos:.3,rgb:[.2,0,.5]},{pos:.6,rgb:[.5,.2,.8]},{pos:1,rgb:[1,.8,1]}],parula:[{pos:0,rgb:[.242,.15,.66]},{pos:.3,rgb:[.165,.595,.82]},{pos:.6,rgb:[.376,.82,.408]},{pos:1,rgb:[.993,.906,.143]}],cool:[{pos:0,rgb:[0,1,1]},{pos:1,rgb:[1,0,1]}],hot:[{pos:0,rgb:[0,0,0]},{pos:.3,rgb:[1,0,0]},{pos:.6,rgb:[1,1,0]},{pos:1,rgb:[1,1,1]}],hsv:[{pos:0,rgb:[1,0,0]},{pos:.167,rgb:[1,1,0]},{pos:.333,rgb:[0,1,0]},{pos:.5,rgb:[0,1,1]},{pos:.667,rgb:[0,0,1]},{pos:.833,rgb:[1,0,1]},{pos:1,rgb:[1,0,0]}],magma:[{pos:0,rgb:[0,0,.004]},{pos:.3,rgb:[.364,.149,.553]},{pos:.6,rgb:[.821,.409,.529]},{pos:1,rgb:[.988,.992,.749]}],plasma:[{pos:0,rgb:[.05,.029,.529]},{pos:.3,rgb:[.39,.171,.706]},{pos:.6,rgb:[.776,.353,.427]},{pos:1,rgb:[.941,.906,.277]}],gray:[{pos:0,rgb:[0,0,0]},{pos:1,rgb:[1,1,1]}],winter:[{pos:0,rgb:[0,0,1]},{pos:1,rgb:[0,1,.5]}],autumn:[{pos:0,rgb:[1,0,0]},{pos:1,rgb:[1,1,0]}],summer:[{pos:0,rgb:[0,.5,.4]},{pos:1,rgb:[1,1,.4]}],spring:[{pos:0,rgb:[1,0,1]},{pos:1,rgb:[1,1,0]}],thermal:[{pos:0,rgb:[0,0,.3]},{pos:.3,rgb:[.2,.4,.6]},{pos:.6,rgb:[.8,.6,.2]},{pos:1,rgb:[1,1,.8]}],haline:[{pos:0,rgb:[.1,0,.3]},{pos:.3,rgb:[.3,.2,.5]},{pos:.6,rgb:[.5,.5,.3]},{pos:1,rgb:[.8,1,.6]}],deep:[{pos:0,rgb:[0,0,.2]},{pos:.3,rgb:[0,.2,.4]},{pos:.6,rgb:[.2,.4,.6]},{pos:1,rgb:[.4,.6,.8]}],dense:[{pos:0,rgb:[0,0,.3]},{pos:.3,rgb:[.1,.3,.5]},{pos:.6,rgb:[.3,.5,.7]},{pos:1,rgb:[.5,.8,1]}],matter:[{pos:0,rgb:[.2,0,.3]},{pos:.3,rgb:[.4,.2,.5]},{pos:.6,rgb:[.7,.5,.3]},{pos:1,rgb:[1,.8,.2]}],rain:[{pos:0,rgb:[.2,.2,.2]},{pos:.3,rgb:[.3,.4,.5]},{pos:.6,rgb:[.5,.6,.8]},{pos:1,rgb:[.8,.9,1]}],phase:[{pos:0,rgb:[1,0,0]},{pos:.25,rgb:[0,1,0]},{pos:.5,rgb:[0,0,1]},{pos:.75,rgb:[1,1,0]},{pos:1,rgb:[1,0,0]}],balance:[{pos:0,rgb:[0,0,1]},{pos:.5,rgb:[1,1,1]},{pos:1,rgb:[1,0,0]}],curl:[{pos:0,rgb:[0,.5,0]},{pos:.5,rgb:[1,1,1]},{pos:1,rgb:[.5,0,.5]}],tarn:[{pos:0,rgb:[.5,.3,.1]},{pos:.5,rgb:[.8,.8,.8]},{pos:1,rgb:[.2,.5,.5]}],coolwarm:[{pos:0,rgb:[.2,.4,.8]},{pos:.5,rgb:[.8,.8,.8]},{pos:1,rgb:[.8,.4,.2]}],gouldian:[{pos:0,rgb:[0,.5,0]},{pos:.3,rgb:[0,0,1]},{pos:.6,rgb:[1,0,0]},{pos:1,rgb:[1,1,0]}],phase4:[{pos:0,rgb:[1,0,0]},{pos:.25,rgb:[0,1,0]},{pos:.5,rgb:[0,0,1]},{pos:.75,rgb:[1,1,0]},{pos:1,rgb:[1,0,0]}],rainbow:[{pos:0,rgb:[.5,0,1]},{pos:.2,rgb:[0,0,1]},{pos:.4,rgb:[0,1,0]},{pos:.6,rgb:[1,1,0]},{pos:.8,rgb:[1,0,0]},{pos:1,rgb:[1,0,1]}],rainbow2:[{pos:0,rgb:[0,0,1]},{pos:.3,rgb:[0,1,0]},{pos:.6,rgb:[1,1,0]},{pos:1,rgb:[1,0,0]}],rainbow3:[{pos:0,rgb:[0,.5,1]},{pos:.3,rgb:[0,1,0]},{pos:.6,rgb:[1,.5,0]},{pos:1,rgb:[1,0,.5]}],rocket:[{pos:0,rgb:[.05,.02,.08]},{pos:.3,rgb:[.29,.14,.31]},{pos:.6,rgb:[.63,.39,.39]},{pos:1,rgb:[.99,.79,.62]}],mako:[{pos:0,rgb:[.02,.07,.24]},{pos:.3,rgb:[.07,.34,.4]},{pos:.6,rgb:[.27,.6,.47]},{pos:1,rgb:[.64,.88,.66]}],flare:[{pos:0,rgb:[.2,.02,.09]},{pos:.3,rgb:[.44,.12,.24]},{pos:.6,rgb:[.69,.34,.39]},{pos:1,rgb:[.93,.67,.64]}],vlag:[{pos:0,rgb:[.14,.27,.49]},{pos:.5,rgb:[.95,.95,.95]},{pos:1,rgb:[.55,.18,.21]}],icefire:[{pos:0,rgb:[.02,.06,.22]},{pos:.3,rgb:[.06,.46,.46]},{pos:.5,rgb:[.2,.8,.2]},{pos:.7,rgb:[.8,.6,.2]},{pos:1,rgb:[.98,.4,.15]}],plotly3:[{pos:0,rgb:[.05,.03,.53]},{pos:.3,rgb:[.27,.01,.66]},{pos:.6,rgb:[.74,.37,.42]},{pos:1,rgb:[.94,.91,.16]}],electric:[{pos:0,rgb:[0,0,0]},{pos:.3,rgb:[.13,.04,.67]},{pos:.6,rgb:[.63,.28,.8]},{pos:1,rgb:[.94,.93,0]}],rdbu:[{pos:0,rgb:[.4,.02,.1]},{pos:.5,rgb:[.97,.96,.96]},{pos:1,rgb:[.11,.3,.48]}],sunset:[{pos:0,rgb:[.07,.03,.27]},{pos:.3,rgb:[.3,.13,.4]},{pos:.6,rgb:[.66,.31,.31]},{pos:1,rgb:[.99,.74,.44]}],purpor:[{pos:0,rgb:[.3,.05,.4]},{pos:.3,rgb:[.5,.2,.5]},{pos:.6,rgb:[.7,.4,.4]},{pos:1,rgb:[1,.6,.2]}],sunsetdark:[{pos:0,rgb:[.05,.02,.2]},{pos:.3,rgb:[.2,.1,.3]},{pos:.6,rgb:[.5,.25,.25]},{pos:1,rgb:[.8,.5,.3]}],agsunset:[{pos:0,rgb:[.15,.1,.3]},{pos:.3,rgb:[.3,.25,.4]},{pos:.6,rgb:[.6,.5,.3]},{pos:1,rgb:[.95,.8,.4]}]},!colormaps[nome])throw new Error(`Colormap '${nome}' n\xE3o encontrado`);return n==null&&(n=colormaps[nome].length),generateColors(colormaps[nome])};get_colormap_list=function(){var colormaps;return colormaps=["jet","turbo","viridis","nebula","parula","cool","hot","hsv","magma","plasma","gray","winter","autumn","summer","spring","thermal","haline","deep","dense","matter","rain","phase","balance","curl","tarn","coolwarm","gouldian","phase4","rainbow","rainbow2","rainbow3","rocket","mako","flare","vlag","icefire","plotly3","electric","rdbu","sunset","purpor","sunsetdark","agsunset"],colormaps};globalThis.rgb=rgb2;globalThis.rgb_byte=rgb_byte;globalThis.linear_to_srgb=linear_to_srgb;globalThis.srgb_to_linear=srgb_to_linear;globalThis.rgb_to_hsl=rgb_to_hsl;globalThis.hsl_to_rgb=hsl_to_rgb;globalThis.rgb_to_hsv=rgb_to_hsv;globalThis.hsv_to_rgb=hsv_to_rgb;globalThis.hex_to_rgb=hex_to_rgb;globalThis.rgb_to_hex=rgb_to_hex;globalThis.colormap=colormap;globalThis.get_colormap_list=get_colormap_list;var AABB2,EPSILON,Frustum,Plane,Ray,Sphere2,Triangle,cartesian_to_polar,cartesian_to_spherical,curve_bezier,curve_catmull_rom,plane_from_points,polar_to_cartesian,segment_2d_intersect,spherical_to_cartesian;EPSILON=1e-6;Sphere2=class{constructor(center1,r1){this.center=center1,this.r=r1}get_center(){return this.center}get_r(){return this.r}intersect(s){return this.intersect_sphere(s)}intersect_sphere(s){var d;return d=this.center.sub(s.center).length(),d<=this.r+s.r}intersect_aabb(a){var closest,vmax,vmin;return vmin=a.get_min(),vmax=a.get_max(),closest=vec(Math.max(vmin.x,Math.min(this.center.x,vmax.x)),Math.max(vmin.y,Math.min(this.center.y,vmax.y)),Math.max(vmin.z,Math.min(this.center.z,vmax.z))),this.distance_to_point(closest)<=this.r}intersect_segment(p1,p2){var a,b,c2,d,discriminant,f,t1,t2;return d=p2.sub(p1),f=p1.sub(this.center),a=d.dot(d),b=2*f.dot(d),c2=f.dot(f)-this.r*this.r,discriminant=b*b-4*a*c2,discriminant<0?!1:(t1=(-b-Math.sqrt(discriminant))/(2*a),t2=(-b+Math.sqrt(discriminant))/(2*a),t1>=0&&t1<=1||t2>=0&&t2<=1)}contains_sphere(other){var distance_between_centers,other_center,other_r;return other_center=other.get_center(),other_r=other.get_r(),distance_between_centers=this.center.distance_to(other_center),distance_between_centers+other_r<=this.r}to_aabb(){var max,min;return min=vec(this.center.x-this.r,this.center.y-this.r,this.center.z-this.r),max=vec(this.center.x+this.r,this.center.y+this.r,this.center.z+this.r),new AABB2(min,max)}distance_to_point(pt){return this.center.sub(pt).length()}is_point_inside(pt){return this.distance_to_point(pt)<=this.r}};AABB2=class{constructor(min1,max1){this.min=min1,this.max=max1}get_min(){return this.min}get_max(){return this.max}get_center(){return this.min.add(this.max.sub(this.min).mul_by_scalar(.5))}get_size(){return{x:this.max.x-this.min.x,y:this.max.y-this.min.y,z:this.max.z-this.min.z}}intersect_aabb(a){var vmax,vmin;return vmin=a.get_min(),vmax=a.get_max(),this.min.x<=vmax.x&&this.max.x>=vmin.x&&this.min.y<=vmax.y&&this.max.y>=vmin.y&&this.min.z<=vmax.z&&this.max.z>=vmin.z}intersect_sphere(s){return s.intersect_aabb(this)}intersect_segment(p1,p2){var axis,dir,i,len,ood,ref,t1,t2,tmax,tmin;for(tmin=0,tmax=1,dir=p2.sub(p1),ref=["x","y","z"],i=0,len=ref.length;i<len;i++)if(axis=ref[i],Math.abs(dir[axis])<EPSILON){if(p1[axis]<this.min[axis]||p1[axis]>this.max[axis])return!1}else if(ood=1/dir[axis],t1=(this.min[axis]-p1[axis])*ood,t2=(this.max[axis]-p1[axis])*ood,t1>t2&&([t1,t2]=[t2,t1]),tmin=Math.max(tmin,t1),tmax=Math.min(tmax,t2),tmin>tmax)return!1;return tmin<=tmax}to_sphere(){var center,r;return center=this.get_center(),r=this.max.sub(center).length(),new Sphere2(center,r)}distance_to_point(pt){var closest;return closest=vec(Math.max(this.min.x,Math.min(pt.x,this.max.x)),Math.max(this.min.y,Math.min(pt.y,this.max.y)),Math.max(this.min.z,Math.min(pt.z,this.max.z))),pt.sub(closest).length()}is_point_inside(pt){return pt.x>=this.min.x&&pt.x<=this.max.x&&pt.y>=this.min.y&&pt.y<=this.max.y&&pt.z>=this.min.z&&pt.z<=this.max.z}get_verts(){return[vec(this.min.x,this.min.y,this.min.z),vec(this.min.x,this.min.y,this.max.z),vec(this.min.x,this.max.y,this.min.z),vec(this.min.x,this.max.y,this.max.z),vec(this.max.x,this.min.y,this.min.z),vec(this.max.x,this.min.y,this.max.z),vec(this.max.x,this.max.y,this.min.z),vec(this.max.x,this.max.y,this.max.z)]}};Plane=class{constructor(normal1,d4){this.normal=normal1,this.d=d4}get_normal(){return this.normal}get_d(){return this.d}intersect_sphere(s){var dist;return dist=this.distance_to_point(s.get_center()),dist<=s.get_r()}intersect_aabb(a){var center,extents,r;return center=a.get_center(),extents=a.get_max().sub(center),r=Math.sqrt(extents.x*extents.x+extents.y*extents.y+extents.z*extents.z),this.distance_to_point(center)<=r}intersect_segment(p1,p2){var n_dot_p1,n_dot_p2,point,t;return n_dot_p1=this.normal.dot(p1),n_dot_p2=this.normal.dot(p2),(n_dot_p1-this.d)*(n_dot_p2-this.d)>0||(t=(this.d-n_dot_p1)/(n_dot_p2-n_dot_p1),t<0||t>1)?null:(point=p1.add(p2.sub(p1).mul_by_scalar(t)),point)}distance_to_point(pt){return Math.abs(this.normal.dot(pt)-this.d)/this.normal.length()}is_point_on_plane(pt){return Math.abs(this.normal.dot(pt)-this.d)<EPSILON}project_point(pt){var dist;return dist=this.distance_to_point(pt),pt.sub(this.normal.mul_by_scalar(dist))}nearest_point_to_point(pt){return this.project_point(pt)}};plane_from_points=function(p1,p2,p3){var d,normal,v1,v2;return v1=p2.sub(p1),v2=p3.sub(p1),normal=v1.cross(v2).normalize(),d=normal.dot(p1),new Plane(normal,d)};Triangle=class{constructor(p11,p21,p31){this.p1=p11,this.p2=p21,this.p3=p31}get_verts(){return[this.p1,this.p2,this.p3]}get_normal(){var edge1,edge2,normal;return edge1=this.p2.sub(this.p1),edge2=this.p3.sub(this.p1),normal=edge1.cross(edge2),normal.normalize()}get_center(){var sum;return sum=this.p1.add(this.p2).add(this.p3),sum.mul_by_scalar(1/3)}get_barycentric(point){var dot00,dot01,dot02,dot11,dot12,inv_denom,u,v2,v0,v1,v22,w;return v0=this.p3.sub(this.p1),v1=this.p2.sub(this.p1),v22=point.sub(this.p1),dot00=v0.dot(v0),dot01=v0.dot(v1),dot02=v0.dot(v22),dot11=v1.dot(v1),dot12=v1.dot(v22),inv_denom=1/(dot00*dot11-dot01*dot01),u=(dot11*dot02-dot01*dot12)*inv_denom,v2=(dot00*dot12-dot01*dot02)*inv_denom,w=1-u-v2,{u,v:v2,w}}is_point_inside(point){var b;return b=this.get_barycentric(point),b.u>=0&&b.v>=0&&b.w>=0&&b.u<=1&&b.v<=1&&b.w<=1}to_aabb(){var max_x,max_y,max_z,min_x,min_y,min_z;return min_x=Math.min(this.p1.x,this.p2.x,this.p3.x),max_x=Math.max(this.p1.x,this.p2.x,this.p3.x),min_y=Math.min(this.p1.y,this.p2.y,this.p3.y),max_y=Math.max(this.p1.y,this.p2.y,this.p3.y),min_z=Math.min(this.p1.z,this.p2.z,this.p3.z),max_z=Math.max(this.p1.z,this.p2.z,this.p3.z),new AABB2(new Vec4(min_x,min_y,min_z,1),new Vec4(max_x,max_y,max_z,1))}};Ray=class{constructor(origin,dir1){this.origin=origin,this.dir=dir1,this.dir=this.dir.normalize()}get_origin(){return this.origin}get_dir(){return this.dir}get_point(t){return this.origin.add(this.dir.scale(t))}intersect_sphere(sphere){var a,b,c2,center,discriminant,oc,r,sqrt_d,t,t1,t2;return center=sphere.get_center(),r=sphere.get_r(),oc=this.origin.sub(center),a=this.dir.dot(this.dir),b=2*oc.dot(this.dir),c2=oc.dot(oc)-r*r,discriminant=b*b-4*a*c2,discriminant<0||(sqrt_d=Math.sqrt(discriminant),t1=(-b-sqrt_d)/(2*a),t2=(-b+sqrt_d)/(2*a),t=t1>0?t1:t2,t<=0)?null:{point:this.get_point(t),t}}intersect_aabb(aabb){var max,min,t,t_max,t_min,ty_max,ty_min,tz_max,tz_min;return min=aabb.get_min(),max=aabb.get_max(),t_min=(min.x-this.origin.x)/this.dir.x,t_max=(max.x-this.origin.x)/this.dir.x,t_min>t_max&&([t_min,t_max]=[t_max,t_min]),ty_min=(min.y-this.origin.y)/this.dir.y,ty_max=(max.y-this.origin.y)/this.dir.y,ty_min>ty_max&&([ty_min,ty_max]=[ty_max,ty_min]),t_min>ty_max||ty_min>t_max||(t_min=Math.max(t_min,ty_min),t_max=Math.min(t_max,ty_max),tz_min=(min.z-this.origin.z)/this.dir.z,tz_max=(max.z-this.origin.z)/this.dir.z,tz_min>tz_max&&([tz_min,tz_max]=[tz_max,tz_min]),t_min>tz_max||tz_min>t_max)||(t_min=Math.max(t_min,tz_min),t_max=Math.min(t_max,tz_max),t=t_min>0?t_min:t_max,t<=0)?null:{point:this.get_point(t),t}}intersect_plane(plane){var d,denom,normal,t;return normal=plane.get_normal(),d=plane.get_d(),denom=this.dir.dot(normal),Math.abs(denom)<EPSILON||(t=-(this.origin.dot(normal)+d)/denom,t<=0)?null:{point:this.get_point(t),t}}intersect_triangle(t){var a,edge1,edge2,f,h,p1,p2,p3,q,s,u,v2;return p1=t.p1,p2=t.p2,p3=t.p3,edge1=p2.sub(p1),edge2=p3.sub(p1),h=this.dir.cross(edge2),a=edge1.dot(h),a>-EPSILON&&a<EPSILON||(f=1/a,s=this.origin.sub(p1),u=f*s.dot(h),u<0||u>1)||(q=s.cross(edge1),v2=f*this.dir.dot(q),v2<0||u+v2>1)||(t=f*edge2.dot(q),t<=EPSILON)?null:{point:this.get_point(t),t,barycentric:{u,v:v2,w:1-u-v2}}}distance_to_point(p){var perp,proj,proj_length,v2;return v2=p.sub(this.origin),proj_length=v2.dot(this.dir),proj=this.dir.mul_by_scalar(proj_length),perp=v2.sub(proj),perp.length()}};Frustum=class Frustum2{constructor(planes1){this.planes=planes1}static from_matrix(m){var d,dist,normal,planes;return planes=[],d=m.data,normal=vec(d[8],d[9],d[10]),dist=d[11],planes.push(new Plane(normal.normalize(),dist/normal.length())),normal=vec(d[12]-d[8],d[13]-d[9],d[14]-d[10]),dist=d[15]-d[11],planes.push(new Plane(normal.normalize(),dist/normal.length())),normal=vec(d[12]+d[0],d[13]+d[1],d[14]+d[2]),dist=d[15]+d[3],planes.push(new Plane(normal.normalize(),dist/normal.length())),normal=vec(d[12]-d[0],d[13]-d[1],d[14]-d[2]),dist=d[15]-d[3],planes.push(new Plane(normal.normalize(),dist/normal.length())),normal=vec(d[12]-d[4],d[13]-d[5],d[14]-d[6]),dist=d[15]-d[7],planes.push(new Plane(normal.normalize(),dist/normal.length())),normal=vec(d[12]+d[4],d[13]+d[5],d[14]+d[6]),dist=d[15]+d[7],planes.push(new Plane(normal.normalize(),dist/normal.length())),new Frustum2(planes)}get_planes(){return this.planes}get_near(){return this.planes[0]}get_far(){return this.planes[1]}get_left(){return this.planes[2]}get_right(){return this.planes[3]}get_top(){return this.planes[4]}get_bottom(){return this.planes[5]}intersect_sphere(s){var center,dist,i,len,plane,r,ref;for(center=s.get_center(),r=s.get_r(),ref=this.planes,i=0,len=ref.length;i<len;i++)if(plane=ref[i],dist=plane.distance_to_point(center),dist<-r)return!1;return!0}intersect_aabb(a){var i,len,p,plane,ref;for(ref=this.planes,i=0,len=ref.length;i<len;i++)if(plane=ref[i],p=vec(plane.get_normal().x>=0?a.get_min().x:a.get_max().x,plane.get_normal().y>=0?a.get_min().y:a.get_max().y,plane.get_normal().z>=0?a.get_min().z:a.get_max().z),plane.distance_to_point(p)<0)return!1;return!0}intersect_segment(p1,p2){var d1,d2,i,intersection_point,len,plane,ref,result;for(intersection_point=null,ref=this.planes,i=0,len=ref.length;i<len;i++){if(plane=ref[i],d1=plane.distance_to_point(p1),d2=plane.distance_to_point(p2),d1<0&&d2<0)return{status:0,point:null};result=plane.intersect_segment(p1,p2),result.intersects&&intersection_point==null&&(intersection_point=result.point)}return this.is_line_inside(p1,p2)?{status:1,point:null}:{status:2,point:intersection_point}}classify_segment(p1,p2){var d1,d2,i,inside_count,len,outside_count,plane,ref;for(inside_count=0,outside_count=0,ref=this.planes,i=0,len=ref.length;i<len;i++){if(plane=ref[i],d1=plane.distance_to_point(p1),d2=plane.distance_to_point(p2),d1<0&&d2<0)return 0;d1>=0&&(inside_count+=1),d2>=0&&(inside_count+=1),(d1<0||d2<0)&&(outside_count+=1)}return inside_count===12?1:2}is_point_inside(pt){var i,len,plane,ref;for(ref=this.planes,i=0,len=ref.length;i<len;i++)if(plane=ref[i],plane.distance_to_point(pt)<0)return!1;return!0}is_segment_inside(p1,p2){var d1,d2,i,len,plane,ref;for(ref=this.planes,i=0,len=ref.length;i<len;i++)if(plane=ref[i],d1=plane.distance_to_point(p1),d2=plane.distance_to_point(p2),d1<0||d2<0)return!1;return!0}is_triangle_inside(t){var d1,d2,d3,i,len,plane,ref;for(ref=this.planes,i=0,len=ref.length;i<len;i++)if(plane=ref[i],d1=plane.distance_to_point(t.p1),d2=plane.distance_to_point(t.p2),d3=plane.distance_to_point(t.p3),d1<0||d2<0||d3<0)return!1;return!0}};segment_2d_intersect=function(p1,p2,p3,p4){var get_intersection_point,o1,o2,o3,o4,on_segment,orientation;return orientation=function(p,q,r){var val;return val=(q.y-p.y)*(r.x-q.x)-(q.x-p.x)*(r.y-q.y),val===0?0:val>0?1:-1},on_segment=function(p,q,r){return q.x<=Math.max(p.x,r.x)&&q.x>=Math.min(p.x,r.x)&&q.y<=Math.max(p.y,r.y)&&q.y>=Math.min(p.y,r.y)},o1=orientation(p1,p2,p3),o2=orientation(p1,p2,p4),o3=orientation(p3,p4,p1),o4=orientation(p3,p4,p2),get_intersection_point=function(){var denom,t,u,x,y;return denom=(p1.x-p2.x)*(p3.y-p4.y)-(p1.y-p2.y)*(p3.x-p4.x),Math.abs(denom)<EPSILON?null:(t=((p1.x-p3.x)*(p3.y-p4.y)-(p1.y-p3.y)*(p3.x-p4.x))/denom,u=-((p1.x-p2.x)*(p1.y-p3.y)-(p1.y-p2.y)*(p1.x-p3.x))/denom,t>=0&&t<=1&&u>=0&&u<=1?(x=p1.x+t*(p2.x-p1.x),y=p1.y+t*(p2.y-p1.y),vec(x,y)):null)},o1!==o2&&o3!==o4?get_intersection_point():o1===0&&on_segment(p1,p3,p2)?p3:o2===0&&on_segment(p1,p4,p2)?p4:o3===0&&on_segment(p3,p1,p4)?p1:o4===0&&on_segment(p3,p2,p4)?p2:null};polar_to_cartesian=function(r,theta){var x,y;return x=r*Math.cos(theta),y=r*Math.sin(theta),[x,y]};cartesian_to_polar=function(x,y){var r,theta;return r=Math.sqrt(x*x+y*y),theta=Math.atan2(y,x),[r,theta]};spherical_to_cartesian=function(r,theta,phi){var x,y,z;return x=r*Math.sin(phi)*Math.cos(theta),y=r*Math.cos(phi),z=r*Math.sin(phi)*Math.sin(theta),[x,y,z]};cartesian_to_spherical=function([x,y,z]){var phi,r,theta;return r=Math.sqrt(x*x+y*y+z*z),theta=Math.atan2(z,x),phi=Math.acos(y/r),[r,theta,phi]};curve_bezier=function(p0,p1,p2,p3,t){var mt,mt2,mt3,t2,t3;return t2=t*t,t3=t2*t,mt=1-t,mt2=mt*mt,mt3=mt2*mt,new Vec4(mt3*p0.x+3*mt2*t*p1.x+3*mt*t2*p2.x+t3*p3.x,mt3*p0.y+3*mt2*t*p1.y+3*mt*t2*p2.y+t3*p3.y,mt3*p0.z+3*mt2*t*p1.z+3*mt*t2*p2.z+t3*p3.z,mt3*p0.w+3*mt2*t*p1.w+3*mt*t2*p2.w+t3*p3.w)};curve_catmull_rom=function(p0,p1,p2,p3,t){var t2,t3;return t2=t*t,t3=t2*t,new Vec4(.5*((-p0.x+3*p1.x-3*p2.x+p3.x)*t3+(2*p0.x-5*p1.x+4*p2.x-p3.x)*t2+(-p0.x+p2.x)*t+2*p1.x),.5*((-p0.y+3*p1.y-3*p2.y+p3.y)*t3+(2*p0.y-5*p1.y+4*p2.y-p3.y)*t2+(-p0.y+p2.y)*t+2*p1.y),.5*((-p0.z+3*p1.z-3*p2.z+p3.z)*t3+(2*p0.z-5*p1.z+4*p2.z-p3.z)*t2+(-p0.z+p2.z)*t+2*p1.z),.5*((-p0.w+3*p1.w-3*p2.w+p3.w)*t3+(2*p0.w-5*p1.w+4*p2.w-p3.w)*t2+(-p0.w+p2.w)*t+2*p1.w))};globalThis.Sphere=Sphere2;globalThis.AABB=AABB2;globalThis.Plane=Plane;globalThis.Triangle=Triangle;globalThis.Ray=Ray;globalThis.Frustum=Frustum;globalThis.plane_from_points=plane_from_points;globalThis.segment_2d_intersect=segment_2d_intersect;globalThis.polar_to_cartesian=polar_to_cartesian;globalThis.cartesian_to_polar=cartesian_to_polar;globalThis.spherical_to_cartesian=spherical_to_cartesian;globalThis.cartesian_to_spherical=cartesian_to_spherical;globalThis.curve_bezier=curve_bezier;globalThis.curve_catmull_rom=curve_catmull_rom;var import_lib_gltf=__toESM(require_lib_gltf());})();
